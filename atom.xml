<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jingtianer</title>
  
  <subtitle>A cat coder</subtitle>
  <link href="https://jingtianer.github.io/home/atom.xml" rel="self"/>
  
  <link href="https://jingtianer.github.io/home/"/>
  <updated>2023-04-25T09:12:13.136Z</updated>
  <id>https://jingtianer.github.io/home/</id>
  
  <author>
    <name>Meow Meow Liu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>cha12.系统和进程信息</title>
    <link href="https://jingtianer.github.io/home/2023/04/24/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha12/"/>
    <id>https://jingtianer.github.io/home/2023/04/24/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha12/</id>
    <published>2023-04-24T10:05:00.000Z</published>
    <updated>2023-04-25T09:12:13.136Z</updated>
    
    <content type="html"><![CDATA[<h2 id="12-1"><a href="#12-1" class="headerlink" title="12.1"></a>12.1</h2><p>编写一个程序，以用户名作为命令行参数，列表显示该用户下所有正在运行的进程ID和命令名。（程序清单8-1中的userldFromName()函数对本题程序的编写可能会有所帮助。）通过分析系统中&#x2F;proc&#x2F;PID&#x2F;status文件的 Name:和 Uid:各行信息，可以实现此功能。遍历系统的所有&#x2F;proc&#x2F;PID目录需要使用readdir(3)函数，18.8节对其进行了描述。程序必须能够正确处理如下可能性:在确定目录存在与程序尝试打开相应&#x2F;proc&#x2F;PID&#x2F;status文件之间，&#x2F;proc&#x2F;PID目录消失了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getUid</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * user)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">ret</span> =</span> getpwnam(user);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to get uid of user &#x27;%s&#x27;\n&quot;</span>, user);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret-&gt;pw_uid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_pid_max</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *pid_max = fopen(<span class="string">&quot;/proc/sys/kernel/pid_max&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">fscanf</span>(pid_max, <span class="string">&quot;%d&quot;</span>, &amp;ret);</span><br><span class="line">    fclose(pid_max);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: fail to read /proc/sys/kernel/pid_max\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">2</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-help&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: user list [-help]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">pid_t</span> pid_max = get_pid_max();</span><br><span class="line">    <span class="type">uid_t</span> *uidlist = (<span class="type">uid_t</span> *)alloca(argc * <span class="keyword">sizeof</span>(<span class="type">uid_t</span>));</span><br><span class="line">    <span class="type">pid_t</span> **uid2pids = (<span class="type">pid_t</span> **)alloca(argc * <span class="keyword">sizeof</span>(<span class="type">pid_t</span>*));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        uidlist[i] = getUid(argv[i]);</span><br><span class="line">        uid2pids[i] = (<span class="type">pid_t</span> *)alloca((pid_max + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">pid_t</span>));</span><br><span class="line">        uid2pids[i][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DIR *proc = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(proc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to read /proc: %s\n&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">proc_rent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>((proc_rent = readdir(proc)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *spid = proc_rent-&gt;d_name;</span><br><span class="line">        <span class="type">char</span> *end;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">pid_t</span> pid = strtol(spid, &amp;end, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span>(end == spid || *end != <span class="string">&#x27;\0&#x27;</span> || errno != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;INFO: %s/%s is not a pid\n&quot;</span>, <span class="string">&quot;/proc&quot;</span>, spid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span> filename[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">sprintf</span>(filename, <span class="string">&quot;/proc/%s/status&quot;</span>, spid);</span><br><span class="line">        FILE *status = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(status == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to open %s\n&quot;</span>, filename);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">uid_t</span> realUid = <span class="number">-1</span>;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*s %u&quot;</span>, &amp;realUid); <span class="comment">//忽略前8行</span></span><br><span class="line">        <span class="keyword">if</span>(realUid == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to read Uid in %s/%s/status\n&quot;</span>, <span class="string">&quot;/proc&quot;</span>, spid);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(realUid == uidlist[i]) &#123;</span><br><span class="line">                uid2pids[i][++uid2pids[i][<span class="number">0</span>]] = pid;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---------------Process of User: %s, uid = %u---------------\n&quot;</span>, argv[i], uidlist[i]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; uid2pids[i][<span class="number">0</span>]; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\t├ %d\n&quot;</span>, uid2pids[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(uid2pids[i][<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\t(nil)\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\t└ %d\n&quot;</span>, uid2pids[i][uid2pids[i][<span class="number">0</span>]]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(proc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proc-PID目录消失"><a href="#proc-PID目录消失" class="headerlink" title="/proc/PID目录消失"></a><code>/proc/PID</code>目录消失</h3><p>我觉得不要去读<code>/proc/PID</code>目录就好了，直接读<code>/proc/PID/status</code>，不存在就返回<code>NULL</code>， 然后读取下一个pid</p><h2 id="12-2"><a href="#12-2" class="headerlink" title="12.2"></a>12.2</h2><p>实现一个pstree</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_pid_max</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *pid_max = fopen(<span class="string">&quot;/proc/sys/kernel/pid_max&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">fscanf</span>(pid_max, <span class="string">&quot;%d&quot;</span>, &amp;ret);</span><br><span class="line">    fclose(pid_max);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: fail to read /proc/sys/kernel/pid_max\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">process</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">char</span> *cmd;</span><br><span class="line">    <span class="type">pid_t</span> parent;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">children</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">sibling</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">append</span><span class="params">(<span class="type">char</span> * str, <span class="type">const</span> <span class="type">char</span> *cat)</span> &#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(str) + <span class="built_in">strlen</span>(cat) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span> *ret = <span class="built_in">malloc</span>(len*<span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    ret[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcat</span>(ret, str);</span><br><span class="line">    <span class="built_in">strcat</span>(ret, cat);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">max</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a&gt;b?a:b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prettyPrint</span><span class="params">(<span class="keyword">struct</span> process *root, <span class="type">char</span> *preffix, <span class="type">int</span> last)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * tab = last ? <span class="string">&quot;└&quot;</span> : <span class="string">&quot;├&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s│•Name=%s\n&quot;</span>, preffix, root-&gt;name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s│ pid=%d\n&quot;</span>, preffix, root-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s│ cmd=%s\n&quot;</span>, preffix, root-&gt;cmd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s│ ppid=%d\n&quot;</span>, preffix, root-&gt;parent);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s%s&quot;</span>, preffix, tab);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">process</span> *<span class="title">move</span> =</span> root-&gt;children;</span><br><span class="line">    <span class="keyword">if</span>(move != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;┬&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;─&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> suff = max(max(<span class="built_in">strlen</span>(root-&gt;name)+<span class="number">5</span>, <span class="built_in">strlen</span>(root-&gt;cmd)+<span class="number">4</span>), <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">while</span>(suff) &#123;<span class="built_in">printf</span>(<span class="string">&quot;─&quot;</span>); suff--;&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    preffix = append(preffix, (!last ? <span class="string">&quot;│&quot;</span> : <span class="string">&quot; &quot;</span>));</span><br><span class="line">    <span class="keyword">while</span>(move != <span class="literal">NULL</span> &amp;&amp; move-&gt;sibling != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prettyPrint(move, preffix, <span class="number">0</span>);</span><br><span class="line">        move = move-&gt;sibling;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move != <span class="literal">NULL</span>) prettyPrint(move, preffix, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUG</span></span><br><span class="line">    freopen(<span class="string">&quot;/dev/null&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">long</span> lim_filename = pathconf(<span class="string">&quot;/proc&quot;</span>,_PC_NAME_MAX);</span><br><span class="line">    <span class="type">long</span> lim_argmax = sysconf(_SC_ARG_MAX);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pid_max = get_pid_max();</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">process</span> **<span class="title">pidlist</span> =</span> (<span class="keyword">struct</span> process **)<span class="built_in">malloc</span>(pid_max * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> process *));</span><br><span class="line">    <span class="type">pid_t</span> *pids = (<span class="type">pid_t</span> *)<span class="built_in">malloc</span>(pid_max * <span class="keyword">sizeof</span>(<span class="type">pid_t</span>));</span><br><span class="line">    <span class="type">int</span> pidscount = <span class="number">0</span>;</span><br><span class="line">    pids[pidscount++] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(pidlist, <span class="number">0</span>, pid_max * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> process *));</span><br><span class="line">    pidlist[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> process));</span><br><span class="line">    <span class="built_in">memcpy</span>(pidlist[<span class="number">0</span>], &amp;(<span class="keyword">struct</span> process) &#123;</span><br><span class="line">        .name=<span class="literal">NULL</span>, <span class="comment">//filename ?</span></span><br><span class="line">        .cmd=<span class="literal">NULL</span>,</span><br><span class="line">        .parent=<span class="number">-1</span>,</span><br><span class="line">        .pid=<span class="number">0</span>,</span><br><span class="line">        .children=<span class="literal">NULL</span>,</span><br><span class="line">        .sibling=<span class="literal">NULL</span></span><br><span class="line">    &#125;, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> process));</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *filename = <span class="built_in">malloc</span>((<span class="number">14</span> + lim_filename+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    DIR *proc = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">proc_rent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>((proc_rent = readdir(proc)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *spid = proc_rent-&gt;d_name;</span><br><span class="line">        <span class="type">char</span> *end;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">pid_t</span> pid = strtol(spid, &amp;end, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span>(end == spid || *end != <span class="string">&#x27;\0&#x27;</span> || errno != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;INFO: %s/%s is not a pid\n&quot;</span>, <span class="string">&quot;/proc&quot;</span>, spid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if(pid == selfpid || pid == selfppid) continue;</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;INFO: current pid = %d\n&quot;</span>, pid);</span><br><span class="line">        pidlist[pid] = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> process));</span><br><span class="line">        <span class="built_in">memcpy</span>(pidlist[pid], &amp;(<span class="keyword">struct</span> process) &#123;</span><br><span class="line">            .name=<span class="built_in">malloc</span>((lim_filename+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">char</span>)), <span class="comment">//filename ?</span></span><br><span class="line">            .cmd=<span class="built_in">malloc</span>((lim_argmax+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">char</span>)),</span><br><span class="line">            .parent=<span class="number">-1</span>,</span><br><span class="line">            .pid=pid,</span><br><span class="line">            .children=<span class="literal">NULL</span>,</span><br><span class="line">            .sibling=<span class="literal">NULL</span></span><br><span class="line">        &#125;, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> process));</span><br><span class="line">        pidlist[pid]-&gt;name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        pidlist[pid]-&gt;cmd[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">sprintf</span>(filename, <span class="string">&quot;/proc/%s/status&quot;</span>, spid);</span><br><span class="line">        FILE *status = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(status == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to open %s\n&quot;</span>, filename);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">uid_t</span> realUid = <span class="number">-1</span>;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*s %s\n&quot;</span>, pidlist[pid]-&gt;name);</span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*[^\n]\n&quot;</span>); </span><br><span class="line">        <span class="built_in">fscanf</span>(status, <span class="string">&quot;%*s %d\n&quot;</span>, &amp;pidlist[pid]-&gt;parent);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(pidlist[pid]-&gt;name, <span class="string">&quot;&quot;</span>) == <span class="number">0</span> || pidlist[pid]-&gt;parent == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to read name or ppid in %s/%s/status\n&quot;</span>, <span class="string">&quot;/proc&quot;</span>, spid);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf(&quot;read /proc/%s/status, name = %s, ppid = %d\n&quot;, spid,pidlist[pid]-&gt;name, pidlist[pid]-&gt;parent);</span></span><br><span class="line">        <span class="built_in">sprintf</span>(filename, <span class="string">&quot;/proc/%s/cmdline&quot;</span>, spid);</span><br><span class="line">        FILE *cmdline = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(cmdline == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to open %s\n&quot;</span>, filename);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fscanf</span>(cmdline, <span class="string">&quot;%s&quot;</span>, pidlist[pid]-&gt;cmd);</span><br><span class="line">        <span class="comment">// printf(&quot;read cmdline = %s\n&quot;, pidlist[pid]-&gt;cmd);</span></span><br><span class="line">        fclose(cmdline); </span><br><span class="line">        fclose(status);</span><br><span class="line">        pids[pidscount++] = pid;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pid_t ppid = pidlist[pid]-&gt;parent;</span></span><br><span class="line">        <span class="comment">// pidlist[pid]-&gt;sibling = pidlist[ppid]-&gt;children;</span></span><br><span class="line">        <span class="comment">// pidlist[ppid]-&gt;children = pidlist[pid];</span></span><br><span class="line">        <span class="comment">// 不能在这里找父节点，父节点可能还没读出来。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; pidscount; i++) &#123;</span><br><span class="line">        <span class="type">pid_t</span> pid = pids[i];</span><br><span class="line">        <span class="type">pid_t</span> ppid = pidlist[pid]-&gt;parent;</span><br><span class="line">        pidlist[pid]-&gt;sibling = pidlist[ppid]-&gt;children;</span><br><span class="line">        pidlist[ppid]-&gt;children = pidlist[pid];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    closedir(proc);</span><br><span class="line">    prettyPrint(pidlist[<span class="number">1</span>], <span class="built_in">memset</span>(<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>)), <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">char</span>)), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pidscount; i++) &#123;</span><br><span class="line">        <span class="built_in">free</span>(pidlist[pids[i]]-&gt;name);</span><br><span class="line">        <span class="built_in">free</span>(pidlist[pids[i]]-&gt;cmd);</span><br><span class="line">        <span class="built_in">free</span>(pidlist[pids[i]]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(filename);</span><br><span class="line">    <span class="built_in">free</span>(pids);</span><br><span class="line">    <span class="built_in">free</span>(pidlist);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="12-3"><a href="#12-3" class="headerlink" title="12.3"></a>12.3</h2><p>编写一个程序，列表展示打开同一特定路径名文件的所有进程。可以通过分析所有&#x2F;proc&#x2F;PID&#x2F;fd&#x2F;*符号链接的内容来实现此功能。这需要利用readdir(3)函数来嵌套循环，扫描所有&#x2F;proc&#x2F;PID目录以及每个&#x2F;proc&#x2F;PID目录下所有&#x2F;proc&#x2F;PID&#x2F;fd的条目内容。读取&#x2F;proc&#x2F;PID&#x2F;fd&#x2F;n符号链接的内容，需要使用readlink(),<br>18.5节对其进行了描述。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_pid_max</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *pid_max = fopen(<span class="string">&quot;/proc/sys/kernel/pid_max&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">fscanf</span>(pid_max, <span class="string">&quot;%d&quot;</span>, &amp;ret);</span><br><span class="line">    fclose(pid_max);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error: fail to read /proc/sys/kernel/pid_max\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s filename\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUG</span></span><br><span class="line">    freopen(<span class="string">&quot;/dev/null&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pid_max = get_pid_max();</span><br><span class="line">    <span class="type">long</span> lim_argmax = sysconf(_SC_ARG_MAX);</span><br><span class="line">    <span class="type">long</span> lim_pathmax = pathconf(<span class="string">&quot;/proc&quot;</span>,_PC_PATH_MAX);</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> *pids = <span class="built_in">malloc</span>(pid_max * <span class="keyword">sizeof</span>(<span class="type">pid_t</span>));</span><br><span class="line">    <span class="type">int</span> pidscount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    DIR *proc = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(proc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to read /proc: %s\n&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">proc_rent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span> *fdname = alloca((lim_pathmax+<span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">char</span> *fdlink = alloca((lim_pathmax+<span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">char</span> *fdbuf = alloca((BUFSIZ + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">while</span>((proc_rent = readdir(proc)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *spid = proc_rent-&gt;d_name;</span><br><span class="line">        <span class="type">char</span> *end;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">pid_t</span> pid = strtol(spid, &amp;end, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span>(end == spid || *end != <span class="string">&#x27;\0&#x27;</span> || errno != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;INFO: %s/%s is not a pid\n&quot;</span>, <span class="string">&quot;/proc&quot;</span>, spid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sprintf</span>(fdname, <span class="string">&quot;/proc/%s/fd&quot;</span>, spid);</span><br><span class="line">        DIR *fd = opendir(fdname);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">fd_rent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">while</span>((fd_rent = readdir(fd)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            errno = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> filedes = strtol(fd_rent-&gt;d_name, &amp;end, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">if</span>(end == fd_rent-&gt;d_name || *end != <span class="string">&#x27;\0&#x27;</span> || errno != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;INFO: %s/%s is not a fd\n&quot;</span>, fdname, fd_rent-&gt;d_name);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">sprintf</span>(fdlink, <span class="string">&quot;%s/%s&quot;</span>, fdname, fd_rent-&gt;d_name);</span><br><span class="line">            <span class="type">ssize_t</span> readsize = readlink(fdlink, fdbuf, BUFSIZ);</span><br><span class="line">            <span class="keyword">if</span>(readsize == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: fail to read link: %s, %s\n&quot;</span>, fdlink, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            fdbuf[readsize] = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fdbuf = %s\n&quot;</span>, fdbuf);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(fdbuf, argv[<span class="number">1</span>]) == <span class="number">0</span>) &#123;</span><br><span class="line">                pids[pidscount++] = pid;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUG</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        closedir(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(proc);</span><br><span class="line">    <span class="type">char</span> *command = alloca((lim_argmax+<span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span>(pidscount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(command, <span class="string">&quot;ps -f -p&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pidscount; i++) &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(command, <span class="string">&quot;%s %d&quot;</span>, command, pids[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">char</span> *command = alloca((lim_argmax+<span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">        <span class="built_in">sprintf</span>(command, <span class="string">&quot;ps -f -p %d&quot;</span>, pid_max);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;command = %s\n&quot;</span>, command);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        system(command);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;12-1&quot;&gt;&lt;a href=&quot;#12-1&quot; class=&quot;headerlink&quot; title=&quot;12.1&quot;&gt;&lt;/a&gt;12.1&lt;/h2&gt;&lt;p&gt;编写一个程序，以用户名作为命令行参数，列表显示该用户下所有正在运行的进程ID和命令名。（程序清单8-1中的userldFromName()函数对本题程序的编写可能会有所帮助。）通过分析系统中&amp;#x2F;proc&amp;#x2F;PID&amp;#x2F;status文件的 Name:和 Uid:各行信息，可以实现此功能。遍历系统的所有&amp;#x2F;proc&amp;#x2F;PID目录需要使用readdir(3)函数，18.8节对其进行了描述。程序必须能够正确处理如下可能性:在确定目录存在与程序尝试打开相应&amp;#x2F;proc&amp;#x2F;PID&amp;#x2F;status文件之间，&amp;#x2F;proc&amp;#x2F;PID目录消失了。&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;dirent.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;pwd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;sys/types.h&amp;gt;&lt;/span&gt;   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;limits.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;getUid&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; * user)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errno = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;passwd&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;ret&lt;/span&gt; =&lt;/span&gt; getpwnam(user);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(ret == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;ERROR: fail to get uid of user &amp;#x27;%s&amp;#x27;\n&amp;quot;&lt;/span&gt;, user);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ret-&amp;gt;pw_uid;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;get_pid_max&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FILE *pid_max = fopen(&lt;span class=&quot;string&quot;&gt;&amp;quot;/proc/sys/kernel/pid_max&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;r&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; ret = &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(pid_max, &lt;span class=&quot;string&quot;&gt;&amp;quot;%d&amp;quot;&lt;/span&gt;, &amp;amp;ret);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fclose(pid_max);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(ret == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;Error: fail to read /proc/sys/kernel/pid_max\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ret;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; **argv)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(argc &amp;lt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; || &lt;span class=&quot;built_in&quot;&gt;strcmp&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;&amp;quot;-help&amp;quot;&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;Usage: user list [-help]\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt; pid_max = get_pid_max();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt; *uidlist = (&lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt; *)alloca(argc * &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt; **uid2pids = (&lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt; **)alloca(argc * &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt;*));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; argc; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uidlist[i] = getUid(argv[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uid2pids[i] = (&lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt; *)alloca((pid_max + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) * &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uid2pids[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DIR *proc = opendir(&lt;span class=&quot;string&quot;&gt;&amp;quot;/proc&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(proc == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;ERROR: fail to read /proc: %s\n&amp;quot;&lt;/span&gt;, strerror(errno));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;dirent&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;proc_rent&lt;/span&gt; =&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;((proc_rent = readdir(proc)) != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *spid = proc_rent-&amp;gt;d_name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *end;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errno = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;pid_t&lt;/span&gt; pid = strtol(spid, &amp;amp;end, &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(end == spid || *end != &lt;span class=&quot;string&quot;&gt;&amp;#x27;\0&amp;#x27;&lt;/span&gt; || errno != &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;INFO: %s/%s is not a pid\n&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;/proc&amp;quot;&lt;/span&gt;, spid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; filename[&lt;span class=&quot;number&quot;&gt;128&lt;/span&gt;] = &amp;#123;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;sprintf&lt;/span&gt;(filename, &lt;span class=&quot;string&quot;&gt;&amp;quot;/proc/%s/status&amp;quot;&lt;/span&gt;, spid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        FILE *status = fopen(filename, &lt;span class=&quot;string&quot;&gt;&amp;quot;r&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(status == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;ERROR: fail to open %s\n&amp;quot;&lt;/span&gt;, filename);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt; realUid = &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; buffer[&lt;span class=&quot;number&quot;&gt;1024&lt;/span&gt;] = &amp;#123;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*[^\n]\n&amp;quot;&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;fscanf&lt;/span&gt;(status, &lt;span class=&quot;string&quot;&gt;&amp;quot;%*s %u&amp;quot;&lt;/span&gt;, &amp;amp;realUid); &lt;span class=&quot;comment&quot;&gt;//忽略前8行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(realUid == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;fprintf&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;ERROR: fail to read Uid in %s/%s/status\n&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;/proc&amp;quot;&lt;/span&gt;, spid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; argc; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(realUid == uidlist[i]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                uid2pids[i][++uid2pids[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]] = pid;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        fclose(status);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; argc; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;---------------Process of User: %s, uid = %u---------------\n&amp;quot;&lt;/span&gt;, argv[i], uidlist[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; j = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; j &amp;lt; uid2pids[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;\t├ %d\n&amp;quot;&lt;/span&gt;, uid2pids[i][j]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(uid2pids[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;\t(nil)\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;\t└ %d\n&amp;quot;&lt;/span&gt;, uid2pids[i][uid2pids[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    closedir(proc);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;proc-PID目录消失&quot;&gt;&lt;a href=&quot;#proc-PID目录消失&quot; class=&quot;headerlink&quot; title=&quot;/proc/PID目录消失&quot;&gt;&lt;/a&gt;&lt;code&gt;/proc/PID&lt;/code&gt;目录消失&lt;/h3&gt;&lt;p&gt;我觉得不要去读&lt;code&gt;/proc/PID&lt;/code&gt;目录就好了，直接读&lt;code&gt;/proc/PID/status&lt;/code&gt;，不存在就返回&lt;code&gt;NULL&lt;/code&gt;， 然后读取下一个pid&lt;/p&gt;
&lt;h2 id=&quot;12-2&quot;&gt;&lt;a href=&quot;#12-2&quot; class=&quot;headerlink&quot; title=&quot;12.2&quot;&gt;&lt;/a&gt;12.2&lt;/h2&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>shell编程相关</title>
    <link href="https://jingtianer.github.io/home/2023/04/20/misc/shell%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/"/>
    <id>https://jingtianer.github.io/home/2023/04/20/misc/shell%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/</id>
    <published>2023-04-20T03:28:00.000Z</published>
    <updated>2023-04-20T03:23:36.762Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kill僵尸进程"><a href="#kill僵尸进程" class="headerlink" title="kill僵尸进程"></a>kill僵尸进程</h2><ul><li>强制kill掉其父进程，但是会导致shell也死掉<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep defunct | awk <span class="string">&#x27;&#123; len=split($0, a, &quot; &quot;);print a[3]; &#125;&#x27;</span> | xargs <span class="built_in">kill</span> -9</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;kill僵尸进程&quot;&gt;&lt;a href=&quot;#kill僵尸进程&quot; class=&quot;headerlink&quot; title=&quot;kill僵尸进程&quot;&gt;&lt;/a&gt;kill僵尸进程&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;强制kill掉其父进程，但是会导致shell也死掉&lt;figure class=&quot;</summary>
      
    
    
    
    <category term="misc" scheme="https://jingtianer.github.io/home/categories/misc/"/>
    
    
    <category term="shell" scheme="https://jingtianer.github.io/home/tags/shell/"/>
    
    <category term="misc" scheme="https://jingtianer.github.io/home/tags/misc/"/>
    
  </entry>
  
  <entry>
    <title>bind9crash分析</title>
    <link href="https://jingtianer.github.io/home/2023/04/19/%E7%BB%84%E4%BC%9A/bind9crash%E5%88%86%E6%9E%90/"/>
    <id>https://jingtianer.github.io/home/2023/04/19/%E7%BB%84%E4%BC%9A/bind9crash%E5%88%86%E6%9E%90/</id>
    <published>2023-04-19T04:15:37.000Z</published>
    <updated>2023-04-24T07:06:46.790Z</updated>
    
    <content type="html"><![CDATA[<h2 id="bind9-resolver模式"><a href="#bind9-resolver模式" class="headerlink" title="bind9 resolver模式"></a>bind9 resolver模式</h2><ul><li><a href="https://www.cnblogs.com/doherasyang/p/14464999.html">参考</a></li></ul><p>DNS resolver大概是指dns服务将dns请求转发给一个带有dns解析功能的路由器，路由器完成剩余部分工作然后将处理结果返回给dns服务器</p><ul><li>上周在尝试跑通fuzz.c中使用resolver模式的afl钩子，目前还没有跑通，存在两个问题<ul><li>afl变异出的测试用例必须是对域名aaaaaaa.example的一个查询，只有这样named才会将该去查询<code>master</code>dns服务器（这里需要参考<code>bind9主从配置</code>，将named的<code>aaaaaa.example</code>zone配置为从服务器）。对于afl输入的测试用例必须将其变换成一个对于aaaaaaa.example的请求</li><li>afl钩子会作为一个dns解析器将该请求进行处理，但是处理结果返回给<code>slave</code>dns服务器时，<code>slave</code>会显示无法找到soa记录，并且以<code>0</code>退出程序</li></ul></li></ul><blockquote><p>想跑通这个模式的话，需要找到一个方法，将每次afl测试用例转变成对aaaaaa.example的一个查询。</p></blockquote><h2 id="asan"><a href="#asan" class="headerlink" title="asan"></a>asan</h2><p>上次开会提到查看asan的输出来确认crash</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;__isoc99_printf&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>__isoc99_sprintf<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;__isoc99_snprintf&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>__isoc99_fprintf<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;__isoc99_vprintf&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>__isoc99_vsprintf<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;__isoc99_vsnprintf&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>__isoc99_vfprintf<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;crypt&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>crypt_r<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: failed to intercept <span class="string">&#x27;__cxa_throw&#x27;</span></span><br><span class="line"><span class="string">&#x27;==26512==AddressSanitizer: failed to intercept &#x27;</span>__cxa_rethrow_primary_exception<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&#x27;</span>==26512==AddressSanitizer: libc interceptors initialized</span><br><span class="line">|| `[0x10007fff8000, 0x7fffffffffff]` || HighMem    ||</span><br><span class="line">|| `[0x02008fff7000, 0x10007fff7fff]` || HighShadow ||</span><br><span class="line">|| `[0x00008fff7000, 0x02008fff6fff]` || ShadowGap  ||</span><br><span class="line">|| `[0x00007fff8000, 0x00008fff6fff]` || LowShadow  ||</span><br><span class="line">|| `[0x000000000000, 0x00007fff7fff]` || LowMem     ||</span><br><span class="line">MemToShadow(shadow): 0x00008fff7000 0x000091ff6dff 0x004091ff6e00 0x02008fff6fff</span><br><span class="line">redzone=16</span><br><span class="line">max_redzone=2048</span><br><span class="line">quarantine_size_mb=256M</span><br><span class="line">thread_local_quarantine_size_kb=1024K</span><br><span class="line">malloc_context_size=30</span><br><span class="line">SHADOW_SCALE: 3</span><br><span class="line">SHADOW_GRANULARITY: 8</span><br><span class="line">SHADOW_OFFSET: 0x7fff8000</span><br><span class="line">==26512==Installed the sigaction <span class="keyword">for</span> signal 11</span><br><span class="line">==26512==Installed the sigaction <span class="keyword">for</span> signal 7</span><br><span class="line">==26512==Installed the sigaction <span class="keyword">for</span> signal 8</span><br><span class="line">==26512==T0: stack [0x7fff3cc60000,0x7fff3d460000) size 0x800000; <span class="built_in">local</span>=0x7fff3d45cd78</span><br><span class="line">==26512==AddressSanitizer Init <span class="keyword">done</span></span><br><span class="line">==26512==T1: stack [0x7f85c54ff000,0x7f85c5cfed80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c5cfec88</span><br><span class="line">==26512==T2: stack [0x7f85c42ee000,0x7f85c4aedd80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c4aedc88</span><br><span class="line">==26512==T3: stack [0x7f85c3aed000,0x7f85c42ecd80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c42ecc88</span><br><span class="line">==26512==T4: stack [0x7f85c32ec000,0x7f85c3aebd80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c3aebc88</span><br><span class="line">==26512==T5: stack [0x7f85c2aeb000,0x7f85c32ead80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c32eac88</span><br><span class="line">==26512==T6: stack [0x7f85c22ea000,0x7f85c2ae9d80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c2ae9c88</span><br><span class="line">==26512==T7: stack [0x7f85c1ae9000,0x7f85c22e8d80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c22e8c88</span><br><span class="line">==26512==T8: stack [0x7f85c12e8000,0x7f85c1ae7d80) size 0x7ffd80; <span class="built_in">local</span>=0x7f85c1ae7c88</span><br></pre></td></tr></table></figure><blockquote><p>bind9挖出的crash没有什么有效信息</p></blockquote><h2 id="bind9源码阅读"><a href="#bind9源码阅读" class="headerlink" title="bind9源码阅读"></a>bind9源码阅读</h2><h3 id="loopmgr"><a href="#loopmgr" class="headerlink" title="loopmgr"></a>loopmgr</h3><ul><li>上次在gdb是发现，当运行到出错位置时，labels该小于128，设置断点到该位置，第一次运行到此处时，并没有crash。采用最原始的输出调试方法，直接运行，发现是多个线程都调用了该函数，其中某一次调用时，labels的值大于了127。</li></ul><p>named在启动时，会通过loopmgr创建包括main线程在内的n个线程，每个线程为一个loop</p><h3 id="isc-loop-t"><a href="#isc-loop-t" class="headerlink" title="isc_loop_t"></a>isc_loop_t</h3><p>loop的类型定义，其中包含与libuv交互的触发器，两个job栈，isc_job单向链表的表头</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">isc_joblist_t</span> setup_jobs;</span><br><span class="line"><span class="type">isc_joblist_t</span> teardown_jobs;</span><br></pre></td></tr></table></figure><h3 id="isc-job"><a href="#isc-job" class="headerlink" title="isc_job"></a>isc_job</h3><p>具体的任务，其中有一个回调函数，回调函数的参数，以及其他辅助的域</p><h3 id="named-server-create"><a href="#named-server-create" class="headerlink" title="named_server_create"></a>named_server_create</h3><p>调用链为<code>main-&gt;setup-&gt;named_server_create</code>，该函数用于创建服务，并对loopmgr进行初始化。</p><h3 id="libuv"><a href="#libuv" class="headerlink" title="libuv"></a>libuv</h3><p>libuv最初是为Node.js设计的，是一个事件驱动的异步io模型</p><p><a href="http://docs.libuv.org/en/v1.x/design.html"><img src="http://docs.libuv.org/en/v1.x/_images/architecture.png" alt="libuv架构"></a></p><p>libuv可以处理网络，文件等io，向其提供事件触发后的回调，libuv就可以在相应事件发生后调用该函数，方便程序对io的处理。</p><h3 id="isc-nm-udp-read-cb"><a href="#isc-nm-udp-read-cb" class="headerlink" title="isc__nm_udp_read_cb"></a>isc__nm_udp_read_cb</h3><p>我们崩溃的调用栈中的这个函数就是udp请求事件的回调。在前面的<code>named_server_create</code>中，会创建timer，timer每tick一下，就会通过interface_mgr把所有监听的协议都读一遍，其中之一就是<code>isc__nm_udp_read_cb</code></p><blockquote><p>目前猜测是多个线程同时读同一个消息，运行较快的线程把资源释放了，运行较慢的线程就读到了错误的数据。但是具体作用机理还是没弄清楚。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;bind9-resolver模式&quot;&gt;&lt;a href=&quot;#bind9-resolver模式&quot; class=&quot;headerlink&quot; title=&quot;bind9 resolver模式&quot;&gt;&lt;/a&gt;bind9 resolver模式&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/doherasyang/p/14464999.html&quot;&gt;参考&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;DNS resolver大概是指dns服务将dns请求转发给一个带有dns解析功能的路由器，路由器完成剩余部分工作然后将处理结果返回给dns服务器&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;上周在尝试跑通fuzz.c中使用resolver模式的afl钩子，目前还没有跑通，存在两个问题&lt;ul&gt;
&lt;li&gt;afl变异出的测试用例必须是对域名aaaaaaa.example的一个查询，只有这样named才会将该去查询&lt;code&gt;master&lt;/code&gt;dns服务器（这里需要参考&lt;code&gt;bind9主从配置&lt;/code&gt;，将named的&lt;code&gt;aaaaaa.example&lt;/code&gt;zone配置为从服务器）。对于afl输入的测试用例必须将其变换成一个对于aaaaaaa.example的请求&lt;/li&gt;
&lt;li&gt;afl钩子会作为一个dns解析器将该请求进行处理，但是处理结果返回给&lt;code&gt;slave&lt;/code&gt;dns服务器时，&lt;code&gt;slave&lt;/code&gt;会显示无法找到soa记录，并且以&lt;code&gt;0&lt;/code&gt;退出程序&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;想跑通这个模式的话，需要找到一个方法，将每次afl测试用例转变成对aaaaaa.example的一个查询。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;asan&quot;&gt;&lt;a href=&quot;#asan&quot; class=&quot;headerlink&quot; title=&quot;asan&quot;&gt;&lt;/a&gt;asan&lt;/h2&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>cha9.进程凭证</title>
    <link href="https://jingtianer.github.io/home/2023/04/13/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha9/"/>
    <id>https://jingtianer.github.io/home/2023/04/13/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha9/</id>
    <published>2023-04-13T10:05:00.000Z</published>
    <updated>2023-04-13T17:42:48.695Z</updated>
    
    <content type="html"><![CDATA[<h2 id="9-1"><a href="#9-1" class="headerlink" title="9.1"></a>9.1</h2><p>9-1.在下列每种情况中，假设进程用户ID的初始值分别为real(实际) &#x3D; 1000、effective(有效）&#x3D; 0、saved（保存）&#x3D; 0、file-system（文件系统）&#x3D; 0。当执行这些调用后，用户ID的状态如何?</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setuid(<span class="number">2000</span>);</span><br><span class="line">setreuid(<span class="number">-1</span>, <span class="number">2000</span>);</span><br><span class="line">seteuid(<span class="number">2000</span>);</span><br><span class="line">setfsuid(<span class="number">2000</span>);</span><br><span class="line">setresuid(<span class="number">-1</span>,<span class="number">2000</span>,<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><h3 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fsuid.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    setresuid(<span class="number">1000</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    setfsuid(<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> test = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">uid_t</span> r, e, s, fs;</span><br><span class="line">    <span class="keyword">if</span>(getresuid(&amp;r, &amp;e, &amp;s) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    fs = setfsuid(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real = %u, effective = %u, save = %u, fs = %u\n&quot;</span>, r, e, s, fs);</span><br><span class="line">    <span class="keyword">switch</span> (test) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;setuid(2000) = %d\n&quot;</span>, setuid(<span class="number">2000</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;setreuid(-1, 2000) = %d\n&quot;</span>, setreuid(<span class="number">-1</span>, <span class="number">2000</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;seteuid(2000) = %d\n&quot;</span>, seteuid(<span class="number">2000</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;setfsuid(2000) = %d\n&quot;</span>, setfsuid(<span class="number">2000</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;setresuid(-1, 2000, 3000) = %d\n&quot;</span>, setresuid(<span class="number">-1</span>, <span class="number">2000</span>, <span class="number">3000</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(getresuid(&amp;r, &amp;e, &amp;s) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    fs = setfsuid(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real = %u, effective = %u, save = %u, fs = %u\n&quot;</span>, r, e, s, fs);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li><p>登录root用户，创建用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -m tmp -u 1000 -s /bin/bash # 创建tmp，创建home，指定登录shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">passwd tmp</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">usermod -a -G sudo tmp <span class="comment"># sudo权限</span></span></span><br></pre></td></tr></table></figure></li><li><p>编译程序，设置<code>set-user-id</code>标记</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc practice9_1.c -o practice9_1</span><br><span class="line">for i in `seq 5`; do ./practice9_1 $i; done</span><br><span class="line">chmod +s practice9_1</span><br><span class="line">su tmp</span><br><span class="line">for i in `seq 5`; do ./practice9_1 $i; done</span><br></pre></td></tr></table></figure></li></ul><h3 id="恢复环境"><a href="#恢复环境" class="headerlink" title="恢复环境"></a>恢复环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userdel tmp</span><br><span class="line">rm -rf /home/tmp</span><br></pre></td></tr></table></figure><h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><ul><li>root用户&#x2F;root用户有set-user-id标志</li></ul><table><thead><tr><th>exec</th><th>real</th><th>effective</th><th>save</th><th>fs</th><th>解释</th></tr></thead><tbody><tr><td><code>setuid(2000);</code></td><td>2000</td><td>2000</td><td>2000</td><td>2000</td><td>setuid会同时修改r,e,s</td></tr><tr><td><code>setreuid(-1, 2000);</code></td><td>1000</td><td>2000</td><td>2000</td><td>2000</td><td>这里s也跟着变了，是因为满足了s改变的条件</td></tr><tr><td><code>seteuid(2000);</code></td><td>1000</td><td>2000</td><td>0</td><td>2000</td><td>fs会随着e改变，上面也是这样</td></tr><tr><td><code>setfsuid(2000);</code></td><td>1000</td><td>0</td><td>0</td><td>2000</td><td>只改变fs</td></tr><tr><td><code>setresuid(-1,2000,3000);</code></td><td>1000</td><td>2000</td><td>3000</td><td>2000</td><td>很正常</td></tr></tbody></table><h2 id="9-2"><a href="#9-2" class="headerlink" title="9.2"></a>9.2</h2><p>拥有如下用户ID的进程享有特权吗?请予解释。<br>real&#x3D;0 effective&#x3D;1000 saved&#x3D;1000 file-system&#x3D;1000</p><blockquote><p>没有，但是可以seteuid(0)，拥有权限</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/fsuid.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">checkPermission</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="type">int</span> childret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> **argv = <span class="built_in">malloc</span>(<span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">        argv[<span class="number">0</span>] = <span class="string">&quot;/usr/bin/ls&quot;</span>;</span><br><span class="line">        argv[<span class="number">1</span>] = <span class="string">&quot;/root/&quot;</span>;</span><br><span class="line">        argv[<span class="number">2</span>] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="keyword">if</span>((ret = execv(argv[<span class="number">0</span>], argv)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fail to exec ls, error: %s, ret = %d\n&quot;</span>, strerror(errno), ret);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(wait(&amp;childret) != (<span class="type">pid_t</span>)<span class="number">-1</span>) &#123;</span><br><span class="line">            childret = WEXITSTATUS(childret);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child process stop, childret = %d\n&quot;</span>, childret);</span><br><span class="line">            <span class="keyword">if</span>(childret == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;permission granted\n&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(childret == WEXITSTATUS(<span class="number">-1</span>)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;exec fail\n&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;no permission\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;wait, error: %s\n&quot;</span>, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printres</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">uid_t</span> r, e, s, fs;</span><br><span class="line">    <span class="keyword">if</span>(getresuid(&amp;r, &amp;e, &amp;s) == <span class="number">-1</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    fs = setfsuid(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real = %u, effective = %u, save = %u, fs = %u\n&quot;</span>, r, e, s, fs);</span><br><span class="line">    checkPermission();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    printres();</span><br><span class="line">    <span class="keyword">if</span>(setresuid(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">1000</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    printres();</span><br><span class="line">    <span class="keyword">if</span>(setfsuid(<span class="number">1000</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    printres();</span><br><span class="line">    <span class="keyword">if</span>(seteuid(<span class="number">0</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    printres();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>创建子进程执行<code>ls /root</code>，没有特权会返回2，执行结果为0220</p></blockquote><h2 id="9-3"><a href="#9-3" class="headerlink" title="9.3"></a>9.3</h2><p>使用setgroups()及库函数从密码文件、组文件（参见8.4节)中获取信息，以实现initgroups()。请注意，欲调用setgroups，进程必须享有特权。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFSIZE 0xffff</span></span><br><span class="line"><span class="comment">// #define BUFFSIZE 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK(x) <span class="keyword">if</span>(!(x)) &#123;fprintf(stderr, <span class="string">&quot;error: %s\n&quot;</span>, strerror(errno)); exit(errno); &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">strAllocCat</span><span class="params">(<span class="type">char</span> *str1, <span class="type">const</span> <span class="type">char</span> *str2, <span class="type">int</span> *len1, <span class="type">int</span> len2)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *ret = <span class="built_in">malloc</span>((*len1 + len2 + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">strncpy</span>(ret, str1, *len1);</span><br><span class="line">    <span class="built_in">strncpy</span>(ret + *len1, str2, len2);</span><br><span class="line">    <span class="built_in">free</span>(str1);</span><br><span class="line">    *len1 += len2;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125; <span class="comment">// 复制且分配内存，最后一位加上0，处理成c语言字符串，释放str1内存，更新字符串长度</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">readline</span><span class="params">(<span class="type">int</span> fileno, <span class="type">int</span> *readsize)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> buf[BUFFSIZE+<span class="number">1</span>];</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> *off = buf;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> eof = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *line = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int</span> lineSize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *move = off;</span><br><span class="line">    <span class="keyword">if</span>(off - buf &gt;= eof) &#123;</span><br><span class="line">        eof = read(fileno, buf, BUFFSIZE);</span><br><span class="line">        <span class="keyword">if</span>(eof == <span class="number">0</span>) &#123;</span><br><span class="line">            *readsize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CHECK(eof != <span class="number">-1</span>)</span><br><span class="line">        buf[eof] = <span class="number">0</span>;</span><br><span class="line">        off = buf;</span><br><span class="line">        move=off;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(*move &amp;&amp; *move != <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        move++;</span><br><span class="line">    &#125;</span><br><span class="line">    line = strAllocCat(line, off, &amp;lineSize, move - off);</span><br><span class="line">    off = move+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*move == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> extrasize = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> *extra = readline(fileno, &amp;extrasize);</span><br><span class="line">        line = strAllocCat(line, extra, &amp;lineSize, extrasize);</span><br><span class="line">    &#125;</span><br><span class="line">    *readsize = lineSize;</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125; <span class="comment">// 一次读一行</span></span><br><span class="line"></span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">parse_group</span><span class="params">(<span class="type">char</span> *line, <span class="type">const</span> <span class="type">char</span> *user, <span class="type">const</span> <span class="type">int</span> usersize)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *group_name = line;</span><br><span class="line">    <span class="type">char</span> *gpwd = <span class="built_in">strchr</span>(line, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    *gpwd = <span class="number">0</span>;gpwd++;</span><br><span class="line">    <span class="type">char</span> *sgid = <span class="built_in">strchr</span>(gpwd, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    *sgid = <span class="number">0</span>;sgid++;</span><br><span class="line">    <span class="type">char</span> *userlist = <span class="built_in">strchr</span>(sgid, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    *userlist = <span class="number">0</span>;userlist++;</span><br><span class="line">    <span class="comment">// 处理groups里的数据，按照冒号分隔</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strncmp</span>(userlist, user, usersize) != <span class="number">0</span>) &#123;</span><br><span class="line">        userlist = <span class="built_in">strchr</span>(userlist, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(userlist == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        userlist++;</span><br><span class="line">    &#125; <span class="comment">// 读userlist，有没有user</span></span><br><span class="line">    <span class="keyword">if</span>(userlist[usersize] != <span class="string">&#x27;,&#x27;</span> &amp;&amp; userlist[usersize] != <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// rootttt 与 root 比较的情况</span></span><br><span class="line">    <span class="keyword">return</span> atol(sgid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统调用读行</span></span><br><span class="line"><span class="type">int</span> __initgroups(<span class="type">const</span> <span class="type">char</span> *user, <span class="type">gid_t</span> group) &#123;</span><br><span class="line">    <span class="type">int</span> file_group = open(<span class="string">&quot;/etc/groups&quot;</span>, O_CREAT | O_RDWR);</span><br><span class="line">    CHECK(file_group != <span class="number">-1</span>)</span><br><span class="line">    <span class="type">int</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">gid_t</span> groups[NGROUPS_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> groupscount = <span class="number">0</span>;</span><br><span class="line">    groups[groupscount++] = group;</span><br><span class="line">    <span class="comment">// 参数group存入</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> usersize = <span class="built_in">strlen</span>(user);</span><br><span class="line">    <span class="keyword">while</span>((line = readline(file_group, &amp;size)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        write(STDOUT_FILENO, <span class="string">&quot;read line: &quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;read line: &quot;</span>));</span><br><span class="line">        write(STDOUT_FILENO, line, size);</span><br><span class="line">        write(STDOUT_FILENO, <span class="string">&quot;\n&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">gid_t</span> isid = parse_group(line, user, usersize);</span><br><span class="line">        <span class="keyword">if</span>(isid != (<span class="type">gid_t</span>)<span class="number">-1</span> &amp;&amp; isid != group) &#123;<span class="comment">// 存在且不是参数的gid，则存入</span></span><br><span class="line">            groups[groupscount++] = isid;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;gid = %u contails user %s\n&quot;</span>, isid, user);</span><br><span class="line">            <span class="keyword">if</span>(groupscount &gt; NGROUPS_MAX) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 总数超过limits</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setgroups(groupscount, groups);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sscanf读行</span></span><br><span class="line"><span class="type">int</span> ___initgroups(<span class="type">const</span> <span class="type">char</span> *user, <span class="type">gid_t</span> group) &#123;</span><br><span class="line">    FILE *file_groups = fopen(<span class="string">&quot;/etc/groups&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[BUFFSIZE+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> usersize = <span class="built_in">strlen</span>(user);</span><br><span class="line">    <span class="type">gid_t</span> groups[NGROUPS_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> groupscount = <span class="number">0</span>;</span><br><span class="line">    groups[groupscount++] = group;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">fscanf</span>(file_groups, <span class="string">&quot;%s\n&quot;</span>, line) != EOF) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, line);</span><br><span class="line">        <span class="type">gid_t</span> iuid = parse_group(line, user, usersize);</span><br><span class="line">        <span class="keyword">if</span>(iuid != (<span class="type">gid_t</span>)<span class="number">-1</span> &amp;&amp; iuid != group) &#123;</span><br><span class="line">            groups[groupscount++] = iuid;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;gid = %u contails user %s\n&quot;</span>, iuid, user);</span><br><span class="line">            <span class="keyword">if</span>(groupscount &gt; NGROUPS_MAX) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 总数超过limits</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setgroups(groupscount, groups);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统调用 getgrent setgrent endgrent</span></span><br><span class="line"><span class="type">int</span> ____initgroups(<span class="type">const</span> <span class="type">char</span> *user, <span class="type">gid_t</span> group) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">grp</span> =</span>  <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> usersize = <span class="built_in">strlen</span>(user);</span><br><span class="line">    <span class="type">gid_t</span> groups[NGROUPS_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> groupscount = <span class="number">0</span>;</span><br><span class="line">    groups[groupscount++] = group;</span><br><span class="line">    <span class="keyword">while</span>((grp = getgrent()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(*grp-&gt;gr_mem) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(user, *grp-&gt;gr_mem) == <span class="number">0</span> &amp;&amp; grp-&gt;gr_gid != group) &#123;</span><br><span class="line">                groups[groupscount++] = grp-&gt;gr_gid;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;gid = %u contails user %s\n&quot;</span>, grp-&gt;gr_gid, user);</span><br><span class="line">                <span class="keyword">if</span>(groupscount &gt; NGROUPS_MAX) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 总数超过limits</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            grp-&gt;gr_mem++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    endgrent();</span><br><span class="line">    <span class="keyword">return</span> setgroups(groupscount, groups);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    CHECK(____initgroups(getenv(<span class="string">&quot;USER&quot;</span>), getgid()) != <span class="number">-1</span>);</span><br><span class="line">    <span class="type">gid_t</span> groups[NGROUPS_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> size = getgroups(NGROUPS_MAX, groups);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">g</span> =</span> getgrgid(groups[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getgroups(%u): %s:%s:%u&quot;</span>, groups[i], g-&gt;gr_name, g-&gt;gr_passwd, g-&gt;gr_gid);</span><br><span class="line">        <span class="comment">// 读取的是 groups，这里与前面不一样正常，gid一样就好</span></span><br><span class="line">        <span class="keyword">if</span>(*g-&gt;gr_mem) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;:%s&quot;</span>, *g-&gt;gr_mem);</span><br><span class="line">            g-&gt;gr_mem++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(*g-&gt;gr_mem) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;,%s&quot;</span>, *g-&gt;gr_mem);</span><br><span class="line">            g-&gt;gr_mem++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-4"><a href="#9-4" class="headerlink" title="9.4"></a>9.4</h2><p>假设某进程的所有用户标识均为X，执行了用户D为Y的set-user-ID程序，且Y为非0值,对进程凭证的设置如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">uid_t</span> r,e,s;</span><br><span class="line">    getresuid(&amp;r, &amp;e, &amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;r = %u, e = %u, s = %u\n&quot;</span>, r, e, s);</span><br><span class="line">    seteuid(r);</span><br><span class="line">    getresuid(&amp;r, &amp;e, &amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;r = %u, e = %u, s = %u\n&quot;</span>, r, e, s);</span><br><span class="line">    seteuid(s);</span><br><span class="line">    getresuid(&amp;r, &amp;e, &amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;r = %u, e = %u, s = %u\n&quot;</span>, r, e, s);</span><br><span class="line"></span><br><span class="line">    setuid(r);</span><br><span class="line">    getresuid(&amp;r, &amp;e, &amp;s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;r = %u, e = %u, s = %u\n&quot;</span>, r, e, s);</span><br><span class="line">    <span class="keyword">return</span> setuid(<span class="number">0</span>); <span class="comment">// 希望最后一个失败，返回255(-1)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gcc practice9_4.c -o practice9_4</span><br><span class="line">sudo chown root practice9_4</span><br><span class="line">chmod u+s practice9_4</span><br><span class="line">su tmp</span><br><span class="line">./practice9_4</span><br></pre></td></tr></table></figure><h3 id="9-5"><a href="#9-5" class="headerlink" title="9.5"></a>9.5</h3><p>root最后一句成功，非root最后一句不成功</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;9-1&quot;&gt;&lt;a href=&quot;#9-1&quot; class=&quot;headerlink&quot; title=&quot;9.1&quot;&gt;&lt;/a&gt;9.1&lt;/h2&gt;&lt;p&gt;9-1.在下列每种情况中，假设进程用户ID的初始值分别为real(实际) &amp;#x3D; 1000、effective(有效）&amp;#x3D; 0、saved（保存）&amp;#x3D; 0、file-system（文件系统）&amp;#x3D; 0。当执行这些调用后，用户ID的状态如何?&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;setuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setreuid(&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;seteuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setfsuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setresuid(&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;实验代码&quot;&gt;&lt;a href=&quot;#实验代码&quot; class=&quot;headerlink&quot; title=&quot;实验代码&quot;&gt;&lt;/a&gt;实验代码&lt;/h3&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; _GNU_SOURCE&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;sys/fsuid.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *argv[])&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setresuid(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setfsuid(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; test = atoi(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;uid_t&lt;/span&gt; r, e, s, fs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(getresuid(&amp;amp;r, &amp;amp;e, &amp;amp;s) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fs = setfsuid(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;real = %u, effective = %u, save = %u, fs = %u\n&amp;quot;&lt;/span&gt;, r, e, s, fs);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (test) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;setuid(2000) = %d\n&amp;quot;&lt;/span&gt;, setuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;setreuid(-1, 2000) = %d\n&amp;quot;&lt;/span&gt;, setreuid(&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;seteuid(2000) = %d\n&amp;quot;&lt;/span&gt;, seteuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;setfsuid(2000) = %d\n&amp;quot;&lt;/span&gt;, setfsuid(&lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;setresuid(-1, 2000, 3000) = %d\n&amp;quot;&lt;/span&gt;, setresuid(&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2000&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3000&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(getresuid(&amp;amp;r, &amp;amp;e, &amp;amp;s) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fs = setfsuid(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;real = %u, effective = %u, save = %u, fs = %u\n&amp;quot;&lt;/span&gt;, r, e, s, fs);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h3&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>crash分析&amp;调用栈</title>
    <link href="https://jingtianer.github.io/home/2023/04/11/%E7%BB%84%E4%BC%9A/%E5%8D%81%E5%9B%9B%E5%91%A8crash%E5%88%86%E6%9E%90&amp;%E8%B0%83%E7%94%A8%E6%A0%88/"/>
    <id>https://jingtianer.github.io/home/2023/04/11/%E7%BB%84%E4%BC%9A/%E5%8D%81%E5%9B%9B%E5%91%A8crash%E5%88%86%E6%9E%90&amp;%E8%B0%83%E7%94%A8%E6%A0%88/</id>
    <published>2023-04-11T04:15:37.000Z</published>
    <updated>2023-04-17T03:32:11.197Z</updated>
    
    <content type="html"><![CDATA[<h2 id="挖掘情况"><a href="#挖掘情况" class="headerlink" title="挖掘情况"></a>挖掘情况</h2><table><thead><tr><th>版本</th><th>软件</th></tr></thead><tbody><tr><td>bind9_15_0</td><td>named</td></tr></tbody></table><h2 id="dns-rdata-fromwire-text的crash分析"><a href="#dns-rdata-fromwire-text的crash分析" class="headerlink" title="dns_rdata_fromwire_text的crash分析"></a>dns_rdata_fromwire_text的crash分析</h2><ul><li>这个是fuzz文件夹下挖出的crash，没什么参考价值，先用这个摸索一下分析方法</li></ul><table><thead><tr><th>版本</th><th>软件</th></tr></thead><tbody><tr><td>bind9_16_0</td><td>dns_rdata_fromwire_text</td></tr></tbody></table><h3 id="main-c的代码结构"><a href="#main-c的代码结构" class="headerlink" title="main.c的代码结构"></a>main.c的代码结构</h3><p>main.c中包含三个函数</p><ul><li>test_all_from，传入一个目录，读取目录下所有文件作为测试用例，每读取一个，调用<code>LLVMFuzzerTestOneInput</code>进行测试</li><li>main(没有启用AFL时)，将目录初始化为<code>fuzz</code>文件夹的绝对路径，调用<code>test_all_from</code></li><li>main(启用AFL时)，从<code>stdin</code>中读取一个测试用例，每读取一个，调用<code>LLVMFuzzerTestOneInput</code>进行测试</li></ul><blockquote><p>这里使用启用AFL时的main函数，猜测crashwalk也会将测试用例放到标准输入中</p></blockquote><h4 id="编译参数"><a href="#编译参数" class="headerlink" title="编译参数"></a>编译参数</h4><ul><li><p>不使用AFL，加<code>-g</code>和<code>address</code>，检测内存问题的sanitizer</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export CC=clang</span><br><span class="line">export CXX=clang++</span><br><span class="line"></span><br><span class="line">export CFLAGS=&quot;-g -fsanitize=address -fno-omit-frame-pointer -O1&quot;</span><br><span class="line">export CXXFLAGS=&quot;-g -fsanitize=address -fno-omit-frame-pointer -O1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">build <span class="keyword">for</span> gdb</span></span><br><span class="line">pushd $SUBJECT</span><br><span class="line">  make clean</span><br><span class="line">  ./configure --enable-fuzz=afl</span><br><span class="line">  make</span><br><span class="line">  pushd fuzz</span><br><span class="line">    make</span><br><span class="line">  popd</span><br><span class="line">popd</span><br></pre></td></tr></table></figure></li><li><p>由于crashwalk本质上也是gdb，crashwalk会模仿afl的输入输出方式，所以这里编译时依旧添加afl选项，将<code>AFL_LOOP</code>编译至代码中</p></li></ul><h3 id="直接运行"><a href="#直接运行" class="headerlink" title="直接运行"></a>直接运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">for dir in `ls ../out`; do</span><br><span class="line">    if [ -d &quot;../out/$dir/crashes&quot; ]; then</span><br><span class="line">        ls ../out/$dir/crashes</span><br><span class="line">        for file in `ls ../out/$dir/crashes`; do</span><br><span class="line">            echo Input = $PWD/../out/$dir/crashes/$file</span><br><span class="line">            $SUBJECT/fuzz/dns_rdata_fromwire_text &lt; $PWD/../out/$dir/crashes/$file</span><br><span class="line">        done</span><br><span class="line">    else</span><br><span class="line">        echo omit, $dir is not a directory or no crashes under $dir</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">(./gdb.sh 2&gt;&amp;1 1&gt;/dev/null) | grep Aborted -B 1 | sort | uniq # 读取标准错误流中的Abort，排序去重</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dns_rdata_fromwire_text: dns_rdata_fromwire_text.c:138: int LLVMFuzzerTestOneInput(const uint8_t *, size_t): Assertion `result == ISC_R_SUCCESS&#x27; failed.</span><br><span class="line">dns_rdata_fromwire_text: dns_rdata_fromwire_text.c:150: int LLVMFuzzerTestOneInput(const uint8_t *, size_t): Assertion `result == ISC_R_SUCCESS&#x27; failed.</span><br><span class="line">dns_rdata_fromwire_text: dns_rdata_fromwire_text.c:151: int LLVMFuzzerTestOneInput(const uint8_t *, size_t): Assertion `rdata2.length == size&#x27; failed.</span><br><span class="line">dns_rdata_fromwire_text: dns_rdata_fromwire_text.c:161: int LLVMFuzzerTestOneInput(const uint8_t *, size_t): Assertion `result == ISC_R_SUCCESS&#x27; failed.</span><br></pre></td></tr></table></figure><p>由于bind9报错的同时会答打印出出错的位置，经过排序去重，共有四处位置发送错误。这里因为是fuzz文件夹下的东西，没什么意义</p><h3 id="crashwalk"><a href="#crashwalk" class="headerlink" title="crashwalk"></a>crashwalk</h3><ul><li><p>使用crashwalk，先将所有crash读一遍</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for dir in `ls ../out`; do</span><br><span class="line">    if [ -d &quot;../out/&quot;$dir&quot;/crashes&quot; ]; then</span><br><span class="line">        echo Crashwalk, reading crashes in $dir</span><br><span class="line">        cwtriage -root $AFL_CRASHES -afl &gt; $dir.crashwalk</span><br><span class="line">    else</span><br><span class="line">        echo omit, $dir is not a directory or no crashes under $dir</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li><li><p>提取其中的Stack Head</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> *.crashwalk | grep <span class="string">&#x27;Stack Head&#x27;</span> -A 6 | <span class="built_in">tee</span> tmp.crashwalk <span class="comment"># -A 输出 grep 后6行</span></span><br><span class="line">Stack Head (6 entries):</span><br><span class="line">   __GI_raise                @ 0x00007ffff6887438: <span class="keyword">in</span> (BL)</span><br><span class="line">   __GI_abort                @ 0x00007ffff688903a: <span class="keyword">in</span> (BL)</span><br><span class="line">   __assert_fail_base        @ 0x00007ffff687fbe7: <span class="keyword">in</span> (BL)</span><br><span class="line">   __GI___assert_fail        @ 0x00007ffff687fc92: <span class="keyword">in</span> (BL)</span><br><span class="line">   LLVMFuzzerTestOneInput    @ 0x00000000005163f9: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39/bind9/fuzz/dns_rdata_fromwire_text</span><br><span class="line">   main                      @ 0x00000000005167fe: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39/bind9/fuzz/dns_rdata_fromwire_text</span><br></pre></td></tr></table></figure><ul><li>提取其中分类<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> *.crashwalk | grep <span class="string">&#x27;Classification&#x27;</span> | <span class="built_in">tee</span> classification.crashwalk <span class="comment"># -A 输出 grep 后6行</span></span><br></pre></td></tr></table></figure><blockquote><p>这里输出全是Unknown</p></blockquote></li></ul><h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><ul><li>这里asan和gdb会冲突，编译时不要用asan(后面named加asan调试没问题)</li></ul><h4 id="直接运行-1"><a href="#直接运行-1" class="headerlink" title="直接运行"></a>直接运行</h4><p>查看其函数调用栈，发现其输出与crashwalk相同，有更详细的具体代码文件，行号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#0  0x00007ffff6887438 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54</span><br><span class="line">#1  0x00007ffff688903a in __GI_abort () at abort.c:89</span><br><span class="line">#2  0x00007ffff687fbe7 in __assert_fail_base (fmt=&lt;optimized out&gt;, assertion=assertion@entry=0x90b360 &lt;.str&gt; &quot;result == ISC_R_SUCCESS&quot;, file=file@entry=0x90b2c0 &lt;.str&gt; &quot;dns_rdata_fromwire_text.c&quot;, </span><br><span class="line">    line=line@entry=138, function=function@entry=0x90b300 &lt;__PRETTY_FUNCTION__.LLVMFuzzerTestOneInput&gt; &quot;int LLVMFuzzerTestOneInput(const uint8_t *, size_t)&quot;) at assert.c:92</span><br><span class="line">#3  0x00007ffff687fc92 in __GI___assert_fail (assertion=0x90b360 &lt;.str&gt; &quot;result == ISC_R_SUCCESS&quot;, file=0x90b2c0 &lt;.str&gt; &quot;dns_rdata_fromwire_text.c&quot;, line=138, </span><br><span class="line">    function=0x90b300 &lt;__PRETTY_FUNCTION__.LLVMFuzzerTestOneInput&gt; &quot;int LLVMFuzzerTestOneInput(const uint8_t *, size_t)&quot;) at assert.c:101</span><br><span class="line">#4  0x00000000005163f9 in LLVMFuzzerTestOneInput (</span><br><span class="line">    data=0x618000000082 &quot;art_time        : 1681477147\nlast_update       : 1681477267\nfuzzer_pid        : 7592\ncycles_done       : 0\nexecs_done        : 7074\nexecs_per_sec     : 58.58\npaths_total       : 100\npaths_favored     &quot;..., size=887) at dns_rdata_fromwire_text.c:138</span><br><span class="line">#5  0x0000000000516c53 in test_all_from (dirname=0x7fffffffca80 &quot;/home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39/out&quot;) at main.c:69</span><br><span class="line">#6  0x00000000005167fe in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at main.c:109</span><br></pre></td></tr></table></figure><h4 id="查看所有调用栈"><a href="#查看所有调用栈" class="headerlink" title="查看所有调用栈"></a>查看所有调用栈</h4><p>使用非交互式执行gdb脚本，进入函数<code>dns_rdata_tofmttext</code>中查看调用栈</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> `<span class="built_in">ls</span> ../out`; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cat</span> /dev/null &gt; <span class="variable">$dir</span>.gdb</span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">&quot;../out/<span class="variable">$dir</span>/crashes&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> `<span class="built_in">ls</span> ../out/<span class="variable">$dir</span>/crashes`; <span class="keyword">do</span></span><br><span class="line">          GDBSEQ=<span class="string">&quot;break 138;r &lt; ../out/<span class="variable">$dir</span>/crashes/<span class="variable">$file</span>;bt;q&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="variable">$GDBSEQ</span> | awk <span class="string">&#x27;&#123;len=split($0,a,&quot;;&quot;);for(i=1;i&lt;=len;i++)print &quot;&quot;a[i] ;&#125;&#x27;</span> | <span class="built_in">tee</span> script.gdb</span><br><span class="line">          gdb -q --batch -x script.gdb <span class="variable">$SUBJECT</span>/fuzz/dns_rdata_fromwire_text &gt;&gt; <span class="variable">$dir</span>.gdb</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> omit, <span class="variable">$dir</span> is not a directory or no crashes under <span class="variable">$dir</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>直接运行，在return0前打一个断点，循环读取所有crash，通过gdb脚本输入到程序中，运行，如果出错，会在出错的位置打印bt，否则不输出只有一个<code>main</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGABRT, Aborted.</span><br><span class="line">0x00007ffff6fae438 <span class="keyword">in</span> __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54</span><br><span class="line"><span class="comment">#0  0x00007ffff6fae438 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54</span></span><br><span class="line"><span class="comment">#1  0x00007ffff6fb003a in __GI_abort () at abort.c:89</span></span><br><span class="line"><span class="comment">#2  0x00007ffff6fa6be7 in __assert_fail_base (fmt=&lt;optimized out&gt;, assertion=assertion@entry=0x8392f7 &quot;result == ISC_R_SUCCESS&quot;, file=file@entry=0x8392a9 &quot;dns_rdata_fromwire_text.c&quot;, line=line@entry=138, function=function@entry=0x8392c3 &quot;int LLVMFuzzerTestOneInput(const uint8_t *, size_t)&quot;) at assert.c:92</span></span><br><span class="line"><span class="comment">#3  0x00007ffff6fa6c92 in __GI___assert_fail (assertion=0x8392f7 &quot;result == ISC_R_SUCCESS&quot;, file=0x8392a9 &quot;dns_rdata_fromwire_text.c&quot;, line=138, function=0x8392c3 &quot;int LLVMFuzzerTestOneInput(const uint8_t *, size_t)&quot;) at assert.c:101</span></span><br><span class="line"><span class="comment">#4  0x0000000000423524 in LLVMFuzzerTestOneInput (data=0x7ffffffedce2 &quot;&quot;, data@entry=0x7ffffffedce0 &quot;(&quot;, size=970, size@entry=972) at dns_rdata_fromwire_text.c:138</span></span><br><span class="line"><span class="comment">#5  0x0000000000423a20 in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at main.c:136</span></span><br><span class="line">A debugging session is active.</span><br></pre></td></tr></table></figure><h2 id="named-crash分析"><a href="#named-crash分析" class="headerlink" title="named crash分析"></a>named crash分析</h2><table><thead><tr><th>版本</th><th>软件</th></tr></thead><tbody><tr><td>bind9_15_0</td><td>named</td></tr></tbody></table><h3 id="crashwalk-1"><a href="#crashwalk-1" class="headerlink" title="crashwalk"></a>crashwalk</h3><p>首先通过crashwalk，发现其三个crash分类均为可利用的<code>Classification: EXPLOITABLE</code>，调用栈都相同</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Extra Data:</span><br><span class="line">   Description: Possible stack corruption</span><br><span class="line">   Short description: PossibleStackCorruption (7/22)</span><br><span class="line">   Explanation: GDB generated an error <span class="keyword">while</span> unwinding the stack and/or the stack contained <span class="built_in">return</span> addresses that were not mapped <span class="keyword">in</span> the inferior<span class="string">&#x27;s process address space and/or the stack pointer is pointing to a location outside the default stack region. These conditions likely indicate stack corruption, which is generally considered exploitable.</span></span><br></pre></td></tr></table></figure><p>通过crashwalk分析，三个crash均会导致栈损坏，其调用栈如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Stack Head (16 entries):</span><br><span class="line">   __GI_raise                @ 0x00007ffff43a0438: <span class="keyword">in</span> (BL)</span><br><span class="line">   __GI_abort                @ 0x00007ffff43a203a: <span class="keyword">in</span> (BL)</span><br><span class="line">   __sanitizer::Abort        @ 0x00000000004f32eb: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named</span><br><span class="line">   __asan::ReserveShadowMemo @ 0x00000000004d5dd2: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named</span><br><span class="line">   __asan::InitializeShadowM @ 0x00000000004d6115: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named</span><br><span class="line">   __asan::AsanInitInternal  @ 0x00000000004d588f: <span class="keyword">in</span> /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named</span><br><span class="line">   _dl_init                  @ 0x00007ffff7de7862: <span class="keyword">in</span> /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">   _dl_start_user            @ 0x00007ffff7dd7c6a: <span class="keyword">in</span> /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">   None                      @ 0x0000000000000006: <span class="keyword">in</span> ?</span><br><span class="line">   None                      @ 0x00007fffffffdf7c: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x00007fffffffdfcc: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x00007fffffffdfcf: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x00007fffffffdfe5: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x00007fffffffdfe8: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x00007fffffffdfeb: <span class="keyword">in</span> [stack]</span><br><span class="line">   None                      @ 0x0000000000000000: <span class="keyword">in</span> ?</span><br></pre></td></tr></table></figure><p>这里调用栈的有效信息只有函数名，需要手动gdb调试一下。</p><h3 id="gdb结果"><a href="#gdb结果" class="headerlink" title="gdb结果"></a>gdb结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1  0x00007ffff43a003a in __GI_abort () at abort.c:89</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2  0x000000000053baf1 in assertion_failed (file=&lt;optimized out&gt;, line=&lt;optimized out&gt;, type=&lt;optimized out&gt;, cond=&lt;optimized out&gt;) at main.c:234</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3  0x00007ffff750a547 in isc_assertion_failed (file=0x4e57 &lt;error: Cannot access memory at address 0x4e57&gt;, line=20061, line@entry=692, type=6, type@entry=isc_assertiontype_ensure, cond=0x7ffff439e438 &lt;__GI_raise+56&gt; &quot;H=&quot;) at assertions.c:48</span></span><br><span class="line"><span class="comment">#3  0x00007ffff750a547 in isc_assertion_failed (file=0x4e69 &lt;error: Cannot access memory at address 0x4e69&gt;, line=20082, line@entry=692, type=6, type@entry=isc_assertiontype_ensure, cond=0x7ffff439e438 &lt;__GI_raise+56&gt; &quot;H=&quot;) at assertions.c:48</span></span><br><span class="line"><span class="comment">#3  0x00007ffff750a547 in isc_assertion_failed (file=0x4e7a &lt;error: Cannot access memory at address 0x4e7a&gt;, line=20110, line@entry=692, type=6, type@entry=isc_assertiontype_ensure, cond=0x7ffff439e438 &lt;__GI_raise+56&gt; &quot;H=&quot;) at assertions.c:48</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4  0x00007ffff6c8dd7c in dns_name_countlabels (name=&lt;optimized out&gt;) at name.c:692</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5  0x00007ffff671921f in query_getdb (client=0x61f00000fc80, name=0x616000020180, qtype=1, options=0, zonep=0x7fffec6e2b20, dbp=0x7fffec6e2ad0, versionp=0x7fffec6e2ad8, is_zonep=0x7fffec6e2689) at query.c:1372</span></span><br><span class="line"><span class="comment">#5  0x00007ffff671921f in query_getdb (client=0x61f00000fc80, name=0x616000020180, qtype=1, options=0, zonep=0x7fffed6e4b20, dbp=0x7fffed6e4ad0, versionp=0x7fffed6e4ad8, is_zonep=0x7fffed6e4689) at query.c:1372</span></span><br><span class="line"><span class="comment">#5  0x00007ffff671921f in query_getdb (client=0x61f000010a80, name=0x616000020180, qtype=1, options=0, zonep=0x7fffeeee7b20, dbp=0x7fffeeee7ad0, versionp=0x7fffeeee7ad8, is_zonep=0x7fffeeee7689) at query.c:1372</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#6  0x00007ffff671646d in ns__query_start (qctx=0x7fffec6e2650) at query.c:5680</span></span><br><span class="line"><span class="comment">#6  0x00007ffff671646d in ns__query_start (qctx=0x7fffed6e4650) at query.c:5680</span></span><br><span class="line"><span class="comment">#6  0x00007ffff671646d in ns__query_start (qctx=0x7fffeeee7650) at query.c:5680</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#7  0x00007ffff6729cf4 in query_setup (client=0x61f00000fc80, qtype=1) at query.c:5528</span></span><br><span class="line"><span class="comment">#7  0x00007ffff6729cf4 in query_setup (client=0x61f000010a80, qtype=1) at query.c:5528</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#8  0x00007ffff6728639 in ns_query_start (client=0x61f00000fc80, handle=0x614000010040) at query.c:12094</span></span><br><span class="line"><span class="comment">#8  0x00007ffff6728639 in ns_query_start (client=0x61f000010a80, handle=0x614000010240) at query.c:12094</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#9  0x00007ffff66f16bb in ns__client_request (handle=0x614000010040, eresult=ISC_R_SUCCESS, region=0x7fffec6e3e20, arg=0x613000001fc0) at client.c:2236</span></span><br><span class="line"><span class="comment">#9  0x00007ffff66f16bb in ns__client_request (handle=0x614000010040, eresult=ISC_R_SUCCESS, region=0x7fffed6e5e20, arg=0x613000001fc0) at client.c:2236</span></span><br><span class="line"><span class="comment">#9  0x00007ffff66f16bb in ns__client_request (handle=0x614000010240, eresult=ISC_R_SUCCESS, region=0x7fffeeee8e20, arg=0x613000001fc0) at client.c:2236</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#10 0x00007ffff74c55c0 in isc__nm_readcb_job (arg=0x61c000000080) at netmgr/netmgr.c:1883</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#11 isc__nm_readcb (sock=0x7fffec6e3de0, uvreq=&lt;optimized out&gt;, eresult=&lt;optimized out&gt;, async=&lt;optimized out&gt;) at netmgr/netmgr.c:1897</span></span><br><span class="line"><span class="comment">#11 isc__nm_readcb (sock=0x7fffed6e5de0, uvreq=&lt;optimized out&gt;, eresult=&lt;optimized out&gt;, async=&lt;optimized out&gt;) at netmgr/netmgr.c:1897</span></span><br><span class="line"><span class="comment">#11 isc__nm_readcb (sock=0x7fffeeee8de0, uvreq=&lt;optimized out&gt;, eresult=&lt;optimized out&gt;, async=&lt;optimized out&gt;) at netmgr/netmgr.c:1897</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#12 0x00007ffff750449c in isc__nm_udp_read_cb (handle=&lt;optimized out&gt;, nrecv=&lt;optimized out&gt;, buf=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, flags=&lt;optimized out&gt;) at netmgr/udp.c:592</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#13 0x00007ffff56d4ff3 in uv__udp_recvmmsg (handle=handle@entry=0x629000006910, buf=buf@entry=0x7fffeeee99a0) at src/unix/udp.c:231</span></span><br><span class="line"><span class="comment">#13 0x00007ffff56d4ff3 in uv__udp_recvmmsg (handle=handle@entry=0x6290000082a8, buf=buf@entry=0x7fffed6e69a0) at src/unix/udp.c:231</span></span><br><span class="line"><span class="comment">#13 0x00007ffff56d4ff3 in uv__udp_recvmmsg (handle=handle@entry=0x6290000093b8, buf=buf@entry=0x7fffec6e49a0) at src/unix/udp.c:231</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#14 0x00007ffff56d5f4b in uv__udp_recvmsg (handle=0x629000006910) at src/unix/udp.c:273</span></span><br><span class="line"><span class="comment">#14 0x00007ffff56d5f4b in uv__udp_recvmsg (handle=0x6290000082a8) at src/unix/udp.c:273</span></span><br><span class="line"><span class="comment">#14 0x00007ffff56d5f4b in uv__udp_recvmsg (handle=0x6290000093b8) at src/unix/udp.c:273</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#15 uv__udp_io (loop=&lt;optimized out&gt;, w=0x629000006990, revents=1) at src/unix/udp.c:178</span></span><br><span class="line"><span class="comment">#15 uv__udp_io (loop=&lt;optimized out&gt;, w=0x629000008328, revents=1) at src/unix/udp.c:178</span></span><br><span class="line"><span class="comment">#15 uv__udp_io (loop=&lt;optimized out&gt;, w=0x629000009438, revents=1) at src/unix/udp.c:178</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#16 0x00007ffff56d9a0c in uv__io_poll (loop=loop@entry=0x627000000e80, timeout=&lt;optimized out&gt;) at src/unix/epoll.c:374</span></span><br><span class="line"><span class="comment">#16 0x00007ffff56d9a0c in uv__io_poll (loop=loop@entry=0x627000002290, timeout=&lt;optimized out&gt;) at src/unix/epoll.c:374</span></span><br><span class="line"><span class="comment">#16 0x00007ffff56d9a0c in uv__io_poll (loop=loop@entry=0x627000002ff0, timeout=&lt;optimized out&gt;) at src/unix/epoll.c:374</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#17 0x00007ffff56c6bd0 in uv_run (loop=loop@entry=0x627000000e80, mode=mode@entry=UV_RUN_DEFAULT) at src/unix/core.c:406</span></span><br><span class="line"><span class="comment">#17 0x00007ffff56c6bd0 in uv_run (loop=loop@entry=0x627000002290, mode=mode@entry=UV_RUN_DEFAULT) at src/unix/core.c:406</span></span><br><span class="line"><span class="comment">#17 0x00007ffff56c6bd0 in uv_run (loop=loop@entry=0x627000002ff0, mode=mode@entry=UV_RUN_DEFAULT) at src/unix/core.c:406</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#18 0x00007ffff7563287 in loop_run (loop=0x627000000e60) at loop.c:273</span></span><br><span class="line"><span class="comment">#18 0x00007ffff7563287 in loop_run (loop=0x627000002270) at loop.c:273</span></span><br><span class="line"><span class="comment">#18 0x00007ffff7563287 in loop_run (loop=0x627000002fd0) at loop.c:273</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#19 loop_thread (arg=&lt;optimized out&gt;) at loop.c:299</span></span><br></pre></td></tr></table></figure><ul><li>找到调用栈中造成断言的位置<code>name.c:692</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">dns_name_countlabels</span><span class="params">(<span class="type">const</span> <span class="type">dns_name_t</span> *name)</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * How many labels does &#x27;name&#x27; have?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">REQUIRE(VALID_NAME(name));</span><br><span class="line"></span><br><span class="line">ENSURE(name-&gt;labels &lt;= DNS_NAME_MAXLABELS); </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (name-&gt;labels);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>出问题的位置在<code>ENSURE</code>，name的个数应该小于最大限制，gdb将该位置设置为断点并运行查看该变量的值</p></blockquote><ul><li>源码中最大label为127，但是运行时打印*name的结果为4</li></ul><pre><code class="c">#define DNS_NAME_MAXLABELS 127</code></pre><blockquote><p>暂时调试到这里，想不通这里为什么会abort，后续了解一下gdb和栈损坏相关的知识</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;挖掘情况&quot;&gt;&lt;a href=&quot;#挖掘情况&quot; class=&quot;headerlink&quot; title=&quot;挖掘情况&quot;&gt;&lt;/a&gt;挖掘情况&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;版本&lt;/th&gt;
&lt;th&gt;软件&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;bind9_15_0&lt;/td&gt;
&lt;td&gt;named&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h2 id=&quot;dns-rdata-fromwire-text的crash分析&quot;&gt;&lt;a href=&quot;#dns-rdata-fromwire-text的crash分析&quot; class=&quot;headerlink&quot; title=&quot;dns_rdata_fromwire_text的crash分析&quot;&gt;&lt;/a&gt;dns_rdata_fromwire_text的crash分析&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;这个是fuzz文件夹下挖出的crash，没什么参考价值，先用这个摸索一下分析方法&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;版本&lt;/th&gt;
&lt;th&gt;软件&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;bind9_16_0&lt;/td&gt;
&lt;td&gt;dns_rdata_fromwire_text&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h3 id=&quot;main-c的代码结构&quot;&gt;&lt;a href=&quot;#main-c的代码结构&quot; class=&quot;headerlink&quot; title=&quot;main.c的代码结构&quot;&gt;&lt;/a&gt;main.c的代码结构&lt;/h3&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>cha8.用户和组</title>
    <link href="https://jingtianer.github.io/home/2023/04/10/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha8/"/>
    <id>https://jingtianer.github.io/home/2023/04/10/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha8/</id>
    <published>2023-04-10T10:05:00.000Z</published>
    <updated>2023-04-11T01:03:49.387Z</updated>
    
    <content type="html"><![CDATA[<h2 id="8-1"><a href="#8-1" class="headerlink" title="8.1"></a>8.1</h2><p>运行下面代码，为什么输出会相同？</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> * <span class="title">p1</span> =</span> getpwnam(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> * <span class="title">p2</span> =</span> getpwnam(<span class="string">&quot;sshd&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;getpwnam(\&quot;redis\&quot;)-&gt;pw_uid = %u, getpwnam(\&quot;sshd\&quot;)-&gt;pw_uid = %u\n&quot;</span>, p1-&gt;pw_uid, p2-&gt;pw_uid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;getpwnam(\&quot;redis\&quot;) = %p, getpwnam(\&quot;sshd\&quot;) = %p\n&quot;</span>, p1, p2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>getpwnam和getpwuid返回的指针指向由静态分配的的内存，地址都是相同的，所以会导致相同。</p></blockquote><h2 id="8-2"><a href="#8-2" class="headerlink" title="8.2"></a>8.2</h2><p>用getpwent，setpwent，endpwent实现getpwnam</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> <span class="title">getpwnamRet</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *__<span class="title">getpwnam</span>(<span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">pwd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>((pwd = getpwent()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name, pwd-&gt;pw_name)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    endpwent();</span><br><span class="line">    <span class="keyword">if</span>(pwd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;getpwnamRet, pwd, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> passwd));</span><br><span class="line">        <span class="keyword">return</span> &amp;getpwnamRet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printpwd</span><span class="params">(<span class="keyword">struct</span> passwd *pwd)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(pwd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;User not Found!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login name:\t%s\n&quot;</span>, pwd-&gt;pw_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login passwd:\t%s\n&quot;</span>, pwd-&gt;pw_passwd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User uid:\t%u\n&quot;</span>, pwd-&gt;pw_uid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User gid:\t%u\n&quot;</span>, pwd-&gt;pw_gid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User info:\t%s\n&quot;</span>, pwd-&gt;pw_gecos);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Work dir:\t%s\n&quot;</span>, pwd-&gt;pw_dir);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login shell:\t%s\n&quot;</span>, pwd-&gt;pw_shell);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    printpwd(__getpwnam(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>事实上，没有必要为了定义全局变量getpwnamRet，因为getpwent的返回值本身就是静态区的</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *__<span class="title">getpwnam</span>(<span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">pwd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>((pwd = getpwent()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name, pwd-&gt;pw_name)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    endpwent();</span><br><span class="line">    <span class="keyword">return</span> pwd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printpwd</span><span class="params">(<span class="keyword">struct</span> passwd *pwd)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(pwd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;User not Found!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login name:\t%s\n&quot;</span>, pwd-&gt;pw_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login passwd:\t%s\n&quot;</span>, pwd-&gt;pw_passwd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User uid:\t%u\n&quot;</span>, pwd-&gt;pw_uid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User gid:\t%u\n&quot;</span>, pwd-&gt;pw_gid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;User info:\t%s\n&quot;</span>, pwd-&gt;pw_gecos);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Work dir:\t%s\n&quot;</span>, pwd-&gt;pw_dir);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Login shell:\t%s\n&quot;</span>, pwd-&gt;pw_shell);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">p1</span> =</span> __getpwnam(argv[<span class="number">1</span>]), *p2 = __getpwnam(argv[<span class="number">2</span>]);</span><br><span class="line">    printpwd(p1);</span><br><span class="line">    printpwd(p2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;8-1&quot;&gt;&lt;a href=&quot;#8-1&quot; class=&quot;headerlink&quot; title=&quot;8.1&quot;&gt;&lt;/a&gt;8.1&lt;/h2&gt;&lt;p&gt;运行下面代码，为什么输出会相同？&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;pwd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;passwd&lt;/span&gt; * &lt;span class=&quot;title&quot;&gt;p1&lt;/span&gt; =&lt;/span&gt; getpwnam(&lt;span class=&quot;string&quot;&gt;&amp;quot;redis&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;passwd&lt;/span&gt; * &lt;span class=&quot;title&quot;&gt;p2&lt;/span&gt; =&lt;/span&gt; getpwnam(&lt;span class=&quot;string&quot;&gt;&amp;quot;sshd&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;getpwnam(\&amp;quot;redis\&amp;quot;)-&amp;gt;pw_uid = %u, getpwnam(\&amp;quot;sshd\&amp;quot;)-&amp;gt;pw_uid = %u\n&amp;quot;&lt;/span&gt;, p1-&amp;gt;pw_uid, p2-&amp;gt;pw_uid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;getpwnam(\&amp;quot;redis\&amp;quot;) = %p, getpwnam(\&amp;quot;sshd\&amp;quot;) = %p\n&amp;quot;&lt;/span&gt;, p1, p2);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;getpwnam和getpwuid返回的指针指向由静态分配的的内存，地址都是相同的，所以会导致相同。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;8-2&quot;&gt;&lt;a href=&quot;#8-2&quot; class=&quot;headerlink&quot; title=&quot;8.2&quot;&gt;&lt;/a&gt;8.2&lt;/h2&gt;&lt;p&gt;用getpwent，setpwent，endpwent实现getpwnam&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>cha7.内存分配</title>
    <link href="https://jingtianer.github.io/home/2023/04/09/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha7/"/>
    <id>https://jingtianer.github.io/home/2023/04/09/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha7/</id>
    <published>2023-04-09T10:05:00.000Z</published>
    <updated>2023-04-10T02:50:59.844Z</updated>
    
    <content type="html"><![CDATA[<h2 id="7-1"><a href="#7-1" class="headerlink" title="7.1"></a>7.1</h2><blockquote><p>修改程序清单7-1中的程序(free_and_sbrk.c)，在每次执行malloc后打印出 program break的当前值。指定一个较小的内存分配尺寸来运行该程序。这将证明malloc不会在每次被调用时都调用sbrk()来调整program break 的位置，而是周期性地分配大块内存，并从中将小片内存返回给调用者。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 与代码7.2main相同</span></span><br></pre></td></tr></table></figure><h2 id="7-2"><a href="#7-2" class="headerlink" title="7.2"></a>7.2</h2><blockquote><p>(高级)实现 malloc()和 free()。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK(x, code, message, ...) <span class="keyword">if</span>(!(x)) &#123;fprintf(stderr, <span class="string">&quot;%s:%d, error: %s\t----\t&quot;</span>, __FILE__, __LINE__, strerror(errno)); fprintf(stderr, (const char*)message, ##__VA_ARGS__); exit(code); &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR(code, format, ...) fprintf(stderr, (const char*)format, ##__VA_ARGS__); exit(code)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNUSED 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USED 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXIT_SBRK_FAIL 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNKNOWN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNKNOWN_MEM_ERROR 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREE_TWICE 4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXALLOC 100000</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *freeMem = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">getBlockSize</span><span class="params">(<span class="type">void</span> *mem)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> <span class="type">long</span> *)mem - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setBlockSize</span><span class="params">(<span class="type">void</span> *mem, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    *((<span class="type">unsigned</span> <span class="type">long</span> *)mem - <span class="number">1</span>) = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">getNextFreeBlock</span><span class="params">(<span class="type">void</span> *__free)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>*) *((<span class="type">unsigned</span> <span class="type">long</span> *)__free + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setNextFreeBlock</span><span class="params">(<span class="type">void</span> *__free, <span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    *((<span class="type">unsigned</span> <span class="type">long</span> *)__free + <span class="number">1</span>) = (<span class="type">unsigned</span> <span class="type">long</span>)__ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">getPrevFreeBlock</span><span class="params">(<span class="type">void</span> *__free)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> *)__free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setPrevFreeBlock</span><span class="params">(<span class="type">void</span> *__free, <span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">long</span> *)__free = (<span class="type">unsigned</span> <span class="type">long</span>)__ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="title function_">getUsed</span><span class="params">(<span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setUsed</span><span class="params">(<span class="type">void</span> *__ptr, <span class="type">char</span> used)</span> &#123;</span><br><span class="line">    *((<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *)) = used;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">memInit</span><span class="params">(<span class="type">char</span> used, <span class="type">void</span> *__ptr, <span class="type">void</span> *prev, <span class="type">void</span> *next, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    setUsed(__ptr, used);</span><br><span class="line">    setBlockSize(__ptr, size);</span><br><span class="line">    setPrevFreeBlock(__ptr, prev);</span><br><span class="line">    setNextFreeBlock(__ptr, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">firstFit</span><span class="params">(<span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="type">void</span> *next = getNextFreeBlock(freeMem);</span><br><span class="line">    <span class="keyword">while</span>(next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(getBlockSize(next) &gt;= size) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        move = next;</span><br><span class="line">        next = getNextFreeBlock(next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> move;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *__malloc(<span class="type">size_t</span> size) &#123;</span><br><span class="line">    <span class="keyword">if</span>(freeMem == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        freeMem = sbrk(<span class="keyword">sizeof</span>(<span class="type">void</span> *) * <span class="number">3</span> + <span class="number">1</span>);</span><br><span class="line">        CHECK(freeMem != (<span class="type">void</span>*)<span class="number">-1</span>, EXIT_SBRK_FAIL, <span class="string">&quot;sbrk fail\n&quot;</span>);</span><br><span class="line">        freeMem += <span class="keyword">sizeof</span>(<span class="type">void</span> *) + <span class="number">1</span>;</span><br><span class="line">        memInit(UNUSED, freeMem, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="keyword">sizeof</span>(<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span> *__free = firstFit(size);</span><br><span class="line">    <span class="type">void</span> *newMem = <span class="literal">NULL</span>;</span><br><span class="line">    CHECK(__free != <span class="literal">NULL</span>, UNKNOWN_FAIL, <span class="string">&quot;unknown error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getNextFreeBlock(__free) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size = size &gt; <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *) ? size : <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        newMem = sbrk(<span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *) + size);</span><br><span class="line">        CHECK(newMem != (<span class="type">void</span>*)<span class="number">-1</span>, EXIT_SBRK_FAIL, <span class="string">&quot;sbrk fail\n&quot;</span>);</span><br><span class="line">        newMem += <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        memInit(USED, newMem, <span class="literal">NULL</span>, <span class="literal">NULL</span>, size);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newMem = getNextFreeBlock(__free);</span><br><span class="line">        setUsed(newMem, USED);</span><br><span class="line">        setNextFreeBlock(__free, getNextFreeBlock(newMem));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newMem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __free(<span class="type">void</span> * __ptr) &#123;</span><br><span class="line">    CHECK(freeMem != <span class="literal">NULL</span>, UNKNOWN_MEM_ERROR,<span class="string">&quot;memory: %p is not allocated by __mallo\n&quot;</span>, __ptr);</span><br><span class="line">    CHECK(getUsed(__ptr) == USED, FREE_TWICE, <span class="string">&quot;trying to free memory %p twice\n&quot;</span>, __ptr);</span><br><span class="line">    setUsed(__ptr, UNUSED);</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="type">void</span> *next = getNextFreeBlock(freeMem);</span><br><span class="line">    <span class="type">void</span> *front = (<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *), *back = (<span class="type">char</span> *)__ptr + getBlockSize(__ptr);</span><br><span class="line">    <span class="keyword">while</span>(next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>((<span class="type">char</span> *)next - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *) &gt;= (<span class="type">char</span> *)back) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        move = next;</span><br><span class="line">        next = getNextFreeBlock(next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(front == (<span class="type">char</span> *)move + getBlockSize(move)) &#123;</span><br><span class="line">        setBlockSize(move, (<span class="type">char</span> *)back - (<span class="type">char</span> *)move);</span><br><span class="line">        __ptr = move;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setNextFreeBlock(__ptr, getNextFreeBlock(move));</span><br><span class="line">        setNextFreeBlock(move, __ptr);</span><br><span class="line">        setPrevFreeBlock(__ptr, move);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(next == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(back == (<span class="type">char</span> *)next - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *)) &#123;</span><br><span class="line">        setBlockSize(__ptr, (<span class="type">char</span> *)next + getBlockSize(next) - (<span class="type">char</span> *)__ptr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setPrevFreeBlock(next, __ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __printMemblock(<span class="type">void</span>* ptr) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------------Memory Block %p---------------\n&quot;</span>, ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;front = %p, back = %p\n&quot;</span>, (<span class="type">char</span> *)ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *), (<span class="type">char</span> *)ptr + getBlockSize(ptr));</span><br><span class="line">    <span class="type">int</span> used = *((<span class="type">char</span> *)ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;used\t\t=\t%d\n&quot;</span>, used);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;blocksize\t=\t%lu\n&quot;</span>, *((<span class="type">unsigned</span> <span class="type">long</span> *)ptr - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span>(!used) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;last free block\t=\t%p\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> *)ptr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;next free block\t=\t%p\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>*) *((<span class="type">unsigned</span> <span class="type">long</span> *)ptr + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current brk = %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __showFreeBlocks() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;show free blocks\n&quot;</span>);</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="keyword">while</span>(move) &#123;</span><br><span class="line">        __printMemblock(move);</span><br><span class="line">        move = getNextFreeBlock(move);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        ERR(<span class="number">1</span>, <span class="string">&quot;Usage: %s numalloc blocksize [freestep] [freemin] [freemax]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> numalloc = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">size_t</span> blocksize = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">int</span> freestep = argc &gt; <span class="number">3</span> ? atoi(argv[<span class="number">3</span>]) : <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> freemin = argc &gt; <span class="number">4</span> ? atoi(argv[<span class="number">4</span>]) : <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> freemax = argc &gt; <span class="number">5</span> ? atoi(argv[<span class="number">5</span>]) : numalloc;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *ptr[MAXALLOC];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(numalloc &gt; MAXALLOC) &#123;</span><br><span class="line">        ERR(<span class="number">2</span>, <span class="string">&quot;constraint: numalloc &lt;= %d\n&quot;</span>, MAXALLOC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(void *) = %lu\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Start to allocate mem, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; numalloc; i++) &#123;</span><br><span class="line">        ptr[i] = __malloc(blocksize);</span><br><span class="line">        <span class="keyword">if</span>(ptr[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ERR(<span class="number">3</span>, <span class="string">&quot;fail to __malloc loc: %d\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; numalloc; i++) &#123;</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    __showFreeBlocks();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocation finished, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = freemin<span class="number">-1</span>; i &lt; freemax; i += freestep) &#123;</span><br><span class="line">        __free(ptr[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Mem __free finished, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = freemin<span class="number">-1</span>; i &lt; freemax; i += freestep) &#123;</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    __showFreeBlocks();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>size_t</code>和<code>unsigned long</code>以及<code>void *</code>类型转换之间还在报warning</li><li>没有字节对齐</li><li>malloc找不到合适的块时，每次都会sbrk抬升program break</li><li>只实现了first fit</li></ul><h3 id="bug-fix"><a href="#bug-fix" class="headerlink" title="bug fix"></a>bug fix</h3><ul><li>freeMem为空时先抬升program break，作为链表头节点，但是对这块内存的分配，<code>memInit(UNUSED, freeMem, NULL, NULL, 0);</code>，最后一个参数不应该是0，而应该是 <code>2 * sizeof(void *)</code>。</li></ul><h3 id="一次性分配大块内存"><a href="#一次性分配大块内存" class="headerlink" title="一次性分配大块内存"></a>一次性分配大块内存</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK(x, code, message, ...) <span class="keyword">if</span>(!(x)) &#123;fprintf(stderr, <span class="string">&quot;%s:%d, error: %s\t----\t&quot;</span>, __FILE__, __LINE__, strerror(errno)); fprintf(stderr, (const char*)message, ##__VA_ARGS__); exit(code); &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR(code, format, ...) fprintf(stderr, (const char*)format, ##__VA_ARGS__); exit(code)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNUSED 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USED 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXIT_SBRK_FAIL 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNKNOWN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNKNOWN_MEM_ERROR 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREE_TWICE 4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXALLOC 100000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE 0x010000</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *freeMem = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">getBlockSize</span><span class="params">(<span class="type">void</span> *mem)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">unsigned</span> <span class="type">long</span> *)mem - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setBlockSize</span><span class="params">(<span class="type">void</span> *mem, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    *((<span class="type">unsigned</span> <span class="type">long</span> *)mem - <span class="number">1</span>) = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">getNextFreeBlock</span><span class="params">(<span class="type">void</span> *__free)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>*) *((<span class="type">unsigned</span> <span class="type">long</span> *)__free + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setNextFreeBlock</span><span class="params">(<span class="type">void</span> *__free, <span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    *((<span class="type">unsigned</span> <span class="type">long</span> *)__free + <span class="number">1</span>) = (<span class="type">unsigned</span> <span class="type">long</span>)__ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">getPrevFreeBlock</span><span class="params">(<span class="type">void</span> *__free)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">long</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> *)__free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setPrevFreeBlock</span><span class="params">(<span class="type">void</span> *__free, <span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">long</span> *)__free = (<span class="type">unsigned</span> <span class="type">long</span>)__ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="title function_">getUsed</span><span class="params">(<span class="type">void</span> *__ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setUsed</span><span class="params">(<span class="type">void</span> *__ptr, <span class="type">char</span> used)</span> &#123;</span><br><span class="line">    *((<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *)) = used;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">memInit</span><span class="params">(<span class="type">char</span> used, <span class="type">void</span> *__ptr, <span class="type">void</span> *prev, <span class="type">void</span> *next, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    setUsed(__ptr, used);</span><br><span class="line">    setBlockSize(__ptr, size);</span><br><span class="line">    setPrevFreeBlock(__ptr, prev);</span><br><span class="line">    setNextFreeBlock(__ptr, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">firstFit</span><span class="params">(<span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="type">void</span> *next = getNextFreeBlock(freeMem);</span><br><span class="line">    <span class="keyword">while</span>(next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(getBlockSize(next) &gt;= size) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        move = next;</span><br><span class="line">        next = getNextFreeBlock(next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> move;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *__malloc(<span class="type">size_t</span> size) &#123;</span><br><span class="line">    <span class="keyword">if</span>(freeMem == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        freeMem = sbrk(PAGE);</span><br><span class="line">        CHECK(freeMem != (<span class="type">void</span>*)<span class="number">-1</span>, EXIT_SBRK_FAIL, <span class="string">&quot;sbrk fail\n&quot;</span>);</span><br><span class="line">        freeMem += <span class="keyword">sizeof</span>(<span class="type">void</span> *) + <span class="number">1</span>;</span><br><span class="line">        memInit(UNUSED, freeMem, <span class="literal">NULL</span>, freeMem + <span class="keyword">sizeof</span>(<span class="type">void</span> *) * <span class="number">3</span> + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="type">void</span> *) * <span class="number">2</span>);</span><br><span class="line">        memInit(UNUSED, freeMem + <span class="keyword">sizeof</span>(<span class="type">void</span> *) * <span class="number">3</span> + <span class="number">1</span>, freeMem, <span class="literal">NULL</span>, PAGE - (<span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *) + <span class="number">1</span> + <span class="number">3</span>*<span class="keyword">sizeof</span>(<span class="type">void</span> *)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span> *__free = firstFit(size);</span><br><span class="line">    <span class="type">void</span> *newMem = <span class="literal">NULL</span>;</span><br><span class="line">    CHECK(__free != <span class="literal">NULL</span>, UNKNOWN_FAIL, <span class="string">&quot;unknown error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getNextFreeBlock(__free) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        size = size &gt; <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *) ? size : <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        <span class="type">size_t</span> newSize = PAGE * (size / PAGE + <span class="number">1</span>) + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *) + <span class="number">1</span> + <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        newMem = sbrk(newSize); <span class="comment">// 按页分配，再加一个链表头，一个完整链表头</span></span><br><span class="line">        CHECK(newMem != (<span class="type">void</span>*)<span class="number">-1</span>, EXIT_SBRK_FAIL, <span class="string">&quot;sbrk fail\n&quot;</span>);</span><br><span class="line">        newMem += <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        memInit(USED, newMem, <span class="literal">NULL</span>, <span class="literal">NULL</span>, size);</span><br><span class="line">        <span class="type">void</span> *next_free = (<span class="type">char</span> *)newMem + size + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *);</span><br><span class="line">        setNextFreeBlock(__free, next_free);</span><br><span class="line">        memInit(UNUSED, next_free, __free, <span class="literal">NULL</span>, newSize - (size + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *) + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newMem = getNextFreeBlock(__free);</span><br><span class="line">        setUsed(newMem, USED);</span><br><span class="line">        setNextFreeBlock(__free, getNextFreeBlock(newMem));</span><br><span class="line">        <span class="keyword">if</span>(getBlockSize(newMem) &gt;= size + <span class="number">1</span> + <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="type">void</span> *)) &#123;</span><br><span class="line">            memInit(UNUSED, newMem + size + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *), __free, getNextFreeBlock(__free), getBlockSize(newMem) - size - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">            setNextFreeBlock(__free, newMem + size + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">            <span class="keyword">if</span>(getNextFreeBlock(newMem)) setPrevFreeBlock(getNextFreeBlock(newMem),  newMem + size + <span class="number">1</span> + <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">            setBlockSize(newMem, size);</span><br><span class="line">        &#125; <span class="comment">// 当前块的大小大于本次分配需要的大小，且剩余部分仍能放的的下一个完整的链表头，则将该部分再次初始化一个空闲节点，插入原双向链表中</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newMem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __free(<span class="type">void</span> * __ptr) &#123;</span><br><span class="line">    CHECK(freeMem != <span class="literal">NULL</span>, UNKNOWN_MEM_ERROR,<span class="string">&quot;memory: %p is not allocated by __mallo\n&quot;</span>, __ptr);</span><br><span class="line">    CHECK(getUsed(__ptr) == USED, FREE_TWICE, <span class="string">&quot;trying to free memory %p twice\n&quot;</span>, __ptr);</span><br><span class="line">    setUsed(__ptr, UNUSED);</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="type">void</span> *next = getNextFreeBlock(freeMem);</span><br><span class="line">    <span class="type">void</span> *front = (<span class="type">char</span> *)__ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *), *back = (<span class="type">char</span> *)__ptr + getBlockSize(__ptr);</span><br><span class="line">    <span class="keyword">while</span>(next != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>((<span class="type">char</span> *)next - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *) &gt;= (<span class="type">char</span> *)back) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        move = next;</span><br><span class="line">        next = getNextFreeBlock(next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(front == (<span class="type">char</span> *)move + getBlockSize(move) &amp;&amp; move != freeMem) &#123; <span class="comment">// move不是头节点，头节点不参与到内存分配中，不与后面的空闲内存合并</span></span><br><span class="line">        setBlockSize(move, (<span class="type">char</span> *)back - (<span class="type">char</span> *)move);</span><br><span class="line">        __ptr = move;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setNextFreeBlock(__ptr, getNextFreeBlock(move));</span><br><span class="line">        setNextFreeBlock(move, __ptr);</span><br><span class="line">        setPrevFreeBlock(__ptr, move);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(next == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(back == (<span class="type">char</span> *)next - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *)) &#123;</span><br><span class="line">        setBlockSize(__ptr, (<span class="type">char</span> *)next + getBlockSize(next) - (<span class="type">char</span> *)__ptr);</span><br><span class="line">        setNextFreeBlock(__ptr, getNextFreeBlock(next));</span><br><span class="line">        <span class="keyword">if</span>(getNextFreeBlock(next)) setPrevFreeBlock(getNextFreeBlock(next), __ptr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setPrevFreeBlock(next, __ptr);</span><br><span class="line">        setNextFreeBlock(__ptr, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __printMemblock(<span class="type">void</span>* ptr) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------------Memory Block %p---------------\n&quot;</span>, ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;front = %p, back = %p\n&quot;</span>, (<span class="type">char</span> *)ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">void</span> *), (<span class="type">char</span> *)ptr + getBlockSize(ptr));</span><br><span class="line">    <span class="type">int</span> used = *((<span class="type">char</span> *)ptr - <span class="number">1</span> - <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;used\t\t=\t%d\n&quot;</span>, used);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;blocksize\t=\t%lu\n&quot;</span>, *((<span class="type">unsigned</span> <span class="type">long</span> *)ptr - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span>(!used) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;last free block\t=\t%p\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> *)ptr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;next free block\t=\t%p\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>*) *((<span class="type">unsigned</span> <span class="type">long</span> *)ptr + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current brk = %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __showFreeBlocks() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;show free blocks\n&quot;</span>);</span><br><span class="line">    <span class="type">void</span> *move = freeMem;</span><br><span class="line">    <span class="keyword">while</span>(move) &#123;</span><br><span class="line">        __printMemblock(move);</span><br><span class="line">        move = getNextFreeBlock(move);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        ERR(<span class="number">1</span>, <span class="string">&quot;Usage: %s numalloc blocksize [freestep] [freemin] [freemax]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> numalloc = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="type">size_t</span> blocksize = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">int</span> freestep = argc &gt; <span class="number">3</span> ? atoi(argv[<span class="number">3</span>]) : <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> freemin = argc &gt; <span class="number">4</span> ? atoi(argv[<span class="number">4</span>]) : <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> freemax = argc &gt; <span class="number">5</span> ? atoi(argv[<span class="number">5</span>]) : numalloc;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *ptr[MAXALLOC];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(numalloc &gt; MAXALLOC) &#123;</span><br><span class="line">        ERR(<span class="number">2</span>, <span class="string">&quot;constraint: numalloc &lt;= %d\n&quot;</span>, MAXALLOC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(void *) = %lu\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Start to allocate mem, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; numalloc; i++) &#123;</span><br><span class="line">        ptr[i] = __malloc(blocksize);</span><br><span class="line">        <span class="keyword">if</span>(ptr[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ERR(<span class="number">3</span>, <span class="string">&quot;fail to __malloc loc: %d\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">        __showFreeBlocks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; numalloc; i++) &#123;</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    __showFreeBlocks();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocation finished, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = freemin<span class="number">-1</span>; i &lt; freemax; i += freestep) &#123;</span><br><span class="line">        __free(ptr[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">        __showFreeBlocks();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Mem __free finished, Current program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = freemin<span class="number">-1</span>; i &lt; freemax; i += freestep) &#123;</span><br><span class="line">        __printMemblock(ptr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    __showFreeBlocks();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>free时如果内存块的front和前一个块的back相同，先判断move是否为头节点，不是头节点再合并，头节点不参与内存分配</li><li>头节点为空&#x2F;找不到合适的块时，抬升<code>program break</code>，一次性分配多个page，把剩余部分作为新的空闲内存节点，加入到双向链表中</li><li>应该还有很多地方没考虑到，比如判断一个内存块是否是__malloc分配的</li><li>当freeStep为1时，最后剩余内存链表只剩两个节点，一个长度为16的头节点，和一个完整的内存块，且该内存块的back与当前<code>program break</code>相同。</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;7-1&quot;&gt;&lt;a href=&quot;#7-1&quot; class=&quot;headerlink&quot; title=&quot;7.1&quot;&gt;&lt;/a&gt;7.1&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;修改程序清单7-1中的程序(free_and_sbrk.c)，在每次执行malloc后打印出 program break的当前值。指定一个较小的内存分配尺寸来运行该程序。这将证明malloc不会在每次被调用时都调用sbrk()来调整program break 的位置，而是周期性地分配大块内存，并从中将小片内存返回给调用者。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 与代码7.2main相同&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;7-2&quot;&gt;&lt;a href=&quot;#7-2&quot; class=&quot;headerlink&quot; title=&quot;7.2&quot;&gt;&lt;/a&gt;7.2&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;(高级)实现 malloc()和 free()。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;186&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;187&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;188&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;189&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;190&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;191&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;193&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;194&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;195&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;196&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;197&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;198&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; CHECK(x, code, message, ...) &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(!(x)) &amp;#123;fprintf(stderr, &lt;span class=&quot;string&quot;&gt;&amp;quot;%s:%d, error: %s\t----\t&amp;quot;&lt;/span&gt;, __FILE__, __LINE__, strerror(errno)); fprintf(stderr, (const char*)message, ##__VA_ARGS__); exit(code); &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; ERR(code, format, ...) fprintf(stderr, (const char*)format, ##__VA_ARGS__); exit(code)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; UNUSED 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; USED 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; EXIT_SBRK_FAIL 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; UNKNOWN_FAIL 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; UNKNOWN_MEM_ERROR 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; FREE_TWICE 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; MAXALLOC 100000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *freeMem = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;getBlockSize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *mem)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)mem - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;setBlockSize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *mem, &lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; size)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)mem - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) = size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *&lt;span class=&quot;title function_&quot;&gt;getNextFreeBlock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__free)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;*) *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)__free + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;setNextFreeBlock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__free, &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__ptr)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)__free + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) = (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;)__ptr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *&lt;span class=&quot;title function_&quot;&gt;getPrevFreeBlock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__free)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;*) *(&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)__free;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;setPrevFreeBlock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__free, &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__ptr)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    *(&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)__free = (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;)__ptr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;getUsed&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__ptr)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; *((&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)__ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;setUsed&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__ptr, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; used)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    *((&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)__ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *)) = used;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;memInit&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; used, &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__ptr, &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *prev, &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *next, &lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; size)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setUsed(__ptr, used);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setBlockSize(__ptr, size);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setPrevFreeBlock(__ptr, prev);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setNextFreeBlock(__ptr, next);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *&lt;span class=&quot;title function_&quot;&gt;firstFit&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; size)&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *move = freeMem;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *next = getNextFreeBlock(freeMem);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(next != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(getBlockSize(next) &amp;gt;= size) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        move = next;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        next = getNextFreeBlock(next);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; move;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__malloc(&lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; size) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(freeMem == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        freeMem = sbrk(&lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) * &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(freeMem != (&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt;*)&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, EXIT_SBRK_FAIL, &lt;span class=&quot;string&quot;&gt;&amp;quot;sbrk fail\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        freeMem += &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        memInit(UNUSED, freeMem, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) * &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *__free = firstFit(size);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *newMem = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(__free != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, UNKNOWN_FAIL, &lt;span class=&quot;string&quot;&gt;&amp;quot;unknown error\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(getNextFreeBlock(__free) == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        size = size &amp;gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) ? size : &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; * &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        newMem = sbrk(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; + &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) + size);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(newMem != (&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt;*)&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, EXIT_SBRK_FAIL, &lt;span class=&quot;string&quot;&gt;&amp;quot;sbrk fail\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        newMem += &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; + &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        memInit(USED, newMem, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, size);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        newMem = getNextFreeBlock(__free);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setUsed(newMem, USED);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setNextFreeBlock(__free, getNextFreeBlock(newMem));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; newMem;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; __free(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; * __ptr) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(freeMem != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, UNKNOWN_MEM_ERROR,&lt;span class=&quot;string&quot;&gt;&amp;quot;memory: %p is not allocated by __mallo\n&amp;quot;&lt;/span&gt;, __ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(getUsed(__ptr) == USED, FREE_TWICE, &lt;span class=&quot;string&quot;&gt;&amp;quot;trying to free memory %p twice\n&amp;quot;&lt;/span&gt;, __ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    setUsed(__ptr, UNUSED);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *move = freeMem;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *next = getNextFreeBlock(freeMem);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *front = (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)__ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *), *back = (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)__ptr + getBlockSize(__ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(next != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;((&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)next - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *) &amp;gt;= (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)back) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        move = next;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        next = getNextFreeBlock(next);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(front == (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)move + getBlockSize(move)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setBlockSize(move, (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)back - (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)move);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __ptr = move;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setNextFreeBlock(__ptr, getNextFreeBlock(move));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setNextFreeBlock(move, __ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setPrevFreeBlock(__ptr, move);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(next == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(back == (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)next - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setBlockSize(__ptr, (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)next + getBlockSize(next) - (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)__ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        setPrevFreeBlock(next, __ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; __printMemblock(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt;* ptr) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;------------Memory Block %p---------------\n&amp;quot;&lt;/span&gt;, ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;front = %p, back = %p\n&amp;quot;&lt;/span&gt;, (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *), (&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)ptr + getBlockSize(ptr));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; used = *((&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *)ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; - &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;used\t\t=\t%d\n&amp;quot;&lt;/span&gt;, used);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;blocksize\t=\t%lu\n&amp;quot;&lt;/span&gt;, *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)ptr - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(!used) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;last free block\t=\t%p\n&amp;quot;&lt;/span&gt;, (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;*) *(&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)ptr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;next free block\t=\t%p\n&amp;quot;&lt;/span&gt;, (&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;*) *((&lt;span class=&quot;type&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; *)ptr + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Current brk = %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; __showFreeBlocks() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;show free blocks\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *move = freeMem;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(move) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __printMemblock(move);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        move = getNextFreeBlock(move);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *argv[])&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(argc &amp;lt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ERR(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;Usage: %s numalloc blocksize [freestep] [freemin] [freemax]\n&amp;quot;&lt;/span&gt;, argv[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; numalloc = atoi(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; blocksize = atoi(argv[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; freestep = argc &amp;gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; ? atoi(argv[&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]) : &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; freemin = argc &amp;gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; ? atoi(argv[&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]) : &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; freemax = argc &amp;gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt; ? atoi(argv[&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]) : numalloc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *ptr[MAXALLOC];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(numalloc &amp;gt; MAXALLOC) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ERR(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;constraint: numalloc &amp;lt;= %d\n&amp;quot;&lt;/span&gt;, MAXALLOC);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;sizeof(void *) = %lu\n&amp;quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Start to allocate mem, Current program break: %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; numalloc; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ptr[i] = __malloc(blocksize);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(ptr[i] == &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ERR(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to __malloc loc: %d\n&amp;quot;&lt;/span&gt;, i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Current program break: %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __printMemblock(ptr[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; numalloc; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __printMemblock(ptr[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    __showFreeBlocks();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Allocation finished, Current program break: %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = freemin&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;; i &amp;lt; freemax; i += freestep) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __free(ptr[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Current program break: %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __printMemblock(ptr[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Mem __free finished, Current program break: %p\n&amp;quot;&lt;/span&gt;, sbrk(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = freemin&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;; i &amp;lt; freemax; i += freestep) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        __printMemblock(ptr[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    __showFreeBlocks();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>十三周记录</title>
    <link href="https://jingtianer.github.io/home/2023/04/08/%E7%BB%84%E4%BC%9A/%E5%8D%81%E4%B8%89%E5%91%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://jingtianer.github.io/home/2023/04/08/%E7%BB%84%E4%BC%9A/%E5%8D%81%E4%B8%89%E5%91%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2023-04-08T04:15:37.000Z</published>
    <updated>2023-04-08T08:32:01.638Z</updated>
    
    <content type="html"><![CDATA[<h2 id="完成aflgo修改的剩余部分"><a href="#完成aflgo修改的剩余部分" class="headerlink" title="完成aflgo修改的剩余部分"></a>完成aflgo修改的剩余部分</h2><ul><li>分别完成并实现了另外两种效果的Holder</li><li>在runOnModule中完成相关逻辑</li><li>使用bind9和dnsmasq编译测试了他的效果，可以挖出crash</li></ul><h2 id="完成dnsmasq的钩子编写"><a href="#完成dnsmasq的钩子编写" class="headerlink" title="完成dnsmasq的钩子编写"></a>完成dnsmasq的钩子编写</h2><ul><li>dnsmasq并没有像bind一样提供一个<code>fuzz.c</code>，需要自己编写，编写的逻辑与bind9相似</li><li>创建线程读取输入+socket向自身发送数据+适当时机回调</li></ul><h3 id="fuzz-c"><a href="#fuzz-c" class="headerlink" title="fuzz.c"></a>fuzz.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fuzz.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENABLE_AFL</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 65536</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false 0</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_cond_t</span> cond;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> ready;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">work_thread</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// freopen (&quot;logmasq&quot;, &quot;w&quot;, stderr);</span></span><br><span class="line">    INFO(<span class="string">&quot;fuzz thread startup successfully\n&quot;</span>);</span><br><span class="line">    <span class="type">char</span> *host;</span><br><span class="line">    <span class="type">char</span> *port;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">    <span class="type">int</span> sockfd;</span><br><span class="line">    <span class="type">void</span> *buf;</span><br><span class="line">    <span class="type">int</span> inputfd;</span><br><span class="line">    <span class="type">int</span> loop = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    host = getenv(<span class="string">&quot;FUZZ_SERVER_CONFIG&quot;</span>);</span><br><span class="line">    CHECK(host != <span class="literal">NULL</span>, <span class="string">&quot;FUZZ_SERVER_CONFIG is not defined\n&quot;</span>);</span><br><span class="line">    host = strdup(host);</span><br><span class="line">    CHECK(host != <span class="literal">NULL</span>, <span class="string">&quot;host is null\n&quot;</span>);</span><br><span class="line">    port = <span class="built_in">strchr</span>(host, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    CHECK(port != <span class="literal">NULL</span>, <span class="string">&quot;port is null\n&quot;</span>);</span><br><span class="line">    *port = <span class="number">0</span>;</span><br><span class="line">    port++;</span><br><span class="line">    INFO(<span class="string">&quot;port = %s, addr = %s\n&quot;</span>, port, host);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    CHECK(inet_pton(AF_INET, host, &amp;servaddr.sin_addr) == <span class="number">1</span>, <span class="string">&quot;invalid port\n&quot;</span>);</span><br><span class="line">    servaddr.sin_port = htons(atoi(port));</span><br><span class="line"></span><br><span class="line">    sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    CHECK(sockfd != <span class="number">-1</span>, <span class="string">&quot;socket creation failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buf = <span class="built_in">malloc</span>(BUF_SIZE);</span><br><span class="line">    CHECK(buf != <span class="literal">NULL</span>, <span class="string">&quot;memory allocation failed\n&quot;</span>);</span><br><span class="line">    <span class="type">char</span> *inputfile = getenv(<span class="string">&quot;FUZZ_INPUT_FILE&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (inputfile)</span><br><span class="line">    &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        inputfd = open(inputfile, O_RDONLY);</span><br><span class="line">        CHECK(inputfd != <span class="number">-1</span>, <span class="string">&quot;fail to open input file\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        inputfd = open(<span class="string">&quot;/dev/fd/0&quot;</span>, O_RDONLY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(host);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __AFL_LOOP</span></span><br><span class="line">    <span class="keyword">while</span> (__AFL_LOOP(<span class="number">1000</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        INFO(<span class="string">&quot;__AFL_LOOP(%d)\n&quot;</span>, loop);</span><br><span class="line">        loop++;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        INFO(<span class="string">&quot;NO AFL_LOOP\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ifdef __AFL_LOOP */</span></span></span><br><span class="line">        <span class="type">size_t</span> length;</span><br><span class="line">        <span class="type">size_t</span> sendsize;</span><br><span class="line"></span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        length = read(inputfd, buf, BUF_SIZE);</span><br><span class="line">        CHECK(length != <span class="number">-1</span>, <span class="string">&quot;fail to read input file\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __AFL_LOOP</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="keyword">goto</span> next;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* ifdef __AFL_LOOP */</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        INFO(<span class="string">&quot;read from input = %s\n&quot;</span>, buf);</span><br><span class="line">        CHECK(pthread_mutex_lock(&amp;mutex) == <span class="number">0</span>, <span class="string">&quot;fail to get mutex\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ready = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        length = sendto(sockfd, buf, length, <span class="number">0</span>,</span><br><span class="line">                        (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">        CHECK(length == length, <span class="string">&quot;fail to send\n&quot;</span>);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">        (<span class="type">void</span>)recvfrom(sockfd, buf, <span class="number">65536</span>, MSG_DONTWAIT,</span><br><span class="line">                       (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">        INFO(<span class="string">&quot;before wait, recv = %s\n&quot;</span>, buf);</span><br><span class="line">        <span class="keyword">while</span> (!ready)</span><br><span class="line">        &#123;</span><br><span class="line">            pthread_cond_wait(&amp;cond, &amp;mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        INFO(<span class="string">&quot;after wait\n&quot;</span>);</span><br><span class="line">        CHECK(pthread_mutex_unlock(&amp;mutex) == <span class="number">0</span>, <span class="string">&quot;fail to unlock mutex\n&quot;</span>);</span><br><span class="line">    next:;</span><br><span class="line">    &#125;</span><br><span class="line">    INFO(<span class="string">&quot;finish afl, exit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    close(sockfd);</span><br><span class="line">    fclose(<span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fuzz_notify</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    INFO(<span class="string">&quot;fuzz notify\n&quot;</span>);</span><br><span class="line">    CHECK(pthread_mutex_lock(&amp;mutex) == <span class="number">0</span>, <span class="string">&quot;notify fail to get mutex\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ready = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    CHECK(pthread_cond_signal(&amp;cond) == <span class="number">0</span>, <span class="string">&quot;notify fail to signal work thread\n&quot;</span>);</span><br><span class="line">    CHECK(pthread_mutex_unlock(&amp;mutex) == <span class="number">0</span>, <span class="string">&quot;notify fail to unlock mutex\n&quot;</span>);</span><br><span class="line">    INFO(<span class="string">&quot;fuzz notify end, ready = %d\n&quot;</span>, ready);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> <span class="title function_">fuzz_setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> thread;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">&quot;AFL_PERSISTENT&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        CHECK(pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>) == <span class="number">0</span>, <span class="string">&quot;fail to init mutex\n&quot;</span>);</span><br><span class="line">        CHECK(pthread_cond_init(&amp;cond, <span class="literal">NULL</span>) == <span class="number">0</span>, <span class="string">&quot;fail to init cond\n&quot;</span>);</span><br><span class="line">        CHECK(pthread_create(&amp;thread, <span class="literal">NULL</span>, work_thread, <span class="literal">NULL</span>) == <span class="number">0</span>, <span class="string">&quot;fail to create work thread\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="dnsmasq-c"><a href="#dnsmasq-c" class="headerlink" title="dnsmasq.c"></a>dnsmasq.c</h3><blockquote><p>dnsmasq的main函数在这里，大致看了dnsmasq的代码，main函数做了参数解析和listener的初始化。退出的话应该都是直接<code>exit(code)/_exit(code)</code></p></blockquote><blockquote><p>由此知道可以直接在main函数中启动线程，待线程将所有输入测试用例读取+发送+callback，就可以直接在线程中<code>exit(0)</code></p></blockquote><ul><li>在main函数中有一个死循环，其中有一个check_dns_listeners<ul><li>对于tcp，这个函数实现了对所有listener调用accept，接收连接请求</li><li>对于udp，这个函数调用了reply_query，这个函数里分别用recvfrom和sendto接收请求并发送回复</li></ul></li></ul><blockquote><p>所以notify函数在check_dns_listeners执行完成后调用即可</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    check_dns_listeners(&amp;rset, now); <span class="comment">//这里有accept</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENABLE_AFL</span></span><br><span class="line">    fuzz_notify();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>大致看了aflnet的代码，他做的确实是在afl的基础上添加了很多网络相关的内容<ul><li>根据所选协议构造对应格式的数据包</li><li>根据协议与服务端建立连接</li><li>数据包收发</li></ul></li><li>暂时没有找到aflnet如何判断server是否完成了数据的请求，在实际使用中发现<ul><li>aflgo+编写钩子<ul><li>执行速度较快(500-1k&#x2F;s)，对dnsmasq相同版本挖掘，aflgo只要20分钟就出crash了</li><li>由于频繁的线程挂起和恢复，稳定性较差(&lt; 10 %)。对于每个需要测试的服务器，都要阅读其源码，找到适当的线程启动，回调时机。</li></ul></li><li>aflnet<ul><li>相对稳定(&gt; 60 %)，不需要阅读源码，手写钩子</li><li>执行速度较慢(8&#x2F;s)，且非导向型挖掘</li></ul></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;完成aflgo修改的剩余部分&quot;&gt;&lt;a href=&quot;#完成aflgo修改的剩余部分&quot; class=&quot;headerlink&quot; title=&quot;完成aflgo修改的剩余部分&quot;&gt;&lt;/a&gt;完成aflgo修改的剩余部分&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;分别完成并实现了另外两种效果的Holder&lt;/li&gt;
&lt;li&gt;在runOnModule中完成相关逻辑&lt;/li&gt;
&lt;li&gt;使用bind9和dnsmasq编译测试了他的效果，可以挖出crash&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;完成dnsmasq的钩子编写&quot;&gt;&lt;a href=&quot;#完成dnsmasq的钩子编写&quot; class=&quot;headerlink&quot; title=&quot;完成dnsmasq的钩子编写&quot;&gt;&lt;/a&gt;完成dnsmasq的钩子编写&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;dnsmasq并没有像bind一样提供一个&lt;code&gt;fuzz.c&lt;/code&gt;，需要自己编写，编写的逻辑与bind9相似&lt;/li&gt;
&lt;li&gt;创建线程读取输入+socket向自身发送数据+适当时机回调&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;fuzz-c&quot;&gt;&lt;a href=&quot;#fuzz-c&quot; class=&quot;headerlink&quot; title=&quot;fuzz.c&quot;&gt;&lt;/a&gt;fuzz.c&lt;/h3&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;fuzz.h&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; ENABLE_AFL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;pthread.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;signal.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;fcntl.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;pthread.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;sys/socket.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;lt;netinet/in.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; BUF_SIZE 65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; bool char&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; true 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; false 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;pthread_cond_t&lt;/span&gt; cond;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;pthread_mutex_t&lt;/span&gt; mutex;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; ready;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *&lt;span class=&quot;title function_&quot;&gt;work_thread&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// freopen (&amp;quot;logmasq&amp;quot;, &amp;quot;w&amp;quot;, stderr);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;fuzz thread startup successfully\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *host;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *port;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sockaddr_in&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;servaddr&lt;/span&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; sockfd;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; *buf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; inputfd;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; loop = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    host = getenv(&lt;span class=&quot;string&quot;&gt;&amp;quot;FUZZ_SERVER_CONFIG&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(host != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;FUZZ_SERVER_CONFIG is not defined\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    host = strdup(host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(host != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;host is null\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    port = &lt;span class=&quot;built_in&quot;&gt;strchr&lt;/span&gt;(host, &lt;span class=&quot;string&quot;&gt;&amp;#x27;:&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(port != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;port is null\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    *port = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    port++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;port = %s, addr = %s\n&amp;quot;&lt;/span&gt;, port, host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;memset&lt;/span&gt;(&amp;amp;servaddr, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(servaddr));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    servaddr.sin_family = AF_INET;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(inet_pton(AF_INET, host, &amp;amp;servaddr.sin_addr) == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;invalid port\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    servaddr.sin_port = htons(atoi(port));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sockfd = socket(AF_INET, SOCK_DGRAM, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(sockfd != &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;socket creation failed\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    buf = &lt;span class=&quot;built_in&quot;&gt;malloc&lt;/span&gt;(BUF_SIZE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(buf != &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;memory allocation failed\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; *inputfile = getenv(&lt;span class=&quot;string&quot;&gt;&amp;quot;FUZZ_INPUT_FILE&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (inputfile)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errno = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        inputfd = open(inputfile, O_RDONLY);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(inputfd != &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to open input file\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        inputfd = open(&lt;span class=&quot;string&quot;&gt;&amp;quot;/dev/fd/0&amp;quot;&lt;/span&gt;, O_RDONLY);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;free&lt;/span&gt;(host);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; __AFL_LOOP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (__AFL_LOOP(&lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;__AFL_LOOP(%d)\n&amp;quot;&lt;/span&gt;, loop);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        loop++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;NO AFL_LOOP\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/* ifdef __AFL_LOOP */&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;size_t&lt;/span&gt; sendsize;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        errno = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        length = read(inputfd, buf, BUF_SIZE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(length != &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to read input file\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (length == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; __AFL_LOOP&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;goto&lt;/span&gt; next;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/* ifdef __AFL_LOOP */&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;read from input = %s\n&amp;quot;&lt;/span&gt;, buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(pthread_mutex_lock(&amp;amp;mutex) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to get mutex\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ready = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        length = sendto(sockfd, buf, length, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; sockaddr *)&amp;amp;servaddr, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(servaddr));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(length == length, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to send\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;memset&lt;/span&gt;(buf, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, BUF_SIZE);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt;)recvfrom(sockfd, buf, &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;, MSG_DONTWAIT,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       (&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; sockaddr *)&amp;amp;servaddr, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(servaddr));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;before wait, recv = %s\n&amp;quot;&lt;/span&gt;, buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (!ready)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pthread_cond_wait(&amp;amp;cond, &amp;amp;mutex);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;after wait\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(pthread_mutex_unlock(&amp;amp;mutex) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to unlock mutex\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    next:;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;finish afl, exit\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;free&lt;/span&gt;(buf);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    close(sockfd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fclose(&lt;span class=&quot;built_in&quot;&gt;stderr&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;fuzz_notify&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;fuzz notify\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(pthread_mutex_lock(&amp;amp;mutex) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;notify fail to get mutex\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ready = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(pthread_cond_signal(&amp;amp;cond) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;notify fail to signal work thread\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CHECK(pthread_mutex_unlock(&amp;amp;mutex) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;notify fail to unlock mutex\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    INFO(&lt;span class=&quot;string&quot;&gt;&amp;quot;fuzz notify end, ready = %d\n&amp;quot;&lt;/span&gt;, ready);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;pthread_t&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;fuzz_setup&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;pthread_t&lt;/span&gt; thread;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (getenv(&lt;span class=&quot;string&quot;&gt;&amp;quot;AFL_PERSISTENT&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(pthread_mutex_init(&amp;amp;mutex, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to init mutex\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(pthread_cond_init(&amp;amp;cond, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to init cond\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CHECK(pthread_create(&amp;amp;thread, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, work_thread, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;fail to create work thread\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; thread;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>第12周记录</title>
    <link href="https://jingtianer.github.io/home/2023/03/28/%E7%BB%84%E4%BC%9A/%E7%AC%AC12%E5%91%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://jingtianer.github.io/home/2023/03/28/%E7%BB%84%E4%BC%9A/%E7%AC%AC12%E5%91%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2023-03-28T04:15:37.000Z</published>
    <updated>2023-04-03T03:20:05.533Z</updated>
    
    <content type="html"><![CDATA[<h2 id="aflgo参数添加"><a href="#aflgo参数添加" class="headerlink" title="aflgo参数添加"></a>aflgo参数添加</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>aflgo使用的编译器是<code>afl-clang-fast</code>和<code>afl-clang-fast++</code>，代码文件位于<code>aflgo/llvm_mode</code>，该文件夹下共有三个文件</p><table><thead><tr><th>文件名</th><th>作用</th></tr></thead><tbody><tr><td>afl-clang-fast.c</td><td>包含main(), 程序入口，编辑输入参数，根据环境变量编辑参数。afl-clang的一层壳，处理好参数后调用afl-clang[++]*, 加载afl-llvm-pass.so</td></tr><tr><td>afl-llvm-pass.so.cc</td><td>在aflgo预处理模式下，读取cfg，生成计算distance所需的几个文件，在aflgo插桩模式下，根据gen_distance.py生成的距离文件，进行插桩</td></tr><tr><td>afl-llvm-rt.o.c</td><td>afl的一个库，防止用户没有安装afl</td></tr></tbody></table><h3 id="参数定义"><a href="#参数定义" class="headerlink" title="参数定义"></a>参数定义</h3><ul><li>-result_type, 效果类型，可选参数值有:<ul><li><p>dns_disturbance, dns扰乱。另需传入四个参数:</p><ul><li>-vulnerable, 易受攻击的函数集合（文件绝对路径）</li><li>-sink, sink函数集合（文件绝对路径），各种recv</li><li>-source, source函数集合（文件绝对路径），各种send</li><li>-blocking, 阻塞函数集合（文件绝对路径）（这里以后可以细化，有些函数是根据flag阻塞的，对于每条指令，拿到函数名后分析其参数判断是否真的阻塞）</li></ul></li><li><p>privilege_escalation, 主机提权</p><ul><li><a href="https://www.usenix.org/system/files/sec21-johnson.pdf">Jetset: Targeted Firmware Rehosting for<br>Embedded Systems</a>  主机提权 &amp; cfg</li></ul></li><li><p>dns_recored_falsify, dns记录篡改</p></li></ul></li></ul><h3 id="dns扰乱的实现"><a href="#dns扰乱的实现" class="headerlink" title="dns扰乱的实现"></a>dns扰乱的实现</h3><h4 id="参数编辑"><a href="#参数编辑" class="headerlink" title="参数编辑"></a>参数编辑</h4><p>文件: <code>afl-clang-fast.c</code><br>在函数中处理参数的部分添加参数，当遇到自定义的参数时，在其前面添加<code>-mllvm</code>，表明该参数传送给llvm</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (--argc) &#123;</span><br><span class="line">u8* cur = *(++argv);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-distance&quot;</span>, <span class="number">9</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-result_type&quot;</span>, <span class="number">12</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-vulnerable&quot;</span>, <span class="number">11</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-sink&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-source&quot;</span>, <span class="number">7</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-blocking&quot;</span>, <span class="number">9</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(cur, <span class="string">&quot;-outdir&quot;</span>, <span class="number">7</span>))</span><br><span class="line">    cc_params[cc_par_cnt++] = <span class="string">&quot;-mllvm&quot;</span>;</span><br><span class="line">    <span class="comment">// ...其他参数的处理</span></span><br><span class="line">    cc_params[cc_par_cnt++] = cur;</span><br></pre></td></tr></table></figure><h4 id="llvm中参数添加"><a href="#llvm中参数添加" class="headerlink" title="llvm中参数添加"></a>llvm中参数添加</h4><p>文件: <code>afl-llvm-pass.so.cc</code><br>在全局区使用llvm提供的工具对参数进行定义，参数会自动解析为对应类型</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 效果导向参数</span></span><br><span class="line"></span><br><span class="line"><span class="function">cl::opt&lt;std::string&gt; <span class="title">ResultTypeOpt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="string">&quot;result_type&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::desc(<span class="string">&quot;Specify the type result.&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::value_desc(<span class="string">&quot;result_type&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 域名解析扰乱参数</span></span><br><span class="line"></span><br><span class="line"><span class="function">cl::opt&lt;std::string&gt; <span class="title">VulnerableFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="string">&quot;vulnerable&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::desc(<span class="string">&quot;Input file containing the vulnerable funcions code. absolute path&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::value_desc(<span class="string">&quot;vulnerable&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">cl::opt&lt;std::string&gt; <span class="title">SinkFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="string">&quot;sink&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::desc(<span class="string">&quot;Input file containing the sink funcions code. absolute path&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::value_desc(<span class="string">&quot;sink&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">cl::opt&lt;std::string&gt; <span class="title">SourceFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="string">&quot;source&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::desc(<span class="string">&quot;Input file containing the source funcions code. absolute path&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::value_desc(<span class="string">&quot;source&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">cl::opt&lt;std::string&gt; <span class="title">BlockingFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="string">&quot;blocking&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::desc(<span class="string">&quot;Input file containing the blocking funcions code. absolute path&quot;</span>),</span></span></span><br><span class="line"><span class="params"><span class="function">  cl::value_desc(<span class="string">&quot;blocking&quot;</span>))</span></span>;</span><br></pre></td></tr></table></figure><ul><li>在实现时注意，这个函数共三种状态:<ul><li>传统插桩（默认行为，当传入参数不满足aflgo的要求时，执行该行为。不能因为参数不符合aflgo的要求而中断此次编译，主要是会导致make阶段对编译工具的测试失败）</li><li>aflgo插桩</li><li>aflgo预处理</li></ul></li></ul><h4 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h4><p>aflgo预处理&#x2F;插桩的代码位于<code>af-llvm-pass.so.cc/bool AFLCoverage::runOnModule(Module&amp; M)</code></p><h4 id="定义ResultType"><a href="#定义ResultType" class="headerlink" title="定义ResultType"></a>定义ResultType</h4><p>文件: <code>result/result.h</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">ResultType</span> &#123;</span><br><span class="line">    DNS_DISTURB = <span class="number">1</span>, <span class="comment">//&quot;dns_disturbance&quot;</span></span><br><span class="line">    PRIVI_ESCA,<span class="comment">// &quot;privilege_escalation&quot;</span></span><br><span class="line">    DNS_RECORD_FALSIFY <span class="comment">// = &quot;dns_recored_falsify&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::string <span class="keyword">operator</span>*(ResultType r) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (r) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResultType::DNS_DISTURB:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;dns_disturbance&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ResultType::PRIVI_ESCA:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;privilege_escalation&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ResultType::DNS_RECORD_FALSIFY:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;dns_recored_falsify&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">FATAL</span>(<span class="string">&quot;r is not a ResultType\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>runOnModule</code>函数中定义一个该枚举变量，根据参数<code>ResultTypeOpt</code>指定该值，用于判断当前效果类型，后续其他效果沿用相同的设计</p><h4 id="定义DisturbHolder"><a href="#定义DisturbHolder" class="headerlink" title="定义DisturbHolder"></a>定义DisturbHolder</h4><p>这是一个类，意在持有dns服务扰乱效果下需要的各种变量，在<code>runOnModule</code>函数中只定义一个改类对象，而不扰乱其原有的命名空间，并在退出时对资源进行释放</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DisturbHolder</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::ifstream vulnerable, sink, source, blocking;</span><br><span class="line">    std::vector&lt;std::string&gt; vulF, sinkF, sourceF, blockF;</span><br><span class="line">    std::string outDir;</span><br><span class="line">    std::set&lt;std::string&gt; intrestedBB;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initOutDirectory</span><span class="params">(std::string OutDirectory)</span> </span>&#123;</span><br><span class="line">        outDir = OutDirectory;</span><br><span class="line">        <span class="keyword">if</span>(outDir.<span class="built_in">back</span>() == <span class="string">&#x27;/&#x27;</span> || outDir.<span class="built_in">back</span>() == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            outDir.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// SAYF(&quot;outdir = %s\n&quot;, outDir.c_str());</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">initFiles</span><span class="params">(std::string pathv, std::string pathsi, std::string pathso, std::string pathb)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pathv.<span class="built_in">empty</span>() || pathsi.<span class="built_in">empty</span>() || pathso.<span class="built_in">empty</span>() || pathb.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;&#x27;-vulnerable&#x27;, &#x27;-sink&#x27;, &#x27;-source&#x27; and &#x27;-blocking&#x27; are not specified&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        vulnerable.<span class="built_in">open</span>(pathv);</span><br><span class="line">        sink.<span class="built_in">open</span>(pathsi);</span><br><span class="line">        source.<span class="built_in">open</span>(pathso);</span><br><span class="line">        blocking.<span class="built_in">open</span>(pathb);</span><br><span class="line">        <span class="keyword">if</span> (!vulnerable.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;vulnerable open failed\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!sink.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;sink open failed\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!source.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;source open failed\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!blocking.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">            <span class="built_in">FATAL</span>(<span class="string">&quot;blocking open failed\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::string tmpstr;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(vulnerable, tmpstr)) vulF.<span class="built_in">push_back</span>(tmpstr);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(sink, tmpstr)) sinkF.<span class="built_in">push_back</span>(tmpstr);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(source, tmpstr)) sourceF.<span class="built_in">push_back</span>(tmpstr);</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">getline</span>(blocking, tmpstr)) blockF.<span class="built_in">push_back</span>(tmpstr);</span><br><span class="line"></span><br><span class="line">        vulnerable.<span class="built_in">close</span>();</span><br><span class="line">        sink.<span class="built_in">close</span>();</span><br><span class="line">        source.<span class="built_in">close</span>();</span><br><span class="line">        blocking.<span class="built_in">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isIntrestedF</span><span class="params">(<span class="type">const</span> llvm::Function* F, std::string filename, <span class="type">int</span> line)</span> </span>&#123;</span><br><span class="line">        std::string func = F-&gt;<span class="built_in">getName</span>().<span class="built_in">str</span>();</span><br><span class="line">        <span class="comment">// SAYF(&quot;checking if %s is isIntrestedF\n&quot;, func.c_str());</span></span><br><span class="line">        <span class="type">bool</span> ret =  std::<span class="built_in">find</span>(vulF.<span class="built_in">begin</span>(), vulF.<span class="built_in">end</span>(), func) != vulF.<span class="built_in">end</span>() ||</span><br><span class="line">            std::<span class="built_in">find</span>(sinkF.<span class="built_in">begin</span>(), sinkF.<span class="built_in">end</span>(), func) != sinkF.<span class="built_in">end</span>() ||</span><br><span class="line">            std::<span class="built_in">find</span>(sourceF.<span class="built_in">begin</span>(), sourceF.<span class="built_in">end</span>(), func) != sourceF.<span class="built_in">end</span>() ||</span><br><span class="line">            std::<span class="built_in">find</span>(blockF.<span class="built_in">begin</span>(), blockF.<span class="built_in">end</span>(), func) != blockF.<span class="built_in">end</span>();</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">            intrestedBB.<span class="built_in">insert</span>(filename + <span class="string">&quot;:&quot;</span> + std::<span class="built_in">to_string</span>(line));</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isSinkF</span><span class="params">(<span class="type">const</span> llvm::Function* F)</span> </span>&#123;</span><br><span class="line">        std::string func = F-&gt;<span class="built_in">getName</span>().<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">find</span>(sinkF.<span class="built_in">begin</span>(), sinkF.<span class="built_in">end</span>(), func) != sinkF.<span class="built_in">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isSourceF</span><span class="params">(<span class="type">const</span> llvm::Function* F)</span> </span>&#123;</span><br><span class="line">        std::string func = F-&gt;<span class="built_in">getName</span>().<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">find</span>(sourceF.<span class="built_in">begin</span>(), sourceF.<span class="built_in">end</span>(), func) != sourceF.<span class="built_in">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isSinkCapable</span><span class="params">(llvm::BasicBlock&amp; bb, std::string&amp;&amp; bb_name)</span> </span>&#123;</span><br><span class="line">        <span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; I : bb) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">auto</span>* c = llvm::<span class="built_in">dyn_cast</span>&lt;llvm::CallInst&gt;(&amp;I)) &#123; <span class="comment">// 同时判空</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">auto</span>* CalledF = c-&gt;<span class="built_in">getCalledFunction</span>()) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">isSinkF</span>(CalledF)) &#123;</span><br><span class="line">                        flag = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isSourceF</span>(CalledF)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag) &#123;</span><br><span class="line">            intrestedBB.<span class="built_in">insert</span>(bb_name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">DisturbHolder</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span>(!outDir.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="function">std::ofstream <span class="title">bbtargets</span><span class="params">(outDir + <span class="string">&quot;/BBtargets.txt&quot;</span>, std::ofstream::out | std::ofstream::app)</span></span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;F : intrestedBB) &#123;</span><br><span class="line">                bbtargets &lt;&lt; F &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">            bbtargets.<span class="built_in">close</span>();</span><br><span class="line">            <span class="comment">// SAYF(&quot;write to outdir\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h4 id="其他修改"><a href="#其他修改" class="headerlink" title="其他修改"></a>其他修改</h4><p>其他修改位于<code>runOnModule</code>，主要是根据参数初始化<code>Holder</code>、分析cfg找到感兴趣的BB等</p><h4 id="效果分析"><a href="#效果分析" class="headerlink" title="效果分析"></a>效果分析</h4><p>修改后的aflgo不需要传入BBTargets.txt，直接根据效果类型在编译过程中生成。利用修改后的aflgo对<code>dns_rdata_fromwire_text</code>进行fuzz，也可以挖出crash，与aflgo的表现相似</p><h2 id="fuzz-c的debug"><a href="#fuzz-c的debug" class="headerlink" title="fuzz.c的debug"></a>fuzz.c的debug</h2><h3 id="错误使用的环境变量"><a href="#错误使用的环境变量" class="headerlink" title="错误使用的环境变量"></a>错误使用的环境变量</h3><p>在named的main函数中，如果检测到<code>named_g_fuzz_type</code>不是<code>isc_fuzz_none</code>，即本次运行是要进行fuzz的，将会调用函数<code>named_fuzz_setup</code>。这个函数的作用是创建一个线程，根据fuzz任务的类型，指定一个函数<code>fn</code>，即该线程执行的函数。但是启动线程的条件是获取环境变量，需要环境中存在<code>__AFL_PERSISTENT</code>或<code>AFL_CMIN</code>。</p><p>问题是<code>__AFL_PERSISTENT</code>是用户手动强制开启persistent模式的，我们在fuzz named之前需要手动添加环境这个环境变量</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> __AFL_PERSISTENT=FU_NAMED</span><br></pre></td></tr></table></figure><h3 id="未使用-AFL-LOOP"><a href="#未使用-AFL-LOOP" class="headerlink" title="未使用__AFL_LOOP()"></a>未使用__AFL_LOOP()</h3><p>__AFL_LOOP()是llvm中定义的一个宏，当其除第一次和最后一次执行时，会执行<code>raise(SIGSTOP)</code>，将进程挂起。不适用的话使用afl测试就会导致挂起无法退出。</p><p>代码中的循环使用的是普通的for循环，应该改成AFL_LOOP</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for(int loop = 0; loop &lt; 100000; loop++) &#123;&#125;</span></span><br><span class="line"><span class="keyword">while</span>(__AFL_LOOP(<span class="number">1000</span>)) &#123;</span><br></pre></td></tr></table></figure><h3 id="A-resolver参数"><a href="#A-resolver参数" class="headerlink" title="-A resolver参数"></a>-A resolver参数</h3><p>在分析参数时使用了<code>strchr</code>来寻找分隔符<code>&#39;:&#39;</code>，但是在分析到第四个参数时出现了第四个参数为空的情况</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sqtype = strdup(named_g_fuzz_addr);</span><br><span class="line">RUNTIME_CHECK(sqtype != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">shost = <span class="built_in">strchr</span>(sqtype, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">RUNTIME_CHECK(shost != <span class="literal">NULL</span>);</span><br><span class="line">*shost = <span class="number">0</span>;</span><br><span class="line">shost++;</span><br><span class="line"></span><br><span class="line">sport = <span class="built_in">strchr</span>(shost, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">RUNTIME_CHECK(sport != <span class="literal">NULL</span>);</span><br><span class="line">*sport = <span class="number">0</span>;</span><br><span class="line">sport++;</span><br><span class="line"></span><br><span class="line">rhost = <span class="built_in">strchr</span>(sport, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">RUNTIME_CHECK(rhost != <span class="literal">NULL</span>);</span><br><span class="line">*rhost = <span class="number">0</span>;</span><br><span class="line">rhost++;</span><br><span class="line"></span><br><span class="line">rport = <span class="built_in">strchr</span>(rhost, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">RUNTIME_CHECK(rport != <span class="literal">NULL</span>);</span><br><span class="line">*rport = <span class="number">0</span>;</span><br><span class="line">rport++;`</span><br></pre></td></tr></table></figure><p>问题出在，我们传入的参数是<code>resolver:&lt;shost&gt;:&lt;sport&gt;:&lt;rhost&gt;:&lt;rport&gt;</code>，但是参数传入这个函数后，前面的<code>resolver</code>已经没有了，他多找了一次冒号，导致最后一个参数为NULL，崩溃</p><p>实际上这个函数的参数应该是五个，第一个是dns协议的qtype，他在注释里写错了，代码本身没有bug</p><p>qtype就是dns查询中，查询的记录类型</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">A=0x01, //指定计算机 IP 地址。</span><br><span class="line">NS=0x02, //指定用于命名区域的 DNS 名称服务器。</span><br><span class="line">MD=0x03, //指定邮件接收站（此类型已经过时了，使用MX代替）</span><br><span class="line">MF=0x04, //指定邮件中转站（此类型已经过时了，使用MX代替）</span><br><span class="line">CNAME=0x05, //指定用于别名的规范名称。</span><br><span class="line">SOA=0x06, //指定用于 DNS 区域的“起始授权机构”。</span><br><span class="line">MB=0x07, //指定邮箱域名。</span><br><span class="line">MG=0x08, //指定邮件组成员。</span><br><span class="line">MR=0x09, //指定邮件重命名域名。</span><br><span class="line">NULL=0x0A, //指定空的资源记录</span><br><span class="line">WKS=0x0B, //描述已知服务。</span><br><span class="line">PTR=0x0C, //如果查询是 IP 地址，则指定计算机名；否则指定指向其它信息的指针。</span><br><span class="line">HINFO=0x0D, //指定计算机 CPU 以及操作系统类型。</span><br><span class="line">MINFO=0x0E, //指定邮箱或邮件列表信息。</span><br><span class="line">MX=0x0F, //指定邮件交换器。</span><br><span class="line">TXT=0x10, //指定文本信息。 </span><br><span class="line">AAAA=0x1c,//IPV6资源记录。</span><br><span class="line">UINFO=0x64, //指定用户信息。</span><br><span class="line">UID=0x65, //指定用户标识符。</span><br><span class="line">GID=0x66, //指定组名的组标识符。</span><br><span class="line">ANY=0xFF //指定所有数据类型。</span><br></pre></td></tr></table></figure><h3 id="named-fuzz-notify的问题"><a href="#named-fuzz-notify的问题" class="headerlink" title="named_fuzz_notify的问题"></a>named_fuzz_notify的问题</h3><p>在AFL_LOOP中，会向服务端发送DNS查询消息，并等待消息返回，等待过程中通过条件变量将AFL_LOOP挂起，当client收到消息后，调用该函数，将条件置为true，AFL_LOOP就可以继续读取下一个测试用例了。</p><p>但是在这个函数中使用了一个<code>raise(SIGSTOP)</code>，也就是收到一个返回消息后，就将该进程挂起了。这样做显然是不正确的。</p><h3 id="导致进程无法kill的真正原因"><a href="#导致进程无法kill的真正原因" class="headerlink" title="导致进程无法kill的真正原因"></a>导致进程无法kill的真正原因</h3><ol><li><p>一是由于前面环境变量的问题，导致线程无法被创建</p></li><li><p>named_fuzz_notify中调用了raise(SIGSTOP)，虽然__AFL_LOOP()在除第一次调用和最后一次调用时也会发送同一个信号，但是如果使用<code>afl</code>而不是<code>afl-clang-fast</code>，就会导致其被挂起而无法退出</p></li><li><p>多个进程同时监听同一个端口，导致本应由进程A接受的消息被进程B接受，导致A的fuzz线程被持续挂起</p></li><li><p>当named不指定-g参数时，就会fork自己，并不清楚为什么会这样</p></li></ol><p>对于resolver fuzz模式，需要在named的配置文件中配置<code>aaaaaaaaaa.example</code>的root zone，这是我之前读注释时没有读懂的</p><p>对于client的fuzz模式，fuzz线程会作为一个client运行，去查询参数中指定的<code>&lt;addr&gt;:&lt;port&gt;</code>的dns服务器的消息，之前一直没有理解，看了代码后才发现这个参数是要指定本进程的</p><h3 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h3><p>通过以上的debug过程，最终成功将named跑起来了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">                        american fuzzy lop 2.57b (named)</span><br><span class="line"></span><br><span class="line">┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐</span><br><span class="line">│        run time : 0 days, 0 hrs, 2 min, 50 sec       │  cycles <span class="keyword">done</span> : 1      │</span><br><span class="line">│   last new path : 0 days, 0 hrs, 0 min, 4 sec        │  total paths : 353    │</span><br><span class="line">│ last <span class="built_in">uniq</span> crash : none seen yet                      │ <span class="built_in">uniq</span> crashes : 0      │</span><br><span class="line">│  last <span class="built_in">uniq</span> hang : none seen yet                      │   <span class="built_in">uniq</span> hangs : 0      │</span><br><span class="line">├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤</span><br><span class="line">│  now processing : 330* (93.48%)     │    map density : 0.02% / 19.74%        │</span><br><span class="line">│ paths timed out : 0 (0.00%)         │ count coverage : 3.12 bits/tuple       │</span><br><span class="line">├─ stage progress ────────────────────┼─ findings <span class="keyword">in</span> depth ────────────────────┤</span><br><span class="line">│  now trying : arith 8/8             │ favored paths : 3 (0.85%)              │</span><br><span class="line">│ stage execs : 1518/3738 (40.61%)    │  new edges on : 60 (17.00%)            │</span><br><span class="line">│ total execs : 1.20M                 │ total crashes : 0 (0 unique)           │</span><br><span class="line">│  <span class="built_in">exec</span> speed : 6939/sec              │  total tmouts : 0 (0 unique)           │</span><br><span class="line">├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤</span><br><span class="line">│   bit flips : 5/17.4k, 4/17.4k, 2/17.2k             │    levels : 9          │</span><br><span class="line">│  byte flips : 1/2176, 2/2121, 1/2024                │   pending : 299        │</span><br><span class="line">│ arithmetics : 30/118k, 6/27.5k, 1/7641              │  pend fav : 0          │</span><br><span class="line">│  known ints : 0/11.1k, 13/52.6k, 21/84.4k           │ own finds : 352        │</span><br><span class="line">│  dictionary : 0/0, 0/0, 6/21.8k                     │  imported : n/a        │</span><br><span class="line">│       havoc : 260/815k, 0/0                         │ stability : 0.08%      │</span><br><span class="line">│        trim : 0.00%/681, 0.00%                      ├────────────────────────┘</span><br><span class="line">└─────────────────────────────────────────────────────┘          [cpu000: 58%]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>目前已经将dns_rdata_fromwire_text挖出的漏洞喂给named进行fuzz了</p><h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><p>运行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">AFLGO=/home/ubuntu/dnsenv/aflgo/scripts/build/aflgo</span><br><span class="line">SUBJECT=<span class="variable">$PWD</span>/bind9_fast</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> AFL_PERSISTENT=1</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$SUBJECT</span>/lib/isc/.libs:<span class="variable">$SUBJECT</span>/lib/dns/.libs:<span class="variable">$SUBJECT</span>/lib/isccc/.libs:<span class="variable">$SUBJECT</span>/lib/isccfg/.libs</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$AFLGO</span>/afl-clang-fast</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$AFLGO</span>/afl-clang-fast++</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;-D ENABLE_AFL&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;-D ENABLE_AFL&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">autoreconf -<span class="keyword">fi</span></span><br><span class="line">./configure  --enable-fuzzing=afl</span><br><span class="line">sudo make -j</span><br><span class="line">sudo make install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">tee</span> named.conf &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">options &#123;</span><br><span class="line">    directory    <span class="string">&quot;<span class="variable">$PWD</span>/workdir&quot;</span>;</span><br><span class="line">    allow-query     &#123; any; &#125;;</span><br><span class="line">    listen-on port 2778 &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br><span class="line">pattern=<span class="string">&quot;s/\$PWD/<span class="subst">$(echo `pwd` | sed <span class="string">&quot;s/\//\\\\\//g&quot;</span>)</span>/g&quot;</span></span><br><span class="line">sed -i <span class="variable">$pattern</span> named.conf </span><br><span class="line"><span class="built_in">cat</span> named.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r <span class="keyword">in</span>/working <span class="keyword">in</span>/fast</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d workdir ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">rm</span> -rf workdir;<span class="built_in">mkdir</span> workdir</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d workdir ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> workdir</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d out_fast ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> out_fast</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cp</span> <span class="keyword">in</span>/working/* <span class="keyword">in</span>/fast -r</span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -t 50000 -m none -i <span class="keyword">in</span>/dns_name_fromwire.in -o out_fast -- <span class="variable">$SUBJECT</span>/bin/named/.libs/named -A client:127.0.0.1:2778 -g -c named.conf</span><br></pre></td></tr></table></figure><blockquote><p>相当于搭建了一个最简单的named服务器，持续将afl-fuzz的测试用例作为数据包发送给自身<br>种子文件我使用tcpdump抓取了一个dis查询的包</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">named -c named.conf -L named.log <span class="comment">#监听端口2779 </span></span><br><span class="line">sudo tcpdump -i lo udp port 2779 -c 1 -w out &amp;</span><br><span class="line">dig @localhost -p 2779 www.baidu.com</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;aflgo参数添加&quot;&gt;&lt;a href=&quot;#aflgo参数添加&quot; class=&quot;headerlink&quot; title=&quot;aflgo参数添加&quot;&gt;&lt;/a&gt;aflgo参数添加&lt;/h2&gt;&lt;h3 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h3&gt;&lt;p&gt;aflgo使用的编译器是&lt;code&gt;afl-clang-fast&lt;/code&gt;和&lt;code&gt;afl-clang-fast++&lt;/code&gt;，代码文件位于&lt;code&gt;aflgo/llvm_mode&lt;/code&gt;，该文件夹下共有三个文件&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;文件名&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;afl-clang-fast.c&lt;/td&gt;
&lt;td&gt;包含main(), 程序入口，编辑输入参数，根据环境变量编辑参数。afl-clang的一层壳，处理好参数后调用afl-clang[++]*, 加载afl-llvm-pass.so&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;afl-llvm-pass.so.cc&lt;/td&gt;
&lt;td&gt;在aflgo预处理模式下，读取cfg，生成计算distance所需的几个文件，在aflgo插桩模式下，根据gen_distance.py生成的距离文件，进行插桩&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;afl-llvm-rt.o.c&lt;/td&gt;
&lt;td&gt;afl的一个库，防止用户没有安装afl&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h3 id=&quot;参数定义&quot;&gt;&lt;a href=&quot;#参数定义&quot; class=&quot;headerlink&quot; title=&quot;参数定义&quot;&gt;&lt;/a&gt;参数定义&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;-result_type, 效果类型，可选参数值有:&lt;ul&gt;
&lt;li&gt;&lt;p&gt;dns_disturbance, dns扰乱。另需传入四个参数:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;-vulnerable, 易受攻击的函数集合（文件绝对路径）&lt;/li&gt;
&lt;li&gt;-sink, sink函数集合（文件绝对路径），各种recv&lt;/li&gt;
&lt;li&gt;-source, source函数集合（文件绝对路径），各种send&lt;/li&gt;
&lt;li&gt;-blocking, 阻塞函数集合（文件绝对路径）（这里以后可以细化，有些函数是根据flag阻塞的，对于每条指令，拿到函数名后分析其参数判断是否真的阻塞）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;privilege_escalation, 主机提权&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.usenix.org/system/files/sec21-johnson.pdf&quot;&gt;Jetset: Targeted Firmware Rehosting for&lt;br&gt;Embedded Systems&lt;/a&gt;  主机提权 &amp;amp; cfg&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;dns_recored_falsify, dns记录篡改&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>cha6.进程</title>
    <link href="https://jingtianer.github.io/home/2023/03/25/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha6/"/>
    <id>https://jingtianer.github.io/home/2023/03/25/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha6/</id>
    <published>2023-03-25T10:05:00.000Z</published>
    <updated>2023-03-25T09:47:49.062Z</updated>
    
    <content type="html"><![CDATA[<h2 id="练习1"><a href="#练习1" class="headerlink" title="练习1"></a>练习1</h2><blockquote><p>编译程序清单6-1中的程序(mem_segments.c)，使用1s-l命令显示可执行文件的大小。虽然该程序包含一个大约10MB的数组，但可执行文件大小要远小于此,为什么?</p></blockquote><ul><li>局部变量，分配在栈中，运行时分配</li></ul><h2 id="练习2"><a href="#练习2" class="headerlink" title="练习2"></a>练习2</h2><blockquote><p>编写一个程序，观察当使用 longjmp()函数跳转到一个已经返回的函数时会发生什么?</p></blockquote><ul><li>开优化会无限递归，不开优化也有可能无限递归</li></ul><h2 id="练习3"><a href="#练习3" class="headerlink" title="练习3"></a>练习3</h2><blockquote><p>使用getenv()函数、putenv()函数，必要时可直接修改environ，来实现setenv()函数和unsetenv()函数。此处的unsetenv()函数应检查是否对环境变量进行了多次定义，如果是多次定义则将移除对该变量的所有定义(glibc版本的unsetenv()函数实现了这-功能)</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"><span class="type">int</span> __setenv(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">int</span> overwrite);</span><br><span class="line"><span class="comment">// overwrite = 0, 已存在则不改变, return 0/-1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __unsetenv(<span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"><span class="comment">// return 0/-1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> setenv(a,b,c) errno = 0; \</span></span><br><span class="line"><span class="meta"><span class="keyword">if</span>(__setenv(a, b, c) == -1) &#123; \</span></span><br><span class="line"><span class="meta">    perror(<span class="string">&quot;setenv&quot;</span>); \</span></span><br><span class="line"><span class="meta">    exit(1); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unsetenv(a) errno = 0; \</span></span><br><span class="line"><span class="meta"><span class="keyword">if</span>(__unsetenv(a) == -1) &#123; \</span></span><br><span class="line"><span class="meta">    perror(<span class="string">&quot;unsetenv&quot;</span>); \</span></span><br><span class="line"><span class="meta">    exit(1); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define GETENV</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printEnv</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    clearenv();</span><br><span class="line">    environ = (<span class="type">char</span> **)<span class="built_in">malloc</span>(argc*<span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        environ[i<span class="number">-1</span>] = argv[i];</span><br><span class="line">        environ[i<span class="number">-1</span>] = argv[i];</span><br><span class="line">    &#125;</span><br><span class="line">    environ[argc<span class="number">-1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    printEnv();</span><br><span class="line">    setenv(<span class="string">&quot;Jingtianer&quot;</span>, <span class="string">&quot;pretty&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    setenv(<span class="string">&quot;Jingtianer&quot;</span>, <span class="string">&quot;handsome&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    setenv(<span class="string">&quot;Meeow&quot;</span>, <span class="string">&quot;handsome&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    setenv(<span class="string">&quot;Meeow&quot;</span>, <span class="string">&quot;pretty&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    printEnv();</span><br><span class="line">    unsetenv(<span class="string">&quot;Meeow&quot;</span>);</span><br><span class="line">    unsetenv(<span class="string">&quot;Jingtianer&quot;</span>);</span><br><span class="line">    unsetenv(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    printEnv();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printEnv</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;environ=%p\n&quot;</span>, environ);</span><br><span class="line">    <span class="keyword">if</span>(environ != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> **env=environ; *env; env++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, *env);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __setenv(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *val, <span class="type">int</span> overwrite) &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifndef</span> GETENV</span></span><br><span class="line">    <span class="type">size_t</span> nameLen = <span class="built_in">strlen</span>(name);</span><br><span class="line">    <span class="type">char</span> **env=environ;</span><br><span class="line">    <span class="keyword">if</span>(env)</span><br><span class="line">        <span class="keyword">for</span>(; *env; env++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strncmp</span>(name, *env, nameLen) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(overwrite == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="type">char</span> * envstr = (<span class="type">char</span> *) <span class="built_in">malloc</span>((nameLen+<span class="built_in">strlen</span>(val)+<span class="number">1</span>+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">sprintf</span>(envstr, <span class="string">&quot;%s=%s&quot;</span>, name, val);</span><br><span class="line">    <span class="keyword">if</span>(env != <span class="literal">NULL</span> &amp;&amp; *env != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *env = envstr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> putenv(envstr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> GETENV</span></span><br><span class="line">    <span class="type">char</span> *env;</span><br><span class="line">    <span class="keyword">if</span>(env=getenv(name) != <span class="literal">NULL</span> &amp;&amp; overwrite == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> nameLen = <span class="built_in">strlen</span>(name);</span><br><span class="line">    <span class="type">char</span> * envstr = (<span class="type">char</span> *) <span class="built_in">malloc</span>((nameLen+<span class="built_in">strlen</span>(val)+<span class="number">1</span>+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">sprintf</span>(envstr, <span class="string">&quot;%s=%s&quot;</span>, name, val);</span><br><span class="line">    <span class="keyword">return</span> putenv(envstr);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __unsetenv(<span class="type">const</span> <span class="type">char</span> *name) &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifndef</span> GETENV</span></span><br><span class="line">    <span class="keyword">if</span>(environ == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> nameLen = <span class="built_in">strlen</span>(name);</span><br><span class="line">    <span class="type">char</span> **env=environ, **move = environ;</span><br><span class="line">    <span class="keyword">for</span>(; *env; env++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(name, *env, nameLen) != <span class="number">0</span>) &#123;</span><br><span class="line">            *move = *env;</span><br><span class="line">            move++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *move = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> GETENV</span></span><br><span class="line">    <span class="type">char</span> *env;</span><br><span class="line">    <span class="keyword">if</span>(env=getenv(name) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> putenv(name); <span class="comment">//并非标准实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;练习1&quot;&gt;&lt;a href=&quot;#练习1&quot; class=&quot;headerlink&quot; title=&quot;练习1&quot;&gt;&lt;/a&gt;练习1&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;编译程序清单6-1中的程序(mem_segments.c)，使用1s-l命令显示可执行文件的大小。虽然该程序包含一个大约10MB的数组，但可执行文件大小要远小于此,为什么?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;局部变量，分配在栈中，运行时分配&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;练习2&quot;&gt;&lt;a href=&quot;#练习2&quot; class=&quot;headerlink&quot; title=&quot;练习2&quot;&gt;&lt;/a&gt;练习2&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;编写一个程序，观察当使用 longjmp()函数跳转到一个已经返回的函数时会发生什么?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;开优化会无限递归，不开优化也有可能无限递归&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>cha5.深入探究文件IO</title>
    <link href="https://jingtianer.github.io/home/2023/03/23/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha5/"/>
    <id>https://jingtianer.github.io/home/2023/03/23/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha5/</id>
    <published>2023-03-23T10:05:00.000Z</published>
    <updated>2023-03-23T14:51:15.038Z</updated>
    
    <content type="html"><![CDATA[<h2 id="练习1"><a href="#练习1" class="headerlink" title="练习1"></a>练习1</h2><blockquote><p>请使用标准文件IO系统调用(open()和lseek())和off_t数据类型修改程序清单5-3中的程序。将宏_FILE_OFFSET_BITS的值设置为64进行编译，并测试该程序是否能够成功创建一个大文件。</p></blockquote><p>将xxx64改为xxx，off64_t改为off_t，可以创建大文件（使用 -m32编译）</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #define _LARGEFILE64_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FILE_OFFSET_BITS 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LARGEFILE64_SOURCE</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(long) = %d, sizeof(long long) = %d, sizeof(off_t) = %d, sizeof(off64_t) = %d\n&quot;</span>, <span class="built_in">sizeof</span>(<span class="type">long</span>), <span class="built_in">sizeof</span>(<span class="type">long</span> <span class="type">long</span>), <span class="built_in">sizeof</span>(<span class="type">off_t</span>), <span class="built_in">sizeof</span>(<span class="type">off64_t</span>));</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(argc !=<span class="number">3</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot; pathname offset\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open64</span>(argv[<span class="number">1</span>], O_RDWR | O_CREAT, S_IRUSR|S_IWUSR);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;open64 fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">off64_t</span> off = <span class="built_in">atoll</span>(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">lseek64</span>(fd, off, SEEK_SET) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;lseek64&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">write</span>(fd, <span class="string">&quot;test&quot;</span>, <span class="number">4</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _FILE_OFFSET_BITS</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(long) = %d, sizeof(long long) = %d, sizeof(off_t) = %d\n&quot;</span>, <span class="built_in">sizeof</span>(<span class="type">long</span>), <span class="built_in">sizeof</span>(<span class="type">long</span> <span class="type">long</span>), <span class="built_in">sizeof</span>(<span class="type">off_t</span>));</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(argc !=<span class="number">3</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot; pathname offset\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(argv[<span class="number">1</span>], O_RDWR | O_CREAT, S_IRUSR|S_IWUSR);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;open64 fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">off_t</span> off = <span class="built_in">atoll</span>(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">lseek</span>(fd, off, SEEK_SET) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;lseek64&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">write</span>(fd, <span class="string">&quot;test&quot;</span>, <span class="number">4</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">writeErr</span>(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> </span>&#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = <span class="built_in">write</span>(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="练习2"><a href="#练习2" class="headerlink" title="练习2"></a>练习2</h2><blockquote><p>5-2.编写一个程序，使用O_APPEND标志并以写方式打开一个已存在的文件，且将文件偏移量置于文件起始处，再写入数据。数据会显示在文件中的哪个位置?为什么?</p></blockquote><p>文件末尾，在write时，lseek失效了</p><h2 id="练习3"><a href="#练习3" class="headerlink" title="练习3"></a>练习3</h2><blockquote><p>本习题的设计目的在于展示为何以O_APPEND标志打开文件来保障操作的原子性是必要的。请编写一程序，可接收多达3个命令行参数:</p></blockquote><blockquote><p>$ atomic_append filename num-bytes [x]</p></blockquote><blockquote><p>该程序应打开所指定的文件(如有必要，则创建之)，然后以每次调用write()写入一个字节的方式，向文件尾部追加num-bytes个字节。缺省情况下，程序使用O_APPEND标志打开文件，但若存在第三个命令行参数(x)，那么打开文件时将不再使用O_APPEND标志，代之以在每次调用write(前调用lseek(fd,0,SEEK_END))。同时运行该程序的两个实例，不带x参数，将100万个字节写入同一文件:</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ atomic_append f1 10000oo &amp; atomic_append f1 1000000</span><br></pre></td></tr></table></figure><blockquote><p>重复上述操作，将数据写入另一文件，但运行时加入x参数:</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ atomic_append f2 1000000 x &amp; atomic_append f2 1000000 x</span><br></pre></td></tr></table></figure><blockquote><p>使用ls-1命令检查文件f1和f2的大小，并解释两文件大小不同的原因,</p></blockquote><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">writeMeow</span><span class="params">(<span class="type">int</span> __fd, <span class="type">const</span> <span class="type">void</span> *__buf, <span class="type">size_t</span> __n, <span class="type">int</span> argc)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>((argc !=<span class="number">4</span> &amp;&amp; argc != <span class="number">5</span>) || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        writeErr(argv[<span class="number">0</span>]);</span><br><span class="line">        writeErr(<span class="string">&quot; pathname string num [x]\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd = open(argv[<span class="number">1</span>], O_RDWR | O_CREAT | (argc == <span class="number">5</span> ? <span class="number">0</span> : O_APPEND), S_IRUSR|S_IWUSR);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        writeErr(<span class="string">&quot;open64 fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> off = atoll(argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="type">int</span> argv2len = <span class="built_in">strlen</span>(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; off; i++)</span><br><span class="line">        <span class="keyword">if</span>(writeMeow(fd, argv[<span class="number">2</span>], argv2len, argc) == <span class="number">-1</span>) &#123;</span><br><span class="line">            writeErr(<span class="string">&quot;writeMeow&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">writeMeow</span><span class="params">(<span class="type">int</span> __fd, <span class="type">const</span> <span class="type">void</span> *__buf, <span class="type">size_t</span> __n, <span class="type">int</span> argc)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc == <span class="number">5</span>) lseek(__fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    write(__fd, __buf, __n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./practice5.3 f5.3 <span class="string">&quot;Meow &quot;</span> 1048576 &amp; ./practice5.3 f5.3 <span class="string">&quot;Woof &quot;</span> 1048576</span><br><span class="line">$ ./practice5.3 f5.3x <span class="string">&quot;Meow &quot;</span> 1048576 x &amp; ./practice5.3 f5.3x <span class="string">&quot;Woof &quot;</span> 1048576 x</span><br><span class="line">$ ll -h</span><br><span class="line">-rw------- 1 root root  10M Mar 23 20:17 f5.3</span><br><span class="line">-rw------- 1 root root 5.9M Mar 23 20:17 f5.3x</span><br></pre></td></tr></table></figure><h3 id="解释原因"><a href="#解释原因" class="headerlink" title="解释原因"></a>解释原因</h3><p>不加x的10M，加x的5.9M</p><p>通过计算，如果所有数据正常写入，那么文件大小应该刚好是10M</p><p>加X的指针移动和写入不具有原子性，可能存在两个进程同时向同一偏移量处写入数据，相互覆盖，导致文件大小偏小。</p><p>不加X的具有原子性，指针移动和写入不会打断，不会在同一位置写入</p><h2 id="练习4"><a href="#练习4" class="headerlink" title="练习4"></a>练习4</h2><blockquote><p>使用fcntl()和 close()(若有必要)来实现 dupO和 dup2()。(对于某些错误，dup2()和fentl()返回的errno值并不相同，此处可不予考虑。)务必牢记dup2()需要处理的一种特殊情况，即 oldfd与 newfd相等。这时，应检查oldfd是否有效，测试fcntl(oldfd，F_GETFL)是否成功就能达到这一目的。若oldfd无效，则dup2()将返回-1，并将errno置为EBADF。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">int</span> exitCode, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">int</span> __dup(<span class="type">int</span> oldfd);</span><br><span class="line"><span class="type">int</span> __dup2(<span class="type">int</span> oldfd, <span class="type">int</span> newfd);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> dupStdout = __dup(STDOUT_FILENO);</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    write(dupStdout, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    dupStdout = __dup2(STDOUT_FILENO, dupStdout);</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    write(dupStdout, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    <span class="type">char</span> tmpfile[] = <span class="string">&quot;JingtianTmpXXXXXX&quot;</span>;</span><br><span class="line">    <span class="type">int</span> tmpfd = mkstemp(tmpfile);</span><br><span class="line">    dupStdout = __dup2(STDOUT_FILENO, tmpfd);</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    write(tmpfd, <span class="string">&quot;Jingtianer\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Jingtianer\n&quot;</span>));</span><br><span class="line">    unlink(tmpfile);</span><br><span class="line">    close(tmpfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __dup(<span class="type">int</span> oldfd) &#123;</span><br><span class="line">    <span class="keyword">return</span> fcntl(oldfd, F_DUPFD, oldfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __dup2(<span class="type">int</span> oldfd, <span class="type">int</span> newfd) &#123;</span><br><span class="line">    <span class="keyword">if</span>(oldfd != newfd) &#123;</span><br><span class="line">        close(newfd);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(fcntl(oldfd, F_GETFL) == <span class="number">-1</span>) &#123;</span><br><span class="line">        errno = EBADF;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fcntl(oldfd, F_DUPFD, newfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">int</span> exitCode, <span class="type">const</span> <span class="type">char</span> *format, ...)</span> &#123;</span><br><span class="line">    va_list va;</span><br><span class="line">    va_start(va, format);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, format, va);</span><br><span class="line">    va_end(va);</span><br><span class="line">    <span class="built_in">exit</span>(exitCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="练习5"><a href="#练习5" class="headerlink" title="练习5"></a>练习5</h2><blockquote><p>编写一程序，验证文件描述符及其副本是否共享了文件偏移量和打开文件的状态标志。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true <span class="string">&#x27;\1&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false <span class="string">&#x27;\0&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">int</span> exitCode, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check</span><span class="params">(<span class="type">int</span> fd1, <span class="type">int</span> fd2)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">int</span> exitCode, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool2str(x) (x == true ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>) &#123;</span><br><span class="line">        exitErr(<span class="number">1</span>, <span class="string">&quot;Usage: %s file1 file2\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd1 = open(argv[<span class="number">1</span>], O_CREAT | O_RDWR);</span><br><span class="line">    <span class="type">int</span> fd2 = open(argv[<span class="number">2</span>], O_CREAT | O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd1 == <span class="number">-1</span> || fd2 == <span class="number">-1</span>) &#123;</span><br><span class="line">        exitErr(<span class="number">2</span>, <span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="type">int</span> fd1dup = dup(fd1);</span><br><span class="line">    <span class="type">bool</span> check1 = check(fd1, fd1dup); <span class="comment">//true</span></span><br><span class="line">    <span class="type">bool</span> check2 = check(fd1, fd2); <span class="comment">// false</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;check1 == %s, check2 == %s\n&quot;</span>, bool2str(check1), bool2str(check2));</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> check1 + check2 - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">check</span><span class="params">(<span class="type">int</span> fd1, <span class="type">int</span> fd2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(lseek(fd1, <span class="number">0</span>, SEEK_CUR) != lseek(fd2, <span class="number">0</span>, SEEK_CUR)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lseek(fd1, <span class="number">1</span>, SEEK_CUR);</span><br><span class="line">        <span class="keyword">if</span>(lseek(fd1, <span class="number">0</span>, SEEK_CUR) != lseek(fd2, <span class="number">0</span>, SEEK_CUR)) &#123;</span><br><span class="line">            lseek(fd1, <span class="number">-1</span>, SEEK_CUR);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lseek(fd1, <span class="number">-1</span>, SEEK_CUR);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(fcntl(fd1, F_GETFL) != fcntl(fd2, F_GETFL)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> flag = fcntl(fd1, F_GETFL);</span><br><span class="line">        fcntl(fd1, F_SETFL, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(fcntl(fd1, F_GETFL) != fcntl(fd2, F_GETFL)) &#123;</span><br><span class="line">            fcntl(fd1, F_SETFL, flag);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fcntl(fd1, F_SETFL, flag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">int</span> exitCode, <span class="type">const</span> <span class="type">char</span> *format, ...)</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">    va_list va;</span><br><span class="line">    va_start(va, format);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, format, va);</span><br><span class="line">    va_end(va);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="built_in">exit</span>(exitCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="练习6"><a href="#练习6" class="headerlink" title="练习6"></a>练习6</h2><blockquote><p>说明下列代码中每次执行 write()后，输出文件的内容是什么，为什么。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fd1 = open(file, O_RDNR | O_CREAT | O_TRUNC，S_IRUSR | S_IMUSR);</span><br><span class="line">fd2 = dup(fd1);</span><br><span class="line">fd3 = open(file，O_RDWR);</span><br><span class="line">write(fd1,<span class="string">&quot;Hello,&quot;</span>，<span class="number">6</span>); <span class="comment">// Hello</span></span><br><span class="line">write(fd2,<span class="string">&quot;world&quot;</span>, <span class="number">6</span>); <span class="comment">// Helloworld fd2由fd1复制而来，共享文件指针，fd1write后，文件指针后移，fd2也后移</span></span><br><span class="line">lseek(fd2, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">write(fd1,<span class="string">&quot;HELLO,&quot;</span>，<span class="number">6</span>); <span class="comment">// HELLOworld fd2移动到文件开头，fd1也移动，共享文件指针和状态标志、inode指针</span></span><br><span class="line">write(fd3,<span class="string">&quot;Gidday&quot;</span>， <span class="number">6</span>); <span class="comment">// Giddayworld，fd3不是dup*而来，不共享指针，其指针还在0，写入0</span></span><br></pre></td></tr></table></figure><h2 id="练习7"><a href="#练习7" class="headerlink" title="练习7"></a>练习7</h2><blockquote><p>使用read()、write()以及 malloc函数包（见7.1.2节）中的必要函数以实现readv()和 writev()功能。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/uio.h&gt;</span> <span class="comment">//iovec</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true <span class="string">&#x27;\1&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false <span class="string">&#x27;\0&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> __writev(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcount);</span><br><span class="line"><span class="type">ssize_t</span> __readv(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcount);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> fdw = open(argv[<span class="number">1</span>], O_CREAT | O_TRUNC | O_RDWR);</span><br><span class="line">    <span class="type">int</span> fdr = open(argv[<span class="number">1</span>], O_CREAT | O_TRUNC | O_RDWR);</span><br><span class="line">    <span class="type">int</span> contentCount = argc - <span class="number">2</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">vecArr</span> =</span> (<span class="keyword">struct</span> iovec*)<span class="built_in">malloc</span>(<span class="number">2</span> * contentCount * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iovec));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        vecArr[<span class="number">2</span>*(i<span class="number">-2</span>)].iov_base = argv[i];</span><br><span class="line">        vecArr[<span class="number">2</span>*(i<span class="number">-2</span>)].iov_len = <span class="built_in">strlen</span>(argv[i]);</span><br><span class="line">        vecArr[<span class="number">2</span>*(i<span class="number">-2</span>)+<span class="number">1</span>].iov_base = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        vecArr[<span class="number">2</span>*(i<span class="number">-2</span>)+<span class="number">1</span>].iov_len = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    writev(fdw, vecArr, <span class="number">2</span> * contentCount);</span><br><span class="line">    <span class="built_in">free</span>(vecArr);</span><br><span class="line">    vecArr = (<span class="keyword">struct</span> iovec*)<span class="built_in">malloc</span>(contentCount * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iovec));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="type">int</span> size = <span class="built_in">strlen</span>(argv[i])+<span class="number">1</span>;</span><br><span class="line">        vecArr[i<span class="number">-2</span>].iov_base = <span class="built_in">malloc</span>(size * <span class="keyword">sizeof</span>(<span class="type">char</span>) + <span class="number">1</span>);</span><br><span class="line">        vecArr[i<span class="number">-2</span>].iov_len = size;</span><br><span class="line">    &#125;</span><br><span class="line">    errno=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> read = readv(fdr, vecArr,  contentCount);</span><br><span class="line">    <span class="keyword">if</span>(read == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *err = strerror(errno);</span><br><span class="line">        write(STDOUT_FILENO, err, <span class="built_in">strlen</span>(err));</span><br><span class="line">        write(STDOUT_FILENO, <span class="string">&quot;\n&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> read;</span><br><span class="line">    &#125;</span><br><span class="line">    writev(STDOUT_FILENO, vecArr, contentCount);</span><br><span class="line">    close(fdw);</span><br><span class="line">    close(fdr);</span><br><span class="line">    <span class="built_in">free</span>(vecArr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> __writev(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcount) &#123;</span><br><span class="line">    <span class="type">ssize_t</span> writeSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; iovcount; i++) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> writeSize1 = write(fd, iov[i].iov_base, iov[i].iov_len);</span><br><span class="line">        writeSize += writeSize1;</span><br><span class="line">        <span class="keyword">if</span>(writeSize1 == <span class="number">-1</span> || writeSize1 &lt; iov[i].iov_len) &#123;</span><br><span class="line">            <span class="keyword">return</span> writeSize1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iovcount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> __readv(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcount) &#123;</span><br><span class="line">    <span class="type">ssize_t</span> readSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; iovcount; i++) &#123;</span><br><span class="line">        <span class="type">ssize_t</span> readSize1 = read(fd, iov[i].iov_base, iov[i].iov_len);</span><br><span class="line">        readSize += readSize1;</span><br><span class="line">        <span class="keyword">if</span>(readSize1 == <span class="number">-1</span> || readSize1 &lt; iov[i].iov_len) &#123;</span><br><span class="line">            <span class="keyword">return</span> readSize;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(readSize == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> i+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iovcount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>学习的<code>read</code>，<code>write</code>，<code>readv</code>，<code>writev</code>，<code>preadv</code>，<code>pwritev</code>，其输入输出的内容不必都是字符串，由<code>iovec</code>的定义以及他们的函数原型可见，写入读取数据的类型为<code>void *</code>或<code>const void *</code>，是不限制输入输出的数据类型的。</p><p>此外，<code>pread*</code>和<code>pwrite*</code>具有原子性，可以代替<code>lseek + write/read</code>的组合，防止多个进程相互读写同一文件时，出现读写位置出错的情况，如果常出现<code>lseek + write/read</code>的组合，使用<code>pread*</code>和<code>pwrite*</code>可以大量减少系统调用的使用，提高性能</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;练习1&quot;&gt;&lt;a href=&quot;#练习1&quot; class=&quot;headerlink&quot; title=&quot;练习1&quot;&gt;&lt;/a&gt;练习1&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;请使用标准文件IO系统调用(open()和lseek())和off_t数据类型修改程序清单5-3中的程序。将宏_FILE_OFFSET_BITS的值设置为64进行编译，并测试该程序是否能够成功创建一个大文件。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;将xxx64改为xxx，off64_t改为off_t，可以创建大文件（使用 -m32编译）&lt;/p&gt;
&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// #define _LARGEFILE64_SOURCE&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; _FILE_OFFSET_BITS 64&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;sys/stat.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;fcntl.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; debug&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; debug&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;writeErr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt;* str)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; _LARGEFILE64_SOURCE&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; **argv)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; debug&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;sizeof(long) = %d, sizeof(long long) = %d, sizeof(off_t) = %d, sizeof(off64_t) = %d\n&amp;quot;&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;), &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;), &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;off_t&lt;/span&gt;), &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;off64_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(argc !=&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; || &lt;span class=&quot;built_in&quot;&gt;strcmp&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;&amp;quot;--help&amp;quot;&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot; pathname offset\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; fd = &lt;span class=&quot;built_in&quot;&gt;open64&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], O_RDWR | O_CREAT, S_IRUSR|S_IWUSR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(fd == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;open64 fail&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;off64_t&lt;/span&gt; off = &lt;span class=&quot;built_in&quot;&gt;atoll&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;lseek64&lt;/span&gt;(fd, off, SEEK_SET) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;lseek64&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;write&lt;/span&gt;(fd, &lt;span class=&quot;string&quot;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;write&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; _FILE_OFFSET_BITS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; **argv)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;ifdef&lt;/span&gt; debug&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;printf&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;sizeof(long) = %d, sizeof(long long) = %d, sizeof(off_t) = %d\n&amp;quot;&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;), &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;long&lt;/span&gt;), &lt;span class=&quot;built_in&quot;&gt;sizeof&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;off_t&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(argc !=&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; || &lt;span class=&quot;built_in&quot;&gt;strcmp&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;&amp;quot;--help&amp;quot;&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot; pathname offset\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; fd = &lt;span class=&quot;built_in&quot;&gt;open&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;], O_RDWR | O_CREAT, S_IRUSR|S_IWUSR);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(fd == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;open64 fail&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;off_t&lt;/span&gt; off = &lt;span class=&quot;built_in&quot;&gt;atoll&lt;/span&gt;(argv[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;lseek&lt;/span&gt;(fd, off, SEEK_SET) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;lseek64&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;write&lt;/span&gt;(fd, &lt;span class=&quot;string&quot;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;) == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;writeErr&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;write&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;writeErr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt;* str)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    errno = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; writeSize = &lt;span class=&quot;built_in&quot;&gt;write&lt;/span&gt;(STDERR_FILENO, str, &lt;span class=&quot;built_in&quot;&gt;strlen&lt;/span&gt;(str));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(writeSize == &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;exit&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;练习2&quot;&gt;&lt;a href=&quot;#练习2&quot; class=&quot;headerlink&quot; title=&quot;练习2&quot;&gt;&lt;/a&gt;练习2&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;5-2.编写一个程序，使用O_APPEND标志并以写方式打开一个已存在的文件，且将文件偏移量置于文件起始处，再写入数据。数据会显示在文件中的哪个位置?为什么?&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>cha4.文件IO:通用的I/O模型</title>
    <link href="https://jingtianer.github.io/home/2023/03/22/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha4/"/>
    <id>https://jingtianer.github.io/home/2023/03/22/linux/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/cha4/</id>
    <published>2023-03-22T10:05:00.000Z</published>
    <updated>2023-03-22T02:40:51.697Z</updated>
    
    <content type="html"><![CDATA[<h2 id="实现tee"><a href="#实现tee" class="headerlink" title="实现tee"></a>实现tee</h2><blockquote><p>tee命令是从标准输入中读取数据，直至文件结尾，随后将数据写入标准输出和命令行参数所指定的文件。(44.7节讨论FIFO时，会展示使用tee命令的一个例子。)请使用IO系统调用实现tee命令。默认情况下，若已存在与命令行参数指定文件同名的文件，tee命令会将其覆盖。如文件已存在，请实现-a命令行选项<code>tee-a file</code>在文件结尾处追加数据。(请参考附录B中对getopt)函数的描述来解析命令行选项。</p></blockquote><h3 id="预处理与函数声明"><a href="#预处理与函数声明" class="headerlink" title="预处理与函数声明"></a>预处理与函数声明</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span> <span class="comment">// 使用变量errno</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> strcmp(a,b) strcmp(a,b)==0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// exit code</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNSUPPORTED_ARG 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_OPEN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDOUT_WRITE_FAIL 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDERR_WRITE_FAIL 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDIN_READ_FAIL 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTIAL_WRITE_OCCURED 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_CLOSE_FAIL 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_WRITE_FAIL 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * err, <span class="type">int</span> exitcode)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">release</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FILE_COUNT 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_BUFFER_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局资源</span></span><br><span class="line"><span class="type">char</span> **files = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> *fds = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> fileCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><blockquote><p>不引用c的库函数，直接使用系统调用对文件进行读写，不引入<code>stdio.h</code></p></blockquote><h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> success = close(fds[i]);</span><br><span class="line">        <span class="keyword">if</span>(success == <span class="number">-1</span>) &#123;</span><br><span class="line">            exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;can not close file: &quot;</span>, files[i]), FILE_CLOSE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(files);</span><br><span class="line">    <span class="built_in">free</span>(fds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Usage: tee [-ai][--help][--version][files...]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Written by Jingtian Meow\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * err, <span class="type">int</span> exitcode)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">    writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">    writeErr(errstr);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    writeErr(err);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    release();</span><br><span class="line">    <span class="built_in">exit</span>(exitcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDOUT_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        exitErr(<span class="string">&quot;fail to write to stdout\n&quot;</span>, STDOUT_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        release();</span><br><span class="line">        <span class="built_in">exit</span>(STDERR_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>实现错误打印，正常输出<ul><li>对于错误，利用系统调用write，写入文件fd<code>STDERR_FILENO</code>指代的标准错误流中</li><li>使用errno宏和strerror获取出错后的错误字符串，并打印其他提示信息</li></ul></li><li>实现资源释放</li></ul><h3 id="资源分配"><a href="#资源分配" class="headerlink" title="资源分配"></a>资源分配</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存文件名，打开文件的fd，文件总数</span></span><br><span class="line">files = (<span class="type">char</span> **)<span class="built_in">malloc</span>(MAX_FILE_COUNT*<span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">fds = (<span class="type">int</span> *)<span class="built_in">malloc</span>(MAX_FILE_COUNT*<span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">fileCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="参数处理"><a href="#参数处理" class="headerlink" title="参数处理"></a>参数处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="comment">// 参数处理结果</span></span><br><span class="line">    <span class="type">bool</span> append = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> ignore_int = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理参数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(argv[i][<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-a&quot;</span>)) &#123;</span><br><span class="line">                append = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-i&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--ignore-interrupts&quot;</span>)) &#123;</span><br><span class="line">                ignore_int = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-ai&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-ia&quot;</span>) ) &#123;</span><br><span class="line">                append = <span class="literal">true</span>;</span><br><span class="line">                ignore_int = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--help&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--version&quot;</span>)) &#123;</span><br><span class="line">                printVersion();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Unsupported arg: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">free</span>(files);</span><br><span class="line">                <span class="built_in">free</span>(fds);</span><br><span class="line">                <span class="built_in">exit</span>(UNSUPPORTED_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(fileCount &lt; MAX_FILE_COUNT<span class="number">-1</span>) files[fileCount++] = argv[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// other part of code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>支持参数<code>-a, --help, --version</code>，处理结果保存至<code>append</code>和<code>ignore_int</code></p><p>对于不是以<code>-</code>开头的参数，认为其是文件名，存储到<code>files</code></p><h3 id="打开文件"><a href="#打开文件" class="headerlink" title="打开文件"></a>打开文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开文件，保存fd</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">    fds[i] = open(files[i], O_CREAT | O_WRONLY | (append == <span class="literal">true</span> ? O_APPEND : O_TRUNC));</span><br><span class="line">    <span class="keyword">if</span>(fds[i] == <span class="number">-1</span>) &#123;</span><br><span class="line">        exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;Can not open file: &quot;</span>, argv[i]), FILE_OPEN_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>将<code>files</code>中的文件打开，存储其<code>fd</code></li></ul><h3 id="读取stdin，写入文件"><a href="#读取stdin，写入文件" class="headerlink" title="读取stdin，写入文件"></a>读取stdin，写入文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取stdin</span></span><br><span class="line"><span class="type">ssize_t</span> readSize = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> readBuffer[READ_BUFFER_SIZE+<span class="number">1</span>]; <span class="comment">// 需要手动添加&#x27;\0&#x27;， 故+1</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    readSize = read(STDIN_FILENO, readBuffer, READ_BUFFER_SIZE);</span><br><span class="line">    <span class="keyword">if</span>(readSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        exitErr(<span class="string">&quot;read stdin fail&quot;</span>, STDIN_READ_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(readSize == <span class="number">0</span>) &#123; <span class="comment">//EOF</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    readBuffer[readSize] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">//防止写入脏数据，但是write时有readSize限制，所以没必要</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ssize_t</span> writeSize = write(fds[i], readBuffer, readSize);</span><br><span class="line">        <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123; <span class="comment">//先判断-1</span></span><br><span class="line">            exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;file write failed on file: &quot;</span>, files[i]), FILE_WRITE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(writeSize &lt; readSize) &#123; <span class="comment">// 部分写</span></span><br><span class="line">            exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;Partial write occured on file: &quot;</span>, files[i]), PARTIAL_WRITE_OCCURED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>循环读取文件，利用系统调用<code>read</code>，若其返回0，则是遇到<code>eof</code>，跳出循环，若返回<code>-1</code>，则读取错误，异常退出</li><li>读取时注意该系统调用不认为读取的文件一定是文本文件，不会将其处理成字符串，即在末尾添加<code>&#39;\0&#39;</code>，需要手动添加</li><li>从stdin读取后，一次写入待写入的文件中，并判断是否成功，是否发生部分写</li></ul><h3 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">release();</span><br></pre></td></tr></table></figure><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span> <span class="comment">// 使用变量errno</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> strcmp(a,b) strcmp(a,b)==0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// exit code</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNSUPPORTED_ARG 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_OPEN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDOUT_WRITE_FAIL 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDERR_WRITE_FAIL 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDIN_READ_FAIL 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTIAL_WRITE_OCCURED 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_CLOSE_FAIL 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_WRITE_FAIL 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * err, <span class="type">int</span> exitcode)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">release</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FILE_COUNT 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_BUFFER_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> **files = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> *fds = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> fileCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="comment">// 参数处理结果</span></span><br><span class="line">    <span class="type">bool</span> append = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> ignore_int = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存文件名，打开文件的fd，文件总数</span></span><br><span class="line">    files = (<span class="type">char</span> **)<span class="built_in">malloc</span>(MAX_FILE_COUNT*<span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">    fds = (<span class="type">int</span> *)<span class="built_in">malloc</span>(MAX_FILE_COUNT*<span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    fileCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理参数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(argv[i][<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-a&quot;</span>)) &#123;</span><br><span class="line">                append = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-i&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--ignore-interrupts&quot;</span>)) &#123;</span><br><span class="line">                ignore_int = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-ai&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-ia&quot;</span>) ) &#123;</span><br><span class="line">                append = <span class="literal">true</span>;</span><br><span class="line">                ignore_int = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--help&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--version&quot;</span>)) &#123;</span><br><span class="line">                printVersion();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Unsupported arg: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">free</span>(files);</span><br><span class="line">                <span class="built_in">free</span>(fds);</span><br><span class="line">                <span class="built_in">exit</span>(UNSUPPORTED_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(fileCount &lt; MAX_FILE_COUNT<span class="number">-1</span>) files[fileCount++] = argv[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开文件，保存fd</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">        fds[i] = open(files[i], O_CREAT | O_WRONLY | (append == <span class="literal">true</span> ? O_APPEND : O_TRUNC));</span><br><span class="line">        <span class="keyword">if</span>(fds[i] == <span class="number">-1</span>) &#123;</span><br><span class="line">            exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;Can not open file: &quot;</span>, argv[i]), FILE_OPEN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取stdin</span></span><br><span class="line">    <span class="type">ssize_t</span> readSize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> readBuffer[READ_BUFFER_SIZE+<span class="number">1</span>]; <span class="comment">// 需要手动添加&#x27;\0&#x27;， 故+1</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        readSize = read(STDIN_FILENO, readBuffer, READ_BUFFER_SIZE);</span><br><span class="line">        <span class="keyword">if</span>(readSize == <span class="number">-1</span>) &#123;</span><br><span class="line">            exitErr(<span class="string">&quot;read stdin fail&quot;</span>, STDIN_READ_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(readSize == <span class="number">0</span>) &#123; <span class="comment">//EOF</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        readBuffer[readSize] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">//防止写入脏数据，但是write时有readSize限制，所以没必要</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">            errno = <span class="number">0</span>;</span><br><span class="line">            <span class="type">ssize_t</span> writeSize = write(fds[i], readBuffer, readSize);</span><br><span class="line">            <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123; <span class="comment">//先判断-1</span></span><br><span class="line">                exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;file write failed on file: &quot;</span>, files[i]), FILE_WRITE_FAIL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(writeSize &lt; readSize) &#123; <span class="comment">// 部分写</span></span><br><span class="line">                exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;Partial write occured on file: &quot;</span>, files[i]), PARTIAL_WRITE_OCCURED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    release();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> success = close(fds[i]);</span><br><span class="line">        <span class="keyword">if</span>(success == <span class="number">-1</span>) &#123;</span><br><span class="line">            exitErr(<span class="built_in">strcat</span>(<span class="string">&quot;can not close file: &quot;</span>, files[i]), FILE_CLOSE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(files);</span><br><span class="line">    <span class="built_in">free</span>(fds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Usage: tee [-ai][--help][--version][files...]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Written by Jingtian Meow\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exitErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * err, <span class="type">int</span> exitcode)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">    writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">    writeErr(errstr);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    writeErr(err);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    release();</span><br><span class="line">    <span class="built_in">exit</span>(exitcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDOUT_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        exitErr(<span class="string">&quot;fail to write to stdout\n&quot;</span>, STDOUT_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        release();</span><br><span class="line">        <span class="built_in">exit</span>(STDERR_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实现cp"><a href="#实现cp" class="headerlink" title="实现cp"></a>实现cp</h2><blockquote><p>编写一个类似于cp命令的程序，当使用该程序复制一个包含空洞(连续的空字节)的普通文件时，要求目标文件的空洞与源文件保持一致。</p></blockquote><ul><li>这道题走了一点弯路，一直在探索如何保存文件空洞，不能和上面程序一样<ul><li>由于空洞是程序在文件结尾处<code>lseek</code>了一段大于磁盘<code>blocksize</code>的距离后继续写入造成的，那么需要与其进行相同的<code>lseek</code>操作</li><li>如果读取出的内容全部为0，则记录全为0的长度，直到读取出不全为0的时候，先<code>lseek</code>，再写入</li><li>需要保证buffer的大小小于blocksize</li></ul></li></ul><h3 id="创建文件空洞"><a href="#创建文件空洞" class="headerlink" title="创建文件空洞"></a>创建文件空洞</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCKSIZE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeContent</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> * content)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = argc &gt;= <span class="number">2</span> ? open(argv[<span class="number">1</span>], O_WRONLY | O_CREAT) : STDOUT_FILENO;</span><br><span class="line">    <span class="type">int</span> fd1 = argc &gt;= <span class="number">2</span> ? open(<span class="built_in">strcat</span>(argv[<span class="number">1</span>],<span class="string">&quot;.normal&quot;</span>), O_WRONLY | O_CREAT) : STDOUT_FILENO;</span><br><span class="line">    <span class="type">int</span> holeNum = argc == <span class="number">3</span> ? atoi(argv[<span class="number">2</span>]) : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> *content;</span><br><span class="line">    <span class="type">char</span> blank[BLOCKSIZE*<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(blank, <span class="string">&#x27; &#x27;</span>, <span class="keyword">sizeof</span>(blank));</span><br><span class="line">    blank[BLOCKSIZE*<span class="number">2</span><span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; holeNum; i++) &#123;</span><br><span class="line">        content = <span class="string">&quot;Content before the file hole!!!!!\n&quot;</span>;</span><br><span class="line">        writeContent(fd, content);</span><br><span class="line">        writeContent(fd1, content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// make a hole</span></span><br><span class="line">        lseek(fd, BLOCKSIZE*<span class="number">2</span>, SEEK_CUR);</span><br><span class="line">        writeContent(fd1, blank);</span><br><span class="line"></span><br><span class="line">        content = <span class="string">&quot;Content after the file hole!!!!!\n&quot;</span>;</span><br><span class="line">        writeContent(fd, content);</span><br><span class="line">        writeContent(fd1, content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(close(fd1) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeContent</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span> * content)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> contentLen = <span class="built_in">strlen</span>(content) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(fd, content, contentLen);</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span> || writeSize &lt; contentLen) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>打开两个文件用作对比，fd通过lseek制造空洞，fd1写入相同大小的空格</li></ul><h3 id="使用命令stat比较生成的两个文件"><a href="#使用命令stat比较生成的两个文件" class="headerlink" title="使用命令stat比较生成的两个文件"></a>使用命令<code>stat</code>比较生成的两个文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@tt-surfacepro6:~/linux<span class="comment"># stat -c %b abc</span></span><br><span class="line">16</span><br></pre></td></tr></table></figure><p>abc的块数是16</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@tt-surfacepro6:~/linux<span class="comment"># stat -c %b abc.normal </span></span><br><span class="line">24</span><br></pre></td></tr></table></figure><p>abc.normal的块数的24</p><h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> strcmp(a,b) strcmp(a,b)==0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// exit code</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNSUPPORTED_ARG 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_OPEN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDOUT_WRITE_FAIL 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDERR_WRITE_FAIL 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDIN_READ_FAIL 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTIAL_WRITE_OCCURED 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_CLOSE_FAIL 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_WRITE_FAIL 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_READ_FAIL 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARG 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fileErrClose</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * filename, <span class="type">const</span> <span class="type">char</span> *err, <span class="type">int</span> exitCode)</span>; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_BUFF_SIZE 1023</span></span><br></pre></td></tr></table></figure><h3 id="工具函数-1"><a href="#工具函数-1" class="headerlink" title="工具函数"></a>工具函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">fileErrClose</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * filename, <span class="type">const</span> <span class="type">char</span> *err, <span class="type">int</span> exitCode)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">    writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">    writeErr(errstr);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    writeErr(err);</span><br><span class="line">    writeErr(filename);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(exitCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Usage: cp [--help][--version][src dest]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Written by Jingtian Meow\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDOUT_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">        writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">        writeErr(errstr);</span><br><span class="line">        writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        writeErr(<span class="string">&quot;fail to write to stdout\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(STDOUT_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(STDERR_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="参数处理-1"><a href="#参数处理-1" class="headerlink" title="参数处理"></a>参数处理</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="comment">// src文件，dest文件</span></span><br><span class="line">    <span class="type">char</span> *filesrc = <span class="literal">NULL</span>, *filedest = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理参数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(argv[i][<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--help&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-h&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--version&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-v&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Unsupported arg: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(UNSUPPORTED_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(filesrc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                filesrc = argv[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(filedest == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                filedest = argv[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Invalid arguments: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(INVALID_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// other part ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不允许<code>-r</code>等操作，只允许对文件进行复制</p><h3 id="文件打开"><a href="#文件打开" class="headerlink" title="文件打开"></a>文件打开</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> srcFd = open(filesrc, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span>(srcFd == <span class="number">-1</span>) &#123;</span><br><span class="line">    fileErrClose(filesrc, <span class="string">&quot;Can not open file: &quot;</span>, FILE_OPEN_FAIL);</span><br><span class="line">&#125;</span><br><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> descFd = open(filedest, O_WRONLY | O_TRUNC | O_CREAT);</span><br><span class="line"><span class="keyword">if</span>(descFd == <span class="number">-1</span>) &#123;</span><br><span class="line">    fileErrClose(filedest, <span class="string">&quot;Can not open file: &quot;</span>, FILE_OPEN_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分别打开输入和输出文件</p><h3 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> * readBuffer[READ_BUFF_SIZE+<span class="number">1</span>];</span><br><span class="line"><span class="type">char</span> allzero[READ_BUFF_SIZE+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">off_t</span> offdest = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">ssize_t</span> readSize = read(srcFd, readBuffer, READ_BUFF_SIZE);</span><br><span class="line">    <span class="keyword">if</span>(readSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filesrc, <span class="string">&quot;Can not read file: &quot;</span>, FILE_READ_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;readsize = %ld\n&quot;</span>, readSize);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(readSize == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">        writeStdout(<span class="string">&quot;Read finish\n&quot;</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    readBuffer[readSize] = <span class="number">0</span>;</span><br><span class="line">    offdest += readSize;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(readBuffer, allzero, readSize) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hole, readsize = %ld, off = %ld\n&quot;</span>, readSize, offdest);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(offdest &gt; <span class="number">0</span>)lseek(descFd, offdest, SEEK_CUR);</span><br><span class="line">    offdest = <span class="number">0</span>;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(descFd, readBuffer, readSize);</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filedest, <span class="string">&quot;Write Fail on file: &quot;</span>, FILE_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(writeSize &lt; readSize) &#123;</span><br><span class="line">        fileErrClose(filedest, <span class="string">&quot;Partial write occured on file: &quot;</span>, PARTIAL_WRITE_OCCURED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>当某次读出数据全为0时，则此处是空洞，记录空洞的累计长度</li><li>直到某次读取不全为0时，空洞结束，先lseek空洞长度，再写入</li></ul><h3 id="善后"><a href="#善后" class="headerlink" title="善后"></a>善后</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(close(srcFd) == <span class="number">-1</span>) &#123;</span><br><span class="line">    fileErrClose(filesrc, <span class="string">&quot;Can not close file: &quot;</span>, FILE_CLOSE_FAIL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(close(descFd) == <span class="number">-1</span>) &#123;</span><br><span class="line">    fileErrClose(filedest, <span class="string">&quot;Can not close file: &quot;</span>, FILE_CLOSE_FAIL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h3 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc cp.c -o <span class="built_in">cp</span> &amp;&amp; ./cp abc abc.cp</span><br><span class="line"><span class="built_in">stat</span> -c %b abc.cp</span><br></pre></td></tr></table></figure><p>编译该cp工具，使用它复制带有空洞文件，可发现其成功复制，并输出块数也为16</p><h3 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bool char</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> false 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> true 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> strcmp(a,b) strcmp(a,b)==0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// exit code</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNSUPPORTED_ARG 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_OPEN_FAIL 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDOUT_WRITE_FAIL 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDERR_WRITE_FAIL 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STDIN_READ_FAIL 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTIAL_WRITE_OCCURED 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_CLOSE_FAIL 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_WRITE_FAIL 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILE_READ_FAIL 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_ARG 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fileErrClose</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * filename, <span class="type">const</span> <span class="type">char</span> *err, <span class="type">int</span> exitCode)</span>; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_BUFF_SIZE 1023</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="comment">// src文件，dest文件</span></span><br><span class="line">    <span class="type">char</span> *filesrc = <span class="literal">NULL</span>, *filedest = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理参数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(argv[i][<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--help&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-h&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--version&quot;</span>) || <span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;-v&quot;</span>)) &#123;</span><br><span class="line">                printHelp();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Unsupported arg: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(UNSUPPORTED_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(filesrc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                filesrc = argv[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(filedest == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                filedest = argv[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                writeErr(<span class="string">&quot;Invalid arguments: &quot;</span>);</span><br><span class="line">                writeErr(argv[i]);</span><br><span class="line">                writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(INVALID_ARG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> srcFd = open(filesrc, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(srcFd == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filesrc, <span class="string">&quot;Can not open file: &quot;</span>, FILE_OPEN_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> descFd = open(filedest, O_WRONLY | O_TRUNC | O_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(descFd == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filedest, <span class="string">&quot;Can not open file: &quot;</span>, FILE_OPEN_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> * readBuffer[READ_BUFF_SIZE+<span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> allzero[READ_BUFF_SIZE+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">off_t</span> offdest = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ssize_t</span> readSize = read(srcFd, readBuffer, READ_BUFF_SIZE);</span><br><span class="line">        <span class="keyword">if</span>(readSize == <span class="number">-1</span>) &#123;</span><br><span class="line">            fileErrClose(filesrc, <span class="string">&quot;Can not read file: &quot;</span>, FILE_READ_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;readsize = %ld\n&quot;</span>, readSize);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span>(readSize == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">            writeStdout(<span class="string">&quot;Read finish\n&quot;</span>);</span><br><span class="line">            <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        readBuffer[readSize] = <span class="number">0</span>;</span><br><span class="line">        offdest += readSize;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">memcmp</span>(readBuffer, allzero, readSize) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">ifdef</span> debug</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;hole, readsize = %ld, off = %ld\n&quot;</span>, readSize, offdest);</span><br><span class="line">            <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(offdest &gt; <span class="number">0</span>)lseek(descFd, offdest, SEEK_CUR);</span><br><span class="line">        offdest = <span class="number">0</span>;</span><br><span class="line">        errno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> writeSize = write(descFd, readBuffer, readSize);</span><br><span class="line">        <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">            fileErrClose(filedest, <span class="string">&quot;Write Fail on file: &quot;</span>, FILE_WRITE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(writeSize &lt; readSize) &#123;</span><br><span class="line">            fileErrClose(filedest, <span class="string">&quot;Partial write occured on file: &quot;</span>, PARTIAL_WRITE_OCCURED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(close(srcFd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filesrc, <span class="string">&quot;Can not close file: &quot;</span>, FILE_CLOSE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(close(descFd) == <span class="number">-1</span>) &#123;</span><br><span class="line">        fileErrClose(filedest, <span class="string">&quot;Can not close file: &quot;</span>, FILE_CLOSE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fileErrClose</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * filename, <span class="type">const</span> <span class="type">char</span> *err, <span class="type">int</span> exitCode)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">    writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">    writeErr(errstr);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    writeErr(err);</span><br><span class="line">    writeErr(filename);</span><br><span class="line">    writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(exitCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printHelp</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Usage: cp [--help][--version][src dest]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">printVersion</span><span class="params">()</span> &#123;</span><br><span class="line">    writeStdout(<span class="string">&quot;Written by Jingtian Meow\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeStdout</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDOUT_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="type">char</span> *errstr = strerror(errno);</span><br><span class="line">        writeErr(<span class="string">&quot;Error: &quot;</span>);</span><br><span class="line">        writeErr(errstr);</span><br><span class="line">        writeErr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        writeErr(<span class="string">&quot;fail to write to stdout\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(STDOUT_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeErr</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> writeSize = write(STDERR_FILENO, str, <span class="built_in">strlen</span>(str));</span><br><span class="line">    <span class="keyword">if</span>(writeSize == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(STDERR_WRITE_FAIL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;实现tee&quot;&gt;&lt;a href=&quot;#实现tee&quot; class=&quot;headerlink&quot; title=&quot;实现tee&quot;&gt;&lt;/a&gt;实现tee&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;tee命令是从标准输入中读取数据，直至文件结尾，随后将数据写入标准输出和命令行参数所指定的文件。(44.7节讨论FIFO时，会展示使用tee命令的一个例子。)请使用IO系统调用实现tee命令。默认情况下，若已存在与命令行参数指定文件同名的文件，tee命令会将其覆盖。如文件已存在，请实现-a命令行选项&lt;code&gt;tee-a file&lt;/code&gt;在文件结尾处追加数据。(请参考附录B中对getopt)函数的描述来解析命令行选项。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;预处理与函数声明&quot;&gt;&lt;a href=&quot;#预处理与函数声明&quot; class=&quot;headerlink&quot; title=&quot;预处理与函数声明&quot;&gt;&lt;/a&gt;预处理与函数声明&lt;/h3&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;sys/stat.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;fcntl.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;&amp;lt;errno.h&amp;gt;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;// 使用变量errno&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; bool char&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; false 0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; true 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; strcmp(a,b) strcmp(a,b)==0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// exit code&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; UNSUPPORTED_ARG 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; FILE_OPEN_FAIL 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; STDOUT_WRITE_FAIL 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; STDERR_WRITE_FAIL 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; STDIN_READ_FAIL 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; PARTIAL_WRITE_OCCURED 6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; FILE_CLOSE_FAIL 7&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; FILE_WRITE_FAIL 8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 函数声明&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;printHelp&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;printVersion&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;writeErr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt;* str)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;writeStdout&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt;* str)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;exitErr&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;type&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; * err, &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; exitcode)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title function_&quot;&gt;release&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 常量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; MAX_FILE_COUNT 100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;keyword&quot;&gt;define&lt;/span&gt; READ_BUFFER_SIZE 100&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 全局资源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt; **files = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; *fds = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; fileCount = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;不引用c的库函数，直接使用系统调用对文件进行读写，不引入&lt;code&gt;stdio.h&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;工具函数&quot;&gt;&lt;a href=&quot;#工具函数&quot; class=&quot;headerlink&quot; title=&quot;工具函数&quot;&gt;&lt;/a&gt;工具函数&lt;/h3&gt;</summary>
    
    
    
    <category term="linux" scheme="https://jingtianer.github.io/home/categories/linux/"/>
    
    
    <category term="Linux/UNIX系统编程手册" scheme="https://jingtianer.github.io/home/tags/Linux-UNIX%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E6%89%8B%E5%86%8C/"/>
    
  </entry>
  
  <entry>
    <title>十一周记录</title>
    <link href="https://jingtianer.github.io/home/2023/03/21/%E7%BB%84%E4%BC%9A/%E5%8D%81%E4%B8%80%E5%91%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://jingtianer.github.io/home/2023/03/21/%E7%BB%84%E4%BC%9A/%E5%8D%81%E4%B8%80%E5%91%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2023-03-21T04:15:37.000Z</published>
    <updated>2023-03-28T00:59:29.606Z</updated>
    
    <content type="html"><![CDATA[<h2 id="fuzz旧版本bind"><a href="#fuzz旧版本bind" class="headerlink" title="fuzz旧版本bind"></a>fuzz旧版本bind</h2><table><thead><tr><th>版本号</th><th>来源</th><th>fuzzed_app</th></tr></thead><tbody><tr><td>9.16.39</td><td>release</td><td>dns_rdata_fromwire_text</td></tr></tbody></table><h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><ul><li>问题1:</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dns_rdata_fromwire_text.lto.o:ld-temp.o:<span class="keyword">function</span> LLVMFuzzerTestOneInput: error: undefined reference to <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">dns_rdata_fromwire_text.lto.o:ld-temp.o:<span class="keyword">function</span> LLVMFuzzerTestOneInput: error: undefined reference to <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">dns_rdata_fromwire_text.lto.o:ld-temp.o:<span class="keyword">function</span> nullmsg: error: undefined reference to <span class="string">&#x27;debug&#x27;</span></span><br></pre></td></tr></table></figure><p>在文件<code>bind9/fuzz/dns_rdata_fromwire_text.c</code>下，定义了外部变量<code>debug</code>，但是该文件并没有与其他文件链接，改为该文件中的全局变量</p><ul><li>问题2:<br>make install时，filter-aaaa.so文件编译出错，去对应的文件夹下找不到该文件，说明编译失败了<br>分析：</li><li>在该文件夹下手动编译该文件，可以正常编译，生产.so文件，且通过make生产的文件缺少运行权限</li><li>通过手动编译该文件，继续make，可以顺利继续编译，并且所有so都存在相同问题<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/home/ubuntu/build/llvm_tools/build-llvm/msan/aflgo/afl-clang-fast -Wl,--export-dynamic -shared -o <span class="variable">$@</span> filter-aaaa.o </span><br><span class="line">/home/ubuntu/build/llvm_tools/build-llvm/msan/aflgo/afl-clang-fast -Wl,--export-dynamic -shared -o filter-aaaa.so filter-aaaa.o</span><br></pre></td></tr></table></figure></li></ul><p>解决：</p><ul><li>手动对so库编译</li></ul><h3 id="挖掘情况"><a href="#挖掘情况" class="headerlink" title="挖掘情况"></a>挖掘情况</h3><p>aflgo挖的很快，在第4分钟时就出了一个crash</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">               american fuzzy lop 2.52b (dns_rdata_fromwire_text)</span><br><span class="line"></span><br><span class="line">┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐</span><br><span class="line">│        run time : 0 days, 7 hrs, 48 min, 9 sec       │  cycles <span class="keyword">done</span> : 0      │</span><br><span class="line">│   last new path : 0 days, 0 hrs, 1 min, 30 sec       │  total paths : 820    │</span><br><span class="line">│ last <span class="built_in">uniq</span> crash : 0 days, 0 hrs, 23 min, 20 sec      │ <span class="built_in">uniq</span> crashes : 14     │</span><br><span class="line">│  last <span class="built_in">uniq</span> hang : none seen yet                      │   <span class="built_in">uniq</span> hangs : 0      │</span><br><span class="line">├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤</span><br><span class="line">│  now processing : 169 (20.61%)      │    map density : 1.88% / 15.43%        │</span><br><span class="line">│ paths timed out : 0 (0.00%)         │ count coverage : 1.67 bits/tuple       │</span><br><span class="line">├─ stage progress ────────────────────┼─ findings <span class="keyword">in</span> depth ────────────────────┤</span><br><span class="line">│  now trying : havoc                 │ favored paths : 300 (36.59%)           │</span><br><span class="line">│ stage execs : 4070/6552 (62.12%)    │  new edges on : 394 (48.05%)           │</span><br><span class="line">│ total execs : 844k                  │ total crashes : 62 (14 unique)         │</span><br><span class="line">│  <span class="built_in">exec</span> speed : 37.74/sec (slow!)     │  total tmouts : 808 (19 unique)        │</span><br><span class="line">├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤</span><br><span class="line">│   bit flips : 25/72.1k, 22/72.0k, 15/72.0k          │    levels : 5          │</span><br><span class="line">│  byte flips : 1/9007, 0/2844, 1/2838                │   pending : 794        │</span><br><span class="line">│ arithmetics : 102/157k, 2/55.1k, 0/10.3k            │  pend fav : 285        │</span><br><span class="line">│  known ints : 3/16.1k, 2/73.4k, 6/121k              │ own finds : 727        │</span><br><span class="line">│  dictionary : 0/0, 0/0, 0/0                         │  imported : n/a        │</span><br><span class="line">│       havoc : 561/165k, 0/0                         │ stability : 99.90%     │</span><br><span class="line">│        trim : 63.40%/4616, 67.84%                   ├────────────────────────┘</span><br><span class="line">^C────────────────────────────────────────────────────┘          [cpu002: 87%]</span><br></pre></td></tr></table></figure><p>转到服务器上，cpu核心多一点，可以并行挖。10小时挖出41+75+77+71</p><h2 id="对named-fuzz"><a href="#对named-fuzz" class="headerlink" title="对named fuzz"></a>对named fuzz</h2><table><thead><tr><th>版本号</th><th>来源</th><th>fuzzed_app</th></tr></thead><tbody><tr><td>9.15.0</td><td>release</td><td>named</td></tr></tbody></table><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>如何调试<ul><li>先直接运行named，通过<code>-g</code>参数显示debug信息</li><li><code>-L logfile</code>，可以指定log文件的输出位置，经过实践，在我写的脚本里似乎无论如何都输出不了，用shell却可以</li></ul></li><li>如何fuzz<ul><li>使用参数<code>-A</code>，从<code>bind9/bin/named/fuzz.c</code>的代码注释中了解到的，可以指定named的角色</li><li>使用参数<code>-c</code>可指定配置文件，配合<code>@@</code>占位，可以将afl输入作为配置文件，但是-c是指定配置文件的路径而非内容</li></ul></li><li>named配置文件<ul><li>使用<code>-c</code>可指定配置文件</li><li>如果使用<code>-A</code>进行fuzz，需要手动配置其配置文件，只需一个空文件即可。</li></ul></li></ul><h3 id="A参数"><a href="#A参数" class="headerlink" title="-A参数"></a>-A参数</h3><h4 id="lt-mode-gt-lt-address-gt-lt-port-gt"><a href="#lt-mode-gt-lt-address-gt-lt-port-gt" class="headerlink" title="&lt;mode&gt;:&lt;address&gt;:&lt;port&gt;"></a>&lt;mode&gt;:&lt;address&gt;:&lt;port&gt;</h4><p>这个参数从标准输入中读取AFL中的测试用例，查询blobs，并将其发送到指定的相应tcp侦听端口</p><ul><li>mode可选<ul><li>tcp</li><li>http</li><li>rndc</li></ul></li></ul><h4 id="client-lt-address-gt-lt-port-gt"><a href="#client-lt-address-gt-lt-port-gt" class="headerlink" title="client:&lt;address&gt;:&lt;port&gt;"></a>client:&lt;address&gt;:&lt;port&gt;</h4><p>创建线程从标准输入读取AFL的模糊查询消息，并将其发送到named的监听端口(DNS)</p><h4 id="resolver-lt-saddress-gt-lt-sport-gt-lt-raddress-gt-lt-rport-gt"><a href="#resolver-lt-saddress-gt-lt-sport-gt-lt-raddress-gt-lt-rport-gt" class="headerlink" title="resolver:&lt;saddress&gt;:&lt;sport&gt;:&lt;raddress&gt;:&lt;rport&gt;"></a>resolver:&lt;saddress&gt;:&lt;sport&gt;:&lt;raddress&gt;:&lt;rport&gt;</h4><p>创建线程从标准输入中读取AFL中的模糊消息，将侦听器设置为远程。</p><ul><li><p>&lt;raddress&gt;:&lt;rport&gt;会通过root zone配置为aaaaaaaaaaa .example的权限服务器。</p></li><li><p>&lt;saddress&gt;:&lt;sport&gt;为named监听的socket</p></li></ul><h3 id="问题解决-1"><a href="#问题解决-1" class="headerlink" title="问题解决"></a>问题解决</h3><h4 id="A-resolver-127-0-0-1-4444-127-0-0-1-3333"><a href="#A-resolver-127-0-0-1-4444-127-0-0-1-3333" class="headerlink" title="-A resolver:127.0.0.1:4444:127.0.0.1:3333"></a>-A resolver:127.0.0.1:4444:127.0.0.1:3333</h4><ul><li><p>&#x2F;home&#x2F;ubuntu&#x2F;dnsenv&#x2F;aflgo-workdir&#x2F;bind9-16-39-named&#x2F;bind9&#x2F;bin&#x2F;named&#x2F;.libs&#x2F;named: symbol lookup error: &#x2F;home&#x2F;ubuntu&#x2F;dnsenv&#x2F;aflgo-workdir&#x2F;bind9-16-39-named&#x2F;bind9&#x2F;bin&#x2F;named&#x2F;.libs&#x2F;named: undefined symbol: dns_resolver_setfuzzing</p><ul><li>通过全局搜索，该函数定义位于<code>bind9/lib/dns/resolver.c</code>下，但是我已经在LD_LIBRARY_PATH中指定了该目录，该函数需要宏定义<code>ENABLE_AFL</code></li><li>因为fuzz的是<code>9.15.0</code>，怀疑其<code>Makefile</code>生成有误，或者当时版本并不支持在<code>./config</code>时加入参数<code>--enable-fuzz=afl</code></li><li>在编译参数<code>$CFLAGS</code>中添加条件编译参数<code>-D ENABLE_AFL</code>重新编译插装，可以正常运行</li></ul></li><li><p>权限问题：24-Mar-2023 09:55:55.273 general: info: generating session key for dynamic DNS<br>24-Mar-2023 09:55:55.273 general: warning: could not open file ‘&#x2F;usr&#x2F;local&#x2F;var&#x2F;run&#x2F;named&#x2F;session.key’: Permission denied</p><ul><li>用su运行</li></ul></li><li><p>24-Mar-2023 10:52:01.158 general: critical: unable to signal parent that we otherwise started successfully.</p><ul><li>因为这个问题，找不到解决方法，还在尝试</li></ul></li></ul><h4 id="A-client-127-0-0-1-4444"><a href="#A-client-127-0-0-1-4444" class="headerlink" title="-A client:127.0.0.1:4444"></a>-A client:127.0.0.1:4444</h4><ul><li>有了前面的铺垫，这个模式顺利运行起来了，并在40s时挖出了2个漏洞</li></ul><p>挖了1分8秒，出了5个crash，但是OOM了，这个时候我同时开了四个进程并行挖<code>dns_rdata_fromwire_text</code></p><p>并且同时观察到，通过 <code>ps -ef | grep named</code>，发现在fuzz过程中，除了<code>aflgo</code>的进程外，内存中还有大量的<code>named -A client:xxxx:xxxx</code></p><p>通过<code>ps -ef  | grep -e $STOP | wc -l</code>统计行数，发现named的数目是越来越多的，这应该就是oom的原因，但不知是否是crash的原因</p><h2 id="crash分析"><a href="#crash分析" class="headerlink" title="crash分析"></a>crash分析</h2><h3 id="named服务"><a href="#named服务" class="headerlink" title="named服务"></a>named服务</h3><h4 id="hexdump查看16进制内容"><a href="#hexdump查看16进制内容" class="headerlink" title="hexdump查看16进制内容"></a>hexdump查看16进制内容</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C <span class="built_in">id</span>\:xxxxx,xxxxx,xxxxx</span><br><span class="line">00000000  1b                                                |.|</span><br><span class="line">00000001</span><br></pre></td></tr></table></figure><p>确实都是这样无意义的输出，应该就是过多进程导致的OOM。</p><h3 id="dns-rdata-fromwire-text"><a href="#dns-rdata-fromwire-text" class="headerlink" title="dns_rdata_fromwire_text"></a>dns_rdata_fromwire_text</h3><h4 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h4><p>经过手工查看，发现也是没有什么含义的内容</p><h4 id="crash直接作为输入"><a href="#crash直接作为输入" class="headerlink" title="crash直接作为输入"></a>crash直接作为输入</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> crashfile | fuzzed_app</span><br><span class="line">cannot execute binary file: Exec format error</span><br></pre></td></tr></table></figure><p>直接这样做不可行，换种方法，把crash输入未插桩的同版本的同一个测试程序中，得到报错为&#96;&#96;</p><p>mem.c:871: fatal error: RUNTIME_CHECK(((pthread_mutex_lock(((&amp;contextslock))) &#x3D;&#x3D; 0) ? 0 : 34) &#x3D;&#x3D; 0) failed<br>Aborted</p><h4 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h4><ul><li>先不设置断点，直接运行</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@VM-0-4-ubuntu:~/dnsenv/crash_analyze$ LD_LIBRARY_PATH=<span class="variable">$SUBJECT</span>/lib/isc/.libs:<span class="variable">$SUBJECT</span>/lib/dns/.libs:<span class="variable">$SUBJECT</span>/lib/isccc/.libs:<span class="variable">$SUBJECT</span>/lib/isccfg/.libs gdb  <span class="variable">$SUBJECT</span>/fuzz/dns_rdata_fromwire_text</span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text...done.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text </span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">testing 2 bytes from /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text.in/id:000022,8867894,sig:06,src:000445,op:havoc,rep:128</span><br><span class="line">mem.c:871: fatal error: RUNTIME_CHECK(((pthread_mutex_lock(((&amp;contextslock))) == 0) ? 0 : 34) == 0) failed</span><br><span class="line"></span><br><span class="line">Program received signal SIGABRT, Aborted.</span><br><span class="line">0x00007ffff6f4a438 <span class="keyword">in</span> __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54</span><br><span class="line">54      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.</span><br></pre></td></tr></table></figure><ul><li>找到报错位于<code>/lib/x86_64-linux-gnu/libthread_db.so.1</code>下的RUNTIME_CHECK中找到该行，导致崩溃的函数是EnterCriticalSection，剩下的东西还没看完</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;fuzz旧版本bind&quot;&gt;&lt;a href=&quot;#fuzz旧版本bind&quot; class=&quot;headerlink&quot; title=&quot;fuzz旧版本bind&quot;&gt;&lt;/a&gt;fuzz旧版本bind&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;版本号&lt;/th&gt;
&lt;th&gt;来源&lt;/th&gt;
&lt;th&gt;fuzzed_app&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;9.16.39&lt;/td&gt;
&lt;td&gt;release&lt;/td&gt;
&lt;td&gt;dns_rdata_fromwire_text&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h3 id=&quot;问题解决&quot;&gt;&lt;a href=&quot;#问题解决&quot; class=&quot;headerlink&quot; title=&quot;问题解决&quot;&gt;&lt;/a&gt;问题解决&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;问题1:&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dns_rdata_fromwire_text.lto.o:ld-temp.o:&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; LLVMFuzzerTestOneInput: error: undefined reference to &lt;span class=&quot;string&quot;&gt;&amp;#x27;debug&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dns_rdata_fromwire_text.lto.o:ld-temp.o:&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; LLVMFuzzerTestOneInput: error: undefined reference to &lt;span class=&quot;string&quot;&gt;&amp;#x27;debug&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dns_rdata_fromwire_text.lto.o:ld-temp.o:&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; nullmsg: error: undefined reference to &lt;span class=&quot;string&quot;&gt;&amp;#x27;debug&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;在文件&lt;code&gt;bind9/fuzz/dns_rdata_fromwire_text.c&lt;/code&gt;下，定义了外部变量&lt;code&gt;debug&lt;/code&gt;，但是该文件并没有与其他文件链接，改为该文件中的全局变量&lt;/p&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-24</title>
    <link href="https://jingtianer.github.io/home/2023/03/18/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9324/"/>
    <id>https://jingtianer.github.io/home/2023/03/18/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9324/</id>
    <published>2023-03-18T03:14:34.000Z</published>
    <updated>2023-03-19T08:43:39.589Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1616-分割两个字符串得到回文串"><a href="#1616-分割两个字符串得到回文串" class="headerlink" title="1616. 分割两个字符串得到回文串"></a>1616. 分割两个字符串得到回文串</h2><h3 id="ac代码"><a href="#ac代码" class="headerlink" title="ac代码"></a>ac代码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkPalindromeFormation</span><span class="params">(string a, string b)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = a.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">bool</span> flaga = <span class="literal">true</span>, flagb = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(a[i] == b[len<span class="number">-1</span>-i]) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = i; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(b[j] != b[len<span class="number">-1</span>-j]) &#123;</span><br><span class="line">                flagb = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = i; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(a[j] != a[len<span class="number">-1</span>-j]) &#123;</span><br><span class="line">                flaga = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flaga || flagb) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        flaga = flagb = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(a[len<span class="number">-1</span>-i] == b[i]) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = i; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(a[j] != a[len<span class="number">-1</span>-j]) &#123;</span><br><span class="line">                flaga = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = i; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(b[j] != b[len<span class="number">-1</span>-j]) &#123;</span><br><span class="line">                flagb = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flaga || flagb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>ab两个字符串在同一个位置分隔开，若 $ pre_a + suf_b $ 或 $ pre_b + suf_a $ 是回文串，则返回true，否则返回false<br>这个规则相当于ab截取相同且任意长的前缀并交换，看交换后是否存在回文<br>我的思路是先比较a的第i位与b的倒数第i位是否想等，找到第一次不相等的位置i，此时可以从第i位分割，判断b的剩余部分是否是回文，或者从len-i-1处分割，判断a的剩余部分是否是回文<br>若都不是，再比较b的第i位与a的倒数i位，找到第一个不满足的i，再比较a，b的剩余部分</p></blockquote><h3 id="优化行数"><a href="#优化行数" class="headerlink" title="优化行数"></a>优化行数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkPalindromeFormation</span><span class="params">(string a, string b)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = a.<span class="built_in">length</span>();</span><br><span class="line">        <span class="type">int</span> paliA = len/<span class="number">2</span><span class="number">-1</span>, paliB = len/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span>(paliA &gt; <span class="number">0</span> &amp;&amp; a[paliA] == a[len<span class="number">-1</span>-paliA]) paliA--;</span><br><span class="line">        <span class="keyword">while</span>(paliB &gt; <span class="number">0</span> &amp;&amp; b[paliB] == b[len<span class="number">-1</span>-paliB]) paliB--;</span><br><span class="line">        <span class="type">int</span> i, j;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len/<span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(a[i] != b[len<span class="number">-1</span>-i]) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; len/<span class="number">2</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(b[j] != a[len<span class="number">-1</span>-j]) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(paliA, paliB) &lt; <span class="built_in">max</span>(i, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>最大的情况下执行$2*len$次</p></blockquote><h2 id="2389-和有限的最长子序列"><a href="#2389-和有限的最长子序列" class="headerlink" title="2389. 和有限的最长子序列"></a><a href="https://leetcode.cn/problems/longest-subsequence-with-limited-sum/description/">2389. 和有限的最长子序列</a></h2><h3 id="艺术就是派大星"><a href="#艺术就是派大星" class="headerlink" title="艺术就是派大星"></a>艺术就是派大星</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">answerQueries</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, vector&lt;<span class="type">int</span>&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; answer;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(), m = queries.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(sum + nums[j] &lt;= queries[i]) &#123;</span><br><span class="line">                    count ++;</span><br><span class="line">                    sum += nums[j];                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            answer.<span class="built_in">push_back</span>(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">answerQueries</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, vector&lt;<span class="type">int</span>&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; answer;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(), m = queries.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            nums[j] += nums[j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="type">int</span> count = <span class="built_in">upper_bound</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), queries[i]) - nums.<span class="built_in">begin</span>();</span><br><span class="line">            answer.<span class="built_in">push_back</span>(count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="手写upper-bound"><a href="#手写upper-bound" class="headerlink" title="手写upper_bound()"></a>手写upper_bound()</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">answerQueries</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, vector&lt;<span class="type">int</span>&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; answer;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(), m = queries.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            nums[j] += nums[j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="type">int</span> l = <span class="number">0</span>, r = n;</span><br><span class="line">            <span class="keyword">while</span>(l &lt; r) &#123;</span><br><span class="line">                <span class="type">int</span> mid = l + (r - l) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span>(nums[mid] &gt; queries[i]) &#123;</span><br><span class="line">                    r = mid;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    l = mid+<span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            answer.<span class="built_in">push_back</span>(l);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1615-最大网络秩"><a href="#1615-最大网络秩" class="headerlink" title="1615. 最大网络秩"></a><a href="https://leetcode.cn/problems/maximal-network-rank/description/">1615. 最大网络秩</a></h2><h3 id="暴力"><a href="#暴力" class="headerlink" title="暴力"></a>暴力</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximalNetworkRank</span><span class="params">(<span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; roads)</span> </span>&#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">bool</span>&gt;&gt; <span class="built_in">mat</span>(n, <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n, <span class="literal">false</span>));</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">count</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; r : roads) &#123;</span><br><span class="line">            mat[r[<span class="number">0</span>]][r[<span class="number">1</span>]] = <span class="literal">true</span>;</span><br><span class="line">            mat[r[<span class="number">1</span>]][r[<span class="number">0</span>]] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> max_a = <span class="number">0</span>, max_b = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> max_i = <span class="number">0</span>, max_j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(mat[i][j]) &#123;</span><br><span class="line">                    count[i]++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(count[i] &gt;= max_a) &#123;</span><br><span class="line">                max_b = max_a;</span><br><span class="line">                max_a = count[i];</span><br><span class="line">                max_j = max_i;</span><br><span class="line">                max_i = i;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(count[i] &gt; max_b)&#123;</span><br><span class="line">                max_b = count[i];</span><br><span class="line">                max_j = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = i+<span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(((max_a == count[i] &amp;&amp; max_b == count[j])||(max_b == count[i] &amp;&amp; max_a == count[j])) &amp;&amp; !mat[i][j]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> max_a + max_b;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max_a + max_b - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>先统计每个城市的道路数，找到最大的两个，然后查找在所有等于最大两个道路数的城市组合中，有无没有边的组合，否则就减一</p></blockquote><h3 id="优化后续查找"><a href="#优化后续查找" class="headerlink" title="优化后续查找"></a>优化后续查找</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maximalNetworkRank</span><span class="params">(<span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; roads)</span> </span>&#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">bool</span>&gt;&gt; <span class="built_in">mat</span>(n, <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n, <span class="literal">false</span>));</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">count</span><span class="params">(n)</span>, <span class="title">index</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; r : roads) &#123;</span><br><span class="line">            mat[r[<span class="number">0</span>]][r[<span class="number">1</span>]] = <span class="literal">true</span>;</span><br><span class="line">            mat[r[<span class="number">1</span>]][r[<span class="number">0</span>]] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(mat[i][j]) &#123;</span><br><span class="line">                    count[i]++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            index[i] = i;</span><br><span class="line">            mat[i][i] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sort</span>(index.<span class="built_in">begin</span>(), index.<span class="built_in">end</span>(), [&amp;](<span class="type">int</span> a, <span class="type">int</span> b)-&gt;<span class="type">bool</span>&#123;<span class="keyword">return</span> count[a] &lt; count[b];&#125;);</span><br><span class="line">        <span class="type">int</span> x = n<span class="number">-1</span>,y = n<span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">while</span>(x &gt;= <span class="number">0</span> &amp;&amp; count[index[x]] == count[index[n<span class="number">-1</span>]]) &#123;</span><br><span class="line">            y = x<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">while</span>(y &gt;= <span class="number">0</span> &amp;&amp; count[index[y]] == count[index[n<span class="number">-2</span>]]) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!mat[index[x]][index[y]]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> count[index[n<span class="number">-1</span>]] + count[index[n<span class="number">-2</span>]];</span><br><span class="line">                &#125;</span><br><span class="line">                y--;</span><br><span class="line">            &#125;</span><br><span class="line">            x--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count[index[n<span class="number">-1</span>]] + count[index[n<span class="number">-2</span>]] - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1605-给定行和列的和求可行矩阵"><a href="#1605-给定行和列的和求可行矩阵" class="headerlink" title="1605. 给定行和列的和求可行矩阵"></a><a href="https://leetcode.cn/problems/find-valid-matrix-given-row-and-column-sums/">1605. 给定行和列的和求可行矩阵</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">restoreMatrix</span>(vector&lt;<span class="type">int</span>&gt;&amp; rowSum, vector&lt;<span class="type">int</span>&gt;&amp; colSum) &#123;</span><br><span class="line">        <span class="type">int</span> m = rowSum.<span class="built_in">size</span>(),n = colSum.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; res = vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;(m, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="type">int</span> x = <span class="built_in">min</span>(rowSum[i], colSum[j]);</span><br><span class="line">                res[i][j] = x;</span><br><span class="line">                rowSum[i] -= x;</span><br><span class="line">                colSum[j] -= x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>根据行列和的要求，当前方格中可以填入的最大值是两个要求的最小值，直接填入该值，并更新对应位置的要求</p></blockquote><h2 id="2383-赢得比赛需要的最少训练时长"><a href="#2383-赢得比赛需要的最少训练时长" class="headerlink" title="2383. 赢得比赛需要的最少训练时长"></a><a href="https://leetcode.cn/problems/minimum-hours-of-training-to-win-a-competition/description/">2383. 赢得比赛需要的最少训练时长</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minNumberOfHours</span><span class="params">(<span class="type">int</span> initialEnergy, <span class="type">int</span> initialExperience, vector&lt;<span class="type">int</span>&gt;&amp; energy, vector&lt;<span class="type">int</span>&gt;&amp; experience)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> eng = <span class="number">1</span>, expLeft = <span class="number">0</span>, len = energy.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> exp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            eng += energy[i];</span><br><span class="line">            exp = <span class="built_in">max</span>(exp, experience[i] - expLeft+<span class="number">1</span>);</span><br><span class="line">            expLeft += experience[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (eng &gt; initialEnergy ? eng - initialEnergy : <span class="number">0</span>) + (exp &gt; initialExperience ? exp - initialExperience : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>能量是从左到右消耗的，所以初始能量大于能量总和就可以<br>经验是可以从左到右累积的，所以初始经验大于当前对手的经验减去累积的经验就可以了</p></blockquote><h2 id="1625-执行操作后字典序最小的字符串"><a href="#1625-执行操作后字典序最小的字符串" class="headerlink" title="1625. 执行操作后字典序最小的字符串"></a><a href="https://leetcode.cn/problems/lexicographically-smallest-string-after-applying-operations/description/">1625. 执行操作后字典序最小的字符串</a></h2><h3 id="过于暴力"><a href="#过于暴力" class="headerlink" title="过于暴力"></a>过于暴力</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    map&lt;string, <span class="type">bool</span>&gt; visited;</span><br><span class="line">    <span class="type">int</span> len, a, b;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(string&amp; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i+=<span class="number">2</span>) &#123;</span><br><span class="line">            s[i] = (s[i] + a)%<span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">rotate</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        string ret;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            ret.<span class="built_in">push_back</span>(s[(i+b)%len]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">search</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(visited.<span class="built_in">count</span>(s) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        visited[s] = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">search</span>(<span class="built_in">rotate</span>(s));</span><br><span class="line">        <span class="built_in">add</span>(s);</span><br><span class="line">        <span class="built_in">search</span>(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">findLexSmallestString</span><span class="params">(string s, <span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;len = s.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;a = a;</span><br><span class="line">        <span class="keyword">this</span>-&gt;b = b;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            s[i] -= <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">search</span>(s);</span><br><span class="line">        string ret = visited.<span class="built_in">begin</span>()-&gt;first;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            ret[i] += <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>暴力，硬搜，把所有可能情况都算出来</p></blockquote><h2 id="面试题-17-05-字母与数字"><a href="#面试题-17-05-字母与数字" class="headerlink" title="面试题 17.05. 字母与数字"></a><a href="https://leetcode.cn/problems/find-longest-subarray-lcci/description/">面试题 17.05. 字母与数字</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">findLongestSubarray</span><span class="params">(vector&lt;string&gt;&amp; array)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = array.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">sum</span><span class="params">(len)</span></span>;</span><br><span class="line">        sum[<span class="number">0</span>] = <span class="built_in">isalpha</span>(array[<span class="number">0</span>][<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">            sum[i] = sum[i<span class="number">-1</span>] + (<span class="built_in">isalpha</span>(array[i][<span class="number">0</span>]) ? <span class="number">1</span> : <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">0</span>, right = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(sum[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(i &gt; right - left) &#123;</span><br><span class="line">                    left = <span class="number">0</span>;</span><br><span class="line">                    right = i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(!m.<span class="built_in">count</span>(sum[i])) &#123;</span><br><span class="line">                    m[sum[i]] = i + <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(i - m[sum[i]] &gt; right - left) &#123;</span><br><span class="line">                        right = i;</span><br><span class="line">                        left = m[sum[i]];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;array.<span class="built_in">begin</span>() + left, array.<span class="built_in">begin</span>() + right + <span class="number">1</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>使用前缀和，sum表示字母比数字多多少，如果是0，则说明区间[0,i]上是字母数字平衡的<br>对于不是0的情况，若[0,a]字母比数字多n个，[0,b]字母比数字也多n个，则[a+1,b]中，数字字母一样多<br>由于求最长子串，则存每个n第一次出现的位置即可</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1616-分割两个字符串得到回文串&quot;&gt;&lt;a href=&quot;#1616-分割两个字符串得到回文串&quot; class=&quot;headerlink&quot; title=&quot;1616. 分割两个字符串得到回文串&quot;&gt;&lt;/a&gt;1616. 分割两个字符串得到回文串&lt;/h2&gt;&lt;h3 id=&quot;ac代码&quot;&gt;&lt;a href=&quot;#ac代码&quot; class=&quot;headerlink&quot; title=&quot;ac代码&quot;&gt;&lt;/a&gt;ac代码&lt;/h3&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkPalindromeFormation&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(string a, string b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = a.&lt;span class=&quot;built_in&quot;&gt;length&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(len == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; flaga = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;, flagb = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(; i &amp;lt; len; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(a[i] == b[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; j = i; j &amp;lt; len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(b[j] != b[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                flagb = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; j = i; j &amp;lt; len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(a[j] != a[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                flaga = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(flaga || flagb) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        flaga = flagb = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; len; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(a[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i] == b[i]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; j = i; j &amp;lt; len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(a[j] != a[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                flaga = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; j = i; j &amp;lt; len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(b[j] != b[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                flagb = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; flaga || flagb;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;ab两个字符串在同一个位置分隔开，若 $ pre_a + suf_b $ 或 $ pre_b + suf_a $ 是回文串，则返回true，否则返回false&lt;br&gt;这个规则相当于ab截取相同且任意长的前缀并交换，看交换后是否存在回文&lt;br&gt;我的思路是先比较a的第i位与b的倒数第i位是否想等，找到第一次不相等的位置i，此时可以从第i位分割，判断b的剩余部分是否是回文，或者从len-i-1处分割，判断a的剩余部分是否是回文&lt;br&gt;若都不是，再比较b的第i位与a的倒数i位，找到第一个不满足的i，再比较a，b的剩余部分&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;优化行数&quot;&gt;&lt;a href=&quot;#优化行数&quot; class=&quot;headerlink&quot; title=&quot;优化行数&quot;&gt;&lt;/a&gt;优化行数&lt;/h3&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;checkPalindromeFormation&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(string a, string b)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = a.&lt;span class=&quot;built_in&quot;&gt;length&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; paliA = len/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;, paliB = len/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(paliA &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; a[paliA] == a[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-paliA]) paliA--;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(paliB &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; b[paliB] == b[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-paliB]) paliB--;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i, j;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; len/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(a[i] != b[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-i]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; len/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(b[j] != a[len&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;-j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(paliA, paliB) &amp;lt; &lt;span class=&quot;built_in&quot;&gt;max&lt;/span&gt;(i, j);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/categories/LeetCode/"/>
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>aflchurn的使用</title>
    <link href="https://jingtianer.github.io/home/2023/03/15/%E7%BB%84%E4%BC%9A/aflchurn/"/>
    <id>https://jingtianer.github.io/home/2023/03/15/%E7%BB%84%E4%BC%9A/aflchurn/</id>
    <published>2023-03-15T04:15:37.000Z</published>
    <updated>2023-03-20T03:25:02.929Z</updated>
    
    <content type="html"><![CDATA[<h2 id="尝试对knot-dns进行测试"><a href="#尝试对knot-dns进行测试" class="headerlink" title="尝试对knot dns进行测试"></a>尝试对knot dns进行测试</h2><blockquote><p>尝试对knot dns进行测试，和之前皓辰的结果一样，程序找不到新路径</p></blockquote><blockquote><p>knot dns在运行时会产生Segment fault，不知道是什么原因，程序<code>_exit</code>值为139。在github中查找了该退出代码，并没有找到相应文件</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ <span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/knot-dns</span><br><span class="line">tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ <span class="variable">$SUBJECT</span>/tests-fuzz/knotd_stdio -c <span class="variable">$SUBJECT</span>/tests-fuzz/knotd_wrap/knot_stdio.conf</span><br><span class="line">2023-03-19T20:17:55-0700 info: Knot DNS 3.3.dev.1678845372.e31fee4 starting</span><br><span class="line">2023-03-19T20:17:55-0700 info: loaded configuration file <span class="string">&#x27;/home/tt/Desktop/dnsenv/aflgo-knot/knot-dns/tests-fuzz/knotd_wrap/knot_stdio.conf&#x27;</span>, mapsize 500 MiB</span><br><span class="line">2023-03-19T20:17:55-0700 warning: no network interface configured</span><br><span class="line">2023-03-19T20:17:55-0700 info: AFL, UDP handler listening on stdin</span><br><span class="line">2023-03-19T20:17:55-0700 warning: removing stale PID file <span class="string">&#x27;/tmp/knotd-fuzz/rundir/knot.pid&#x27;</span></span><br><span class="line">2023-03-19T20:17:55-0700 info: loading 0 zones</span><br><span class="line">2023-03-19T20:17:55-0700 warning: no zones loaded</span><br><span class="line">2023-03-19T20:17:55-0700 info: starting server</span><br><span class="line">2023-03-19T20:17:55-0700 info: server started <span class="keyword">in</span> the foreground, PID 128184</span><br><span class="line">2023-03-19T20:17:55-0700 info: control, binding to <span class="string">&#x27;/tmp/knotd-fuzz/rundir/knot.sock&#x27;</span></span><br><span class="line">2023-03-19T20:17:55-0700 info: AFL, empty TCP handler</span><br><span class="line">Segmentation fault</span><br><span class="line">tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ <span class="built_in">echo</span> $?</span><br><span class="line">139</span><br></pre></td></tr></table></figure><h2 id="aflchurn简介"><a href="#aflchurn简介" class="headerlink" title="aflchurn简介"></a>aflchurn简介</h2><ul><li><a href="https://github.com/aflchurn/aflchurn">aflchurn主页</a></li></ul><p>作者通过观察<code>oss-fuzz</code>中的bugs发现，新出现的bug往往与最新添加、修改的代码有关，在fuzz时给予最新修改过的bb块更高的权重，其他bb块更低的权重</p><h3 id="aflchurn-x2F-tʃɜːn-x2F-安装"><a href="#aflchurn-x2F-tʃɜːn-x2F-安装" class="headerlink" title="aflchurn(&#x2F;tʃɜːn&#x2F;)安装"></a>aflchurn(&#x2F;tʃɜːn&#x2F;)安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aflchurn/aflchurn.git</span><br><span class="line">cd aflchurn</span><br><span class="line">export AFLCHURN=$PWD</span><br><span class="line">make clean all</span><br><span class="line">cd llvm_mode</span><br><span class="line">make clean all</span><br></pre></td></tr></table></figure><blockquote><p>比较简单，直接下载编译即可</p></blockquote><h3 id="利用aflchurn插装"><a href="#利用aflchurn插装" class="headerlink" title="利用aflchurn插装"></a>利用aflchurn插装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CC=$AFLCHURN/afl-clang-fast CXX=$AFLCHURN/afl-clang-fast++ ./configure [...options...]</span><br><span class="line">make</span><br></pre></td></tr></table></figure><blockquote><p>与afl相同</p></blockquote><h3 id="测试bind"><a href="#测试bind" class="headerlink" title="测试bind"></a>测试bind</h3><blockquote><p>问题1：插装时，发现大量文件产生错误<code>fatal: unknown date format unix</code>，不能正确读取文件的修改时间信息</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                  aflchurn 2.57b (dns_message_parse)</span><br><span class="line"></span><br><span class="line">┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐</span><br><span class="line">│        run time : 0 days, 0 hrs, 12 min, 25 sec      │  cycles <span class="keyword">done</span> : 0      │</span><br><span class="line">│   last new path : 0 days, 0 hrs, 0 min, 1 sec        │  total paths : 1203   │</span><br><span class="line">│ last <span class="built_in">uniq</span> crash : none seen yet                      │ <span class="built_in">uniq</span> crashes : 0      │</span><br><span class="line">│  last <span class="built_in">uniq</span> hang : none seen yet                      │   <span class="built_in">uniq</span> hangs : 0      │</span><br><span class="line">├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤</span><br><span class="line">│  now processing : 268 (22.28%)      │    map density : 2.15% / 8.51%         │</span><br><span class="line">│ paths timed out : 0 (0.00%)         │ count coverage : 3.64 bits/tuple       │</span><br><span class="line">├─ stage progress ────────────────────┼─ findings <span class="keyword">in</span> depth ────────────────────┤</span><br><span class="line">│  now trying : arith 8/8             │ favored paths : 353 (29.34%)           │</span><br><span class="line">│ stage execs : 2166/9256 (23.40%)    │  new edges on : 452 (37.57%)           │</span><br><span class="line">│ total execs : 1.70M                 │ total crashes : 0 (0 unique)           │</span><br><span class="line">│  <span class="built_in">exec</span> speed : 1930/sec              │aflchurn <span class="built_in">factor</span>: 2.136                  │</span><br><span class="line">├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤</span><br><span class="line">│   bit flips : 265/66.5k, 59/66.4k, 32/66.3k         │    levels : 2          │</span><br><span class="line">│  byte flips : 3/8312, 7/6476, 5/6420                │   pending : 1147       │</span><br><span class="line">│ arithmetics : 233/356k, 8/196k, 1/84.5k             │  pend fav : 343        │</span><br><span class="line">│  known ints : 12/26.2k, 26/136k, 32/251k            │ own finds : 903        │</span><br><span class="line">│  dictionary : 0/0, 0/0, 14/96.4k                    │  imported : n/a        │</span><br><span class="line">│       havoc : 206/312k, 0/0                         │ stability : 75.52%     │</span><br><span class="line">│        trim : 0.00%/3397, 21.26%                    ├────────────────────────┘</span><br><span class="line">└─────────────────────────────────────────────────────┘          [cpu002:127%]</span><br></pre></td></tr></table></figure><blockquote><p>aflchurm和aflgo一直都在跑，最后跑出了一个oom</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[-] PROGRAM ABORT : Unable to request new process from fork server (OOM?)</span><br><span class="line">         Location : run_target(), afl-fuzz.c:2882</span><br></pre></td></tr></table></figure><blockquote><p>应该是运行时设置了参数<code>-m 12800</code>，每次测试程序之允许分配12800MB的内存，导致程序内存不足</p></blockquote><h3 id="增大内存分配"><a href="#增大内存分配" class="headerlink" title="增大内存分配"></a>增大内存分配</h3><ul><li>将内存参数设置为<code>-m none</code>，不限制内存的使用</li><li>将in文件夹改为<code>-</code>，表示继续之间的模糊测试进度</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_LIBRARY_PATH=<span class="variable">$SUBJECT</span>/lib/isc/.libs:<span class="variable">$SUBJECT</span>/lib/dns/.libs <span class="variable">$AFLGO</span>/afl-fuzz -m none  -i - -o out <span class="variable">$SUBJECT</span>/fuzz/.libs/dns_message_parse</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;尝试对knot-dns进行测试&quot;&gt;&lt;a href=&quot;#尝试对knot-dns进行测试&quot; class=&quot;headerlink&quot; title=&quot;尝试对knot dns进行测试&quot;&gt;&lt;/a&gt;尝试对knot dns进行测试&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;尝试对knot dns进行测试，和之前皓辰的结果一样，程序找不到新路径&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;knot dns在运行时会产生Segment fault，不知道是什么原因，程序&lt;code&gt;_exit&lt;/code&gt;值为139。在github中查找了该退出代码，并没有找到相应文件&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; SUBJECT=&lt;span class=&quot;variable&quot;&gt;$PWD&lt;/span&gt;/knot-dns&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ &lt;span class=&quot;variable&quot;&gt;$SUBJECT&lt;/span&gt;/tests-fuzz/knotd_stdio -c &lt;span class=&quot;variable&quot;&gt;$SUBJECT&lt;/span&gt;/tests-fuzz/knotd_wrap/knot_stdio.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: Knot DNS 3.3.dev.1678845372.e31fee4 starting&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: loaded configuration file &lt;span class=&quot;string&quot;&gt;&amp;#x27;/home/tt/Desktop/dnsenv/aflgo-knot/knot-dns/tests-fuzz/knotd_wrap/knot_stdio.conf&amp;#x27;&lt;/span&gt;, mapsize 500 MiB&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 warning: no network interface configured&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: AFL, UDP handler listening on stdin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 warning: removing stale PID file &lt;span class=&quot;string&quot;&gt;&amp;#x27;/tmp/knotd-fuzz/rundir/knot.pid&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: loading 0 zones&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 warning: no zones loaded&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: starting server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: server started &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the foreground, PID 128184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: control, binding to &lt;span class=&quot;string&quot;&gt;&amp;#x27;/tmp/knotd-fuzz/rundir/knot.sock&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2023-03-19T20:17:55-0700 info: AFL, empty TCP handler&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Segmentation fault&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tt@ubuntu:~/Desktop/dnsenv/aflgo-knot$ &lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; $?&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;aflchurn简介&quot;&gt;&lt;a href=&quot;#aflchurn简介&quot; class=&quot;headerlink&quot; title=&quot;aflchurn简介&quot;&gt;&lt;/a&gt;aflchurn简介&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/aflchurn/aflchurn&quot;&gt;aflchurn主页&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
    <category term="afl" scheme="https://jingtianer.github.io/home/tags/afl/"/>
    
  </entry>
  
  <entry>
    <title>第九周记录</title>
    <link href="https://jingtianer.github.io/home/2023/03/13/%E7%BB%84%E4%BC%9A/%E7%AC%AC%E4%B9%9D%E5%91%A8%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/"/>
    <id>https://jingtianer.github.io/home/2023/03/13/%E7%BB%84%E4%BC%9A/%E7%AC%AC%E4%B9%9D%E5%91%A8%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/</id>
    <published>2023-03-13T04:15:37.000Z</published>
    <updated>2023-03-13T01:27:22.857Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用go-fuzz对coreDNS测试"><a href="#使用go-fuzz对coreDNS测试" class="headerlink" title="使用go-fuzz对coreDNS测试"></a>使用go-fuzz对coreDNS测试</h2><ul><li>这里是对CoreDns的插件进行模糊测试，参考官方插件<a href="https://github.com/coredns/proxy/blob/master/fuzz.go">proxy</a>的模糊测试方法</li></ul><h3 id="下载go-fuzz"><a href="#下载go-fuzz" class="headerlink" title="下载go-fuzz"></a>下载go-fuzz</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> go-fuzz; <span class="built_in">cd</span> go-fuzz</span><br><span class="line"><span class="built_in">export</span> GOPATH=`<span class="built_in">pwd</span>`             <span class="comment"># 暂时更改go path，将go-fuzz下载到指定位置</span></span><br><span class="line"><span class="built_in">cd</span> ..; <span class="built_in">mkdir</span> tmp; <span class="built_in">cd</span> tmp</span><br><span class="line">go mod init tmp</span><br><span class="line">go mod tidy</span><br><span class="line">go get -u github.com/dvyukov/go-fuzz/go-fuzz@latest github.com/dvyukov/go-fuzz/go-fuzz-build@latest</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">export</span> PATH=\<span class="variable">$PATH</span>:<span class="variable">$GOPATH</span>/bin/ | <span class="built_in">tee</span> -a ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc  <span class="comment"># 写入环境变量</span></span><br></pre></td></tr></table></figure><h3 id="获取go-fuzz的语料库"><a href="#获取go-fuzz的语料库" class="headerlink" title="获取go-fuzz的语料库"></a>获取go-fuzz的语料库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -d github.com/dvyukov/go-fuzz-corpus</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>对于一个项目</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go mod init xxx</span><br><span class="line">go mod tidy</span><br><span class="line">go-fuzz-build</span><br><span class="line">go-fuzz</span><br></pre></td></tr></table></figure><blockquote><p>前提是必须编写Fuzz函数，作为go-fuzz的入口。Fuzz 函数的参数 data 是 go-fuzz生成的随机输入；返回值是一个整数，如果输入是有效的，则返回1，否则返回0。</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2023/03/12 18:16:31 workers: 8, corpus: 266 (48s ago), crashers: 0, restarts: 1/9642, execs: 1099293 (22890/sec), cover: 1596, <span class="built_in">uptime</span>: 48s</span><br><span class="line">2023/03/12 18:16:34 workers: 8, corpus: 266 (51s ago), crashers: 0, restarts: 1/9722, execs: 1176398 (23055/sec), cover: 1596, <span class="built_in">uptime</span>: 51s</span><br><span class="line">2023/03/12 18:16:37 workers: 8, corpus: 266 (54s ago), crashers: 0, restarts: 1/9778, execs: 1290718 (23891/sec), cover: 1596, <span class="built_in">uptime</span>: 54s</span><br><span class="line">2023/03/12 18:16:40 workers: 8, corpus: 266 (57s ago), crashers: 0, restarts: 1/9778, execs: 1398336 (24522/sec), cover: 1596, <span class="built_in">uptime</span>: 57s</span><br><span class="line">2023/03/12 18:16:43 workers: 8, corpus: 266 (1m0s ago), crashers: 0, restarts: 1/9788, execs: 1497597 (24950/sec), cover: 1596, <span class="built_in">uptime</span>: 1m0s</span><br><span class="line">2023/03/12 18:16:46 workers: 8, corpus: 266 (1m3s ago), crashers: 0, restarts: 1/9875, execs: 1589886 (25226/sec), cover: 1596, <span class="built_in">uptime</span>: 1m3s</span><br><span class="line">2023/03/12 18:16:49 workers: 8, corpus: 266 (1m6s ago), crashers: 0, restarts: 1/9827, execs: 1739488 (26346/sec), cover: 1759, <span class="built_in">uptime</span>: 1m6s</span><br><span class="line">2023/03/12 18:16:52 workers: 8, corpus: 266 (1m9s ago), crashers: 0, restarts: 1/9740, execs: 1840949 (26671/sec), cover: 1799, <span class="built_in">uptime</span>: 1m9s</span><br><span class="line">2023/03/12 18:16:55 workers: 8, corpus: 266 (1m12s ago), crashers: 0, restarts: 1/9806, execs: 1922080 (26686/sec), cover: 1799, <span class="built_in">uptime</span>: 1m12s</span><br></pre></td></tr></table></figure><h2 id="对CoreDNS进行模糊测试"><a href="#对CoreDNS进行模糊测试" class="headerlink" title="对CoreDNS进行模糊测试"></a>对CoreDNS进行模糊测试</h2><h3 id="coredns对go-fuzz的支持"><a href="#coredns对go-fuzz的支持" class="headerlink" title="coredns对go-fuzz的支持"></a>coredns对go-fuzz的支持</h3><p>在coredns的源码中可以找到一个Do函数，这使我们可以对CoreDNS的插件进行测试</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Do</span><span class="params">(p plugin.Handler, data []<span class="type">byte</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">ctx := context.TODO()</span><br><span class="line">r := <span class="built_in">new</span>(dns.Msg)</span><br><span class="line"><span class="keyword">if</span> err := r.Unpack(data); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> <span class="comment">// plugin will never be called when this happens.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// If the data unpack into a dns msg, but does not have a proper question section discard it.</span></span><br><span class="line"><span class="comment">// The server parts make sure this is true before calling the plugins; mimic this behavior.</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(r.Question) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := p.ServeDNS(ctx, &amp;test.ResponseWriter&#123;&#125;, r); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对proxy插件进行fuzz"><a href="#对proxy插件进行fuzz" class="headerlink" title="对proxy插件进行fuzz"></a>对proxy插件进行fuzz</h3><h4 id="编写Fuzz函数"><a href="#编写Fuzz函数" class="headerlink" title="编写Fuzz函数"></a>编写Fuzz函数</h4><p>例如，对proxy插件可以这样编写他的Fuzz函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Fuzz fuzzes proxy.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fuzz</span><span class="params">(data []<span class="type">byte</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">c := caddy.NewTestController(<span class="string">&quot;dns&quot;</span>, <span class="string">&quot;proxy . 8.8.8.8:53&quot;</span>)</span><br><span class="line">up, err := NewStaticUpstreams(&amp;c.Dispenser)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">p := &amp;Proxy&#123;Upstreams: &amp;up&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fuzz.Do(p, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用go-fuzz编译"><a href="#使用go-fuzz编译" class="headerlink" title="使用go-fuzz编译"></a>使用go-fuzz编译</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go-fuzz-build</span><br></pre></td></tr></table></figure><h4 id="进行测试"><a href="#进行测试" class="headerlink" title="进行测试"></a>进行测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go-fuzz</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2023/03/12 19:31:09 workers: 8, corpus: 310 (58s ago), crashers: 0, restarts: 1/9678, execs: 3619593 (57454/sec), cover: 1189, <span class="built_in">uptime</span>: 1m3s</span><br><span class="line">2023/03/12 19:31:12 workers: 8, corpus: 310 (1m1s ago), crashers: 0, restarts: 1/9659, execs: 3767317 (57080/sec), cover: 1189, <span class="built_in">uptime</span>: 1m6s</span><br><span class="line">2023/03/12 19:31:15 workers: 8, corpus: 310 (1m4s ago), crashers: 0, restarts: 1/9691, execs: 3924923 (56883/sec), cover: 1189, <span class="built_in">uptime</span>: 1m9s</span><br><span class="line">2023/03/12 19:31:18 workers: 8, corpus: 345 (0s ago), crashers: 0, restarts: 1/9745, execs: 4093282 (56851/sec), cover: 1189, <span class="built_in">uptime</span>: 1m12s</span><br><span class="line">2023/03/12 19:31:21 workers: 8, corpus: 407 (0s ago), crashers: 0, restarts: 1/9749, execs: 4270438 (56939/sec), cover: 1538, <span class="built_in">uptime</span>: 1m15s</span><br><span class="line">2023/03/12 19:31:24 workers: 8, corpus: 407 (3s ago), crashers: 0, restarts: 1/9711, execs: 4409004 (56525/sec), cover: 1546, <span class="built_in">uptime</span>: 1m18s</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;使用go-fuzz对coreDNS测试&quot;&gt;&lt;a href=&quot;#使用go-fuzz对coreDNS测试&quot; class=&quot;headerlink&quot; title=&quot;使用go-fuzz对coreDNS测试&quot;&gt;&lt;/a&gt;使用go-fuzz对coreDNS测试&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;这里是对CoreDns的插件进行模糊测试，参考官方插件&lt;a href=&quot;https://github.com/coredns/proxy/blob/master/fuzz.go&quot;&gt;proxy&lt;/a&gt;的模糊测试方法&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;下载go-fuzz&quot;&gt;&lt;a href=&quot;#下载go-fuzz&quot; class=&quot;headerlink&quot; title=&quot;下载go-fuzz&quot;&gt;&lt;/a&gt;下载go-fuzz&lt;/h3&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;mkdir&lt;/span&gt; go-fuzz; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; go-fuzz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; GOPATH=`&lt;span class=&quot;built_in&quot;&gt;pwd&lt;/span&gt;`             &lt;span class=&quot;comment&quot;&gt;# 暂时更改go path，将go-fuzz下载到指定位置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; ..; &lt;span class=&quot;built_in&quot;&gt;mkdir&lt;/span&gt; tmp; &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; tmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go mod init tmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go mod tidy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go get -u github.com/dvyukov/go-fuzz/go-fuzz@latest github.com/dvyukov/go-fuzz/go-fuzz-build@latest&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; PATH=\&lt;span class=&quot;variable&quot;&gt;$PATH&lt;/span&gt;:&lt;span class=&quot;variable&quot;&gt;$GOPATH&lt;/span&gt;/bin/ | &lt;span class=&quot;built_in&quot;&gt;tee&lt;/span&gt; -a ~/.bashrc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; ~/.bashrc  &lt;span class=&quot;comment&quot;&gt;# 写入环境变量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;获取go-fuzz的语料库&quot;&gt;&lt;a href=&quot;#获取go-fuzz的语料库&quot; class=&quot;headerlink&quot; title=&quot;获取go-fuzz的语料库&quot;&gt;&lt;/a&gt;获取go-fuzz的语料库&lt;/h3&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go get -d github.com/dvyukov/go-fuzz-corpus&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>aflgo的安装与使用</title>
    <link href="https://jingtianer.github.io/home/2023/03/02/%E7%BB%84%E4%BC%9A/aflgo%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>https://jingtianer.github.io/home/2023/03/02/%E7%BB%84%E4%BC%9A/aflgo%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/</id>
    <published>2023-03-02T04:15:37.000Z</published>
    <updated>2023-03-06T02:07:21.298Z</updated>
    
    <content type="html"><![CDATA[<h2 id="aflgo的安装与测试"><a href="#aflgo的安装与测试" class="headerlink" title="aflgo的安装与测试"></a>aflgo的安装与测试</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><h4 id="执行一键安装脚本"><a href="#执行一键安装脚本" class="headerlink" title="执行一键安装脚本"></a>执行一键安装脚本</h4><p>先克隆aflgo<a href="https://github.com/aflgo/aflgo.git">仓库</a>，脚本位于<code>./scripts/build</code>下的<code>aflgo-build.sh</code></p><p>使用一键安装脚本安装有几个问题</p><ul><li><p>编译时报错<code>error: ‘numeric_limits’ is not a member of ‘std’</code>，这是因为llvm源文件少引用了一个头文件，编辑文件<code>/root/build/llvm_tools/llvm-11.0.0.src/utils/benchmark/src/benchmark_register.h</code>，加入以下头文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;limits&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>或在脚本解压操作完成后，执行一次以下命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;5i#include&lt;limits&gt;&#x27;</span> ~/build/llvm_tools/llvm-11.0.0.src/utils/benchmark/src/benchmark_register.h</span><br></pre></td></tr></table></figure></li><li><p>apt找不到部分包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E: Package <span class="string">&#x27;python-dev&#x27;</span> has no installation candidate</span><br><span class="line">E: Unable to locate package python-bs4</span><br></pre></td></tr></table></figure></li><li><p>在脚本<code># install some packages</code>下修改为以下内容</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y python2-dev python3 python3-dev python3-pip autoconf automake libtool-bin python3-bs4 libboost-all-dev <span class="comment"># libclang-11.0-dev</span></span><br></pre></td></tr></table></figure></li><li><p>apt&#x2F;apt-get前没有<code>sudo</code>，需要加上，最好不要sudo整个脚本，否则会将文件编译到<code>/root/build</code>下</p></li><li><p>对于<code>ubuntu 16.04</code>版本，将脚本中判断系统版本的地方修改成以下内容，他想判断系统是否大于<code>1604</code>，但在16.04版本中获取的版本号是带引号的</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$UBUNTU_YEAR</span>&quot;</span> &gt; <span class="string">&#x27;&quot;16&#x27;</span> || <span class="string">&quot;<span class="variable">$UBUNTU_MONTH</span>&quot;</span> &gt; <span class="string">&#x27;04&quot;&#x27;</span> ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    sudo apt-get install -y python3-distutils</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="确定SUBJECT环境变量"><a href="#确定SUBJECT环境变量" class="headerlink" title="确定SUBJECT环境变量"></a>确定SUBJECT环境变量</h3><p><code>$SUBJECT</code>就是需要被fuzz的源码目录，这里我们先对<code>libxml2</code>进行测试，那么<code>$SUBJECT</code>定义如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Clone subject repository</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitlab.gnome.org/GNOME/libxml2</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/libxml2</span><br></pre></td></tr></table></figure><h3 id="生成BBTarget"><a href="#生成BBTarget" class="headerlink" title="生成BBTarget"></a>生成BBTarget</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/libxml2</span><br><span class="line"><span class="comment"># Setup directory containing all temporary files</span></span><br><span class="line"><span class="built_in">mkdir</span> temp</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/temp</span><br><span class="line"><span class="comment"># Download commit-analysis tool</span></span><br><span class="line">wget https://raw.githubusercontent.com/jay/showlinenum/develop/showlinenum.awk</span><br><span class="line"><span class="built_in">chmod</span> +x showlinenum.awk</span><br><span class="line"><span class="built_in">mv</span> showlinenum.awk <span class="variable">$TMP_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate BBtargets from commit ef709ce2</span></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">  git checkout ef709ce2</span><br><span class="line">  git diff -U0 HEAD^ HEAD &gt; <span class="variable">$TMP_DIR</span>/commit.diff</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/commit.diff |  <span class="variable">$TMP_DIR</span>/showlinenum.awk show_header=0 path=1 | grep -e <span class="string">&quot;\.[ch]:[0-9]*:+&quot;</span> -e <span class="string">&quot;\.cpp:[0-9]*:+&quot;</span> -e <span class="string">&quot;\.cc:[0-9]*:+&quot;</span> | <span class="built_in">cut</span> -d+ -f1 | rev | <span class="built_in">cut</span> -c2- | rev &gt; <span class="variable">$TMP_DIR</span>/BBtargets.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print extracted targets. </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Targets:&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/BBtargets.txt</span><br></pre></td></tr></table></figure><blockquote><p>根据git commit提交记录中的代码差异文件<code>*.diff</code>，生成<code>BBtargets.txt</code>，其文件格式为<code>文件名:行号</code></p></blockquote><h3 id="生成distance"><a href="#生成distance" class="headerlink" title="生成distance"></a>生成distance</h3><ul><li>根据上一步的<code>BBtargets.txt</code>，使用gold插件，生成CFG(控制流程图)和CG(调用图)</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set aflgo-instrumenter</span></span><br><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$AFLGO</span>/afl-clang-fast</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$AFLGO</span>/afl-clang-fast++</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/libxml2</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/temp</span><br><span class="line"><span class="comment"># Set aflgo-instrumentation flags</span></span><br><span class="line"><span class="built_in">export</span> COPY_CFLAGS=<span class="variable">$CFLAGS</span></span><br><span class="line"><span class="built_in">export</span> COPY_CXXFLAGS=<span class="variable">$CXXFLAGS</span></span><br><span class="line"><span class="built_in">export</span> ADDITIONAL=<span class="string">&quot;-targets=<span class="variable">$TMP_DIR</span>/BBtargets.txt -outdir=<span class="variable">$TMP_DIR</span> -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps&quot;</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$CFLAGS</span> <span class="variable">$ADDITIONAL</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$CXXFLAGS</span> <span class="variable">$ADDITIONAL</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build libxml2 (in order to generate CG and CFGs).</span></span><br><span class="line"><span class="comment"># Meanwhile go have a coffee ☕️</span></span><br><span class="line"><span class="built_in">export</span> LDFLAGS=-lpthread</span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">  ./autogen.sh</span><br><span class="line">  ./configure --disable-shared</span><br><span class="line">  make clean</span><br><span class="line">  make xmllint</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure><ul><li>计算distance，将会在<code>$TMP_DIR</code>下生成fuzz所需的<code>distance.cfg.txt</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$AFLGO</span>/scripts/gen_distance_fast.py <span class="variable">$SUBJECT</span> <span class="variable">$TMP_DIR</span> xmllint</span><br></pre></td></tr></table></figure><h3 id="插桩"><a href="#插桩" class="headerlink" title="插桩"></a>插桩</h3><p>使用第一步中编译出的<code>aflgo</code>工具，以及上一步生成的<code>distance</code>再次编译<code>libxml2</code>，进行插桩</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$AFLGO</span>/afl-clang-fast</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$AFLGO</span>/afl-clang-fast++</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/libxml2</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/temp</span><br><span class="line"><span class="comment"># Set aflgo-instrumentation flags</span></span><br><span class="line"><span class="built_in">export</span> COPY_CFLAGS=<span class="variable">$CFLAGS</span></span><br><span class="line"><span class="built_in">export</span> COPY_CXXFLAGS=<span class="variable">$CXXFLAGS</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$COPY_CFLAGS</span> -distance=<span class="variable">$TMP_DIR</span>/distance.cfg.txt&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$COPY_CXXFLAGS</span> -distance=<span class="variable">$TMP_DIR</span>/distance.cfg.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Clean and build subject with distance instrumentation ☕️</span></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">  make clean</span><br><span class="line">  ./configure --disable-shared</span><br><span class="line">  make xmllint</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure><h3 id="进行fuzz"><a href="#进行fuzz" class="headerlink" title="进行fuzz"></a>进行fuzz</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/libxml2</span><br><span class="line"><span class="comment"># Construct seed corpus</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="keyword">in</span></span><br><span class="line"><span class="built_in">cp</span> -r <span class="variable">$SUBJECT</span>/test/dtd* <span class="keyword">in</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$SUBJECT</span>/test/dtds/* <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo core | sudo tee /proc/sys/kernel/core_pattern</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -S ef709ce2 -z exp -c 45m -i <span class="keyword">in</span> -o out <span class="variable">$SUBJECT</span>/xmllint --valid --recover @@</span><br></pre></td></tr></table></figure><h3 id="fuzz结果-libxml2"><a href="#fuzz结果-libxml2" class="headerlink" title="fuzz结果(libxml2)"></a>fuzz结果(libxml2)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                      american fuzzy lop 2.52b (ef709ce2)</span><br><span class="line"></span><br><span class="line">┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐</span><br><span class="line">│        run time : 0 days, 1 hrs, 1 min, 7 sec        │  cycles <span class="keyword">done</span> : 6      │</span><br><span class="line">│   last new path : 0 days, 0 hrs, 1 min, 54 sec       │  total paths : 2839   │</span><br><span class="line">│ last <span class="built_in">uniq</span> crash : 0 days, 0 hrs, 51 min, 32 sec      │ <span class="built_in">uniq</span> crashes : 14     │</span><br><span class="line">│  last <span class="built_in">uniq</span> hang : 0 days, 0 hrs, 2 min, 24 sec       │   <span class="built_in">uniq</span> hangs : 10     │</span><br><span class="line">├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤</span><br><span class="line">│  now processing : 2828 (99.61%)     │    map density : 4.94% / 18.43%        │</span><br><span class="line">│ paths timed out : 0 (0.00%)         │ count coverage : 3.24 bits/tuple       │</span><br><span class="line">├─ stage progress ────────────────────┼─ findings <span class="keyword">in</span> depth ────────────────────┤</span><br><span class="line">│  now trying : trim 32/32            │ favored paths : 462 (16.27%)           │</span><br><span class="line">│ stage execs : 17/60 (28.33%)        │  new edges on : 787 (27.72%)           │</span><br><span class="line">│ total execs : 730k                  │ total crashes : 23 (14 unique)         │</span><br><span class="line">│  <span class="built_in">exec</span> speed : 6.90/sec (zzzz...)    │  total tmouts : 20 (13 unique)         │</span><br><span class="line">├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤</span><br><span class="line">│   bit flips : n/a, n/a, n/a                         │    levels : 22         │</span><br><span class="line">│  byte flips : n/a, n/a, n/a                         │   pending : 1930       │</span><br><span class="line">│ arithmetics : n/a, n/a, n/a                         │  pend fav : 3          │</span><br><span class="line">│  known ints : n/a, n/a, n/a                         │ own finds : 2825       │</span><br><span class="line">│  dictionary : n/a, n/a, n/a                         │  imported : 0          │</span><br><span class="line">│       havoc : 1342/241k, 1497/369k                  │ stability : 99.49%     │</span><br><span class="line">│        trim : 41.17%/97.2k, n/a                     ├────────────────────────┘</span><br><span class="line">└─────────────────────────────────────────────────────┘          [cpu000: 90%]</span><br></pre></td></tr></table></figure><h2 id="对bind进行fuzz"><a href="#对bind进行fuzz" class="headerlink" title="对bind进行fuzz"></a>对bind进行fuzz</h2><h3 id="生成BBTarget-1"><a href="#生成BBTarget-1" class="headerlink" title="生成BBTarget"></a>生成BBTarget</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/isc-projects/bind9.git</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/bind9</span><br><span class="line"><span class="built_in">mkdir</span> aflgo-bind9-tmp</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/aflgo-bind9-tmp</span><br><span class="line"></span><br><span class="line">python3 BBtarget.py <span class="variable">$SUBJECT</span> <span class="variable">$TMP_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Targets:&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/BBtargets.txt</span><br></pre></td></tr></table></figure><blockquote><p>其中<code>BBtarget.py</code>是我写的一个脚本，用来读取之前<code>gcc-python-plugin</code>找出的<code>recv</code>,<code>send</code>,<code>vulnerable</code>和<code>blocking</code></p></blockquote><h3 id="生成distance-1"><a href="#生成distance-1" class="headerlink" title="生成distance"></a>生成distance</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set aflgo-instrumenter</span></span><br><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$AFLGO</span>/afl-clang-fast</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$AFLGO</span>/afl-clang-fast++</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/bind9</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/aflgo-bind9-tmp</span><br><span class="line"><span class="comment"># Set aflgo-instrumentation flags</span></span><br><span class="line"><span class="built_in">export</span> COPY_CFLAGS=<span class="variable">$CFLAGS</span></span><br><span class="line"><span class="built_in">export</span> COPY_CXXFLAGS=<span class="variable">$CXXFLAGS</span></span><br><span class="line"><span class="built_in">export</span> ADDITIONAL=<span class="string">&quot;-targets=<span class="variable">$TMP_DIR</span>/BBtargets.txt -outdir=<span class="variable">$TMP_DIR</span> -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps&quot;</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$CFLAGS</span> <span class="variable">$ADDITIONAL</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$CXXFLAGS</span> <span class="variable">$ADDITIONAL</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build bind9 (in order to generate CG and CFGs).</span></span><br><span class="line"><span class="comment"># Meanwhile go have a coffee ☕️</span></span><br><span class="line"><span class="comment"># export LDFLAGS=-lpthread</span></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">  autoreconf -<span class="keyword">fi</span></span><br><span class="line">  ./configure  --enable-fuzzing=afl</span><br><span class="line">  make clean</span><br><span class="line">  make -j</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="variable">$SUBJECT</span>/bin/named --valid --recover <span class="variable">$SUBJECT</span>/test/dtd3</span><br><span class="line"><span class="built_in">ls</span> <span class="variable">$TMP_DIR</span>/dot-files</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Function targets&quot;</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/Ftargets.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clean up</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/BBnames.txt | grep -v <span class="string">&quot;^$&quot;</span>| rev | <span class="built_in">cut</span> -d: -f2- | rev | <span class="built_in">sort</span> | <span class="built_in">uniq</span> &gt; <span class="variable">$TMP_DIR</span>/BBnames2.txt &amp;&amp; <span class="built_in">mv</span> <span class="variable">$TMP_DIR</span>/BBnames2.txt <span class="variable">$TMP_DIR</span>/BBnames.txt</span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TMP_DIR</span>/BBcalls.txt | grep -Ev <span class="string">&quot;^[^,]*$|^([^,]*,)&#123;2,&#125;[^,]*$&quot;</span>| <span class="built_in">sort</span> | <span class="built_in">uniq</span> &gt; <span class="variable">$TMP_DIR</span>/BBcalls2.txt &amp;&amp; <span class="built_in">mv</span> <span class="variable">$TMP_DIR</span>/BBcalls2.txt <span class="variable">$TMP_DIR</span>/BBcalls.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate distance ☕️</span></span><br><span class="line"><span class="comment"># $AFLGO/scripts/genDistance.sh is the original, but significantly slower, version</span></span><br><span class="line"><span class="variable">$AFLGO</span>/scripts/gen_distance_fast.py <span class="variable">$SUBJECT</span>/bin/named/.libs <span class="variable">$TMP_DIR</span> named</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check distance file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Distance values:&quot;</span></span><br><span class="line"><span class="built_in">head</span> -n5 <span class="variable">$TMP_DIR</span>/distance.cfg.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;...&quot;</span></span><br><span class="line"><span class="built_in">tail</span> -n5 <span class="variable">$TMP_DIR</span>/distance.cfg.txt</span><br></pre></td></tr></table></figure><h3 id="插桩-1"><a href="#插桩-1" class="headerlink" title="插桩"></a>插桩</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> CC=<span class="variable">$AFLGO</span>/afl-clang-fast</span><br><span class="line"><span class="built_in">export</span> CXX=<span class="variable">$AFLGO</span>/afl-clang-fast++</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/bind9</span><br><span class="line"><span class="built_in">export</span> TMP_DIR=<span class="variable">$PWD</span>/aflgo-bind9-tmp</span><br><span class="line"><span class="comment"># Set aflgo-instrumentation flags</span></span><br><span class="line"><span class="built_in">export</span> COPY_CFLAGS=<span class="variable">$CFLAGS</span></span><br><span class="line"><span class="built_in">export</span> COPY_CXXFLAGS=<span class="variable">$CXXFLAGS</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$COPY_CFLAGS</span> -distance=<span class="variable">$TMP_DIR</span>/distance.cfg.txt&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$COPY_CXXFLAGS</span> -distance=<span class="variable">$TMP_DIR</span>/distance.cfg.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Clean and build subject with distance instrumentation ☕️</span></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$SUBJECT</span></span><br><span class="line">  make clean</span><br><span class="line">  ./configure --enable-fuzzing=afl</span><br><span class="line">  make -j</span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></table></figure><p>参考<a href="https://github.com/isc-projects/bind9/blob/main/fuzz/FUZZING.md">isc bind9仓库</a>中的描述，configure的时候要加上这个参数<code>--enable-fuzzing=afl</code></p><h3 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AFLGO=~/build/llvm_tools/build-llvm/msan/aflgo</span><br><span class="line"><span class="built_in">export</span> SUBJECT=<span class="variable">$PWD</span>/bind9</span><br><span class="line"><span class="comment"># Construct seed corpus</span></span><br><span class="line"><span class="built_in">rmdir</span> <span class="keyword">in</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="keyword">in</span></span><br><span class="line"><span class="built_in">cp</span> -r <span class="variable">$SUBJECT</span>/fuzz/* ./in</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo core | sudo tee /proc/sys/kernel/core_pattern</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据自己cpu占用情况并行fuzz</span></span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -m 8192 -M bind9_0 -z exp -c 45m -i <span class="keyword">in</span> -o out <span class="variable">$SUBJECT</span>/bin/named/.libs/named -c @@ -g</span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -m 8192 -S bind9_1 -z exp -c 45m -i <span class="keyword">in</span> -o out <span class="variable">$SUBJECT</span>/bin/named/.libs/named -c @@ -g</span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -m 8192 -S bind9_2 -z exp -c 45m -i <span class="keyword">in</span> -o out <span class="variable">$SUBJECT</span>/bin/named/.libs/named -c @@ -g</span><br><span class="line"><span class="variable">$AFLGO</span>/afl-fuzz -m 8192 -S bind9_3 -z exp -c 45m -i <span class="keyword">in</span> -o out <span class="variable">$SUBJECT</span>/bin/named/.libs/named -c @@ -g</span><br></pre></td></tr></table></figure><p>最后一行的参数<code>-c -g</code>参考了<code>hongfuzz</code>对<code>bind</code>测试的<a href="https://github.com/google/honggfuzz/tree/master/examples/bind">example</a></p><p>测试用例使用的是<code>bind9/fuzz</code>下自带的</p><p><a href="https://www.mail-archive.com/bind-users@lists.isc.org/msg30792.html">Re: Fuzzing Bind</a>官方如何对named进行fuzz的一个回答，这里提到了如何使用pkt文件作为种子进行模糊测试</p><p><a href="https://github.com/CZ-NIC/dns-fuzzing">dns-fuzzing仓库</a>提供了用于测试的种子</p><blockquote><p>到此就可以使用<code>aflgo</code>对<code>named</code>进行测试了</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;aflgo的安装与测试&quot;&gt;&lt;a href=&quot;#aflgo的安装与测试&quot; class=&quot;headerlink&quot; title=&quot;aflgo的安装与测试&quot;&gt;&lt;/a&gt;aflgo的安装与测试&lt;/h2&gt;&lt;h3 id=&quot;安装依赖&quot;&gt;&lt;a href=&quot;#安装依赖&quot; class=&quot;headerlink&quot; title=&quot;安装依赖&quot;&gt;&lt;/a&gt;安装依赖&lt;/h3&gt;&lt;h4 id=&quot;执行一键安装脚本&quot;&gt;&lt;a href=&quot;#执行一键安装脚本&quot; class=&quot;headerlink&quot; title=&quot;执行一键安装脚本&quot;&gt;&lt;/a&gt;执行一键安装脚本&lt;/h4&gt;&lt;p&gt;先克隆aflgo&lt;a href=&quot;https://github.com/aflgo/aflgo.git&quot;&gt;仓库&lt;/a&gt;，脚本位于&lt;code&gt;./scripts/build&lt;/code&gt;下的&lt;code&gt;aflgo-build.sh&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;使用一键安装脚本安装有几个问题&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;编译时报错&lt;code&gt;error: ‘numeric_limits’ is not a member of ‘std’&lt;/code&gt;，这是因为llvm源文件少引用了一个头文件，编辑文件&lt;code&gt;/root/build/llvm_tools/llvm-11.0.0.src/utils/benchmark/src/benchmark_register.h&lt;/code&gt;，加入以下头文件&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#include&amp;lt;limits&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;或在脚本解压操作完成后，执行一次以下命令&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sed -i &lt;span class=&quot;string&quot;&gt;&amp;#x27;5i#include&amp;lt;limits&amp;gt;&amp;#x27;&lt;/span&gt; ~/build/llvm_tools/llvm-11.0.0.src/utils/benchmark/src/benchmark_register.h&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;apt找不到部分包&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;E: Package &lt;span class=&quot;string&quot;&gt;&amp;#x27;python-dev&amp;#x27;&lt;/span&gt; has no installation candidate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;E: Unable to locate package python-bs4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在脚本&lt;code&gt;# install some packages&lt;/code&gt;下修改为以下内容&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;apt install -y python2-dev python3 python3-dev python3-pip autoconf automake libtool-bin python3-bs4 libboost-all-dev &lt;span class=&quot;comment&quot;&gt;# libclang-11.0-dev&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;apt&amp;#x2F;apt-get前没有&lt;code&gt;sudo&lt;/code&gt;，需要加上，最好不要sudo整个脚本，否则会将文件编译到&lt;code&gt;/root/build&lt;/code&gt;下&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;对于&lt;code&gt;ubuntu 16.04&lt;/code&gt;版本，将脚本中判断系统版本的地方修改成以下内容，他想判断系统是否大于&lt;code&gt;1604&lt;/code&gt;，但在16.04版本中获取的版本号是带引号的&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
    <category term="aflgo" scheme="https://jingtianer.github.io/home/tags/aflgo/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-23</title>
    <link href="https://jingtianer.github.io/home/2023/02/27/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9323/"/>
    <id>https://jingtianer.github.io/home/2023/02/27/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9323/</id>
    <published>2023-02-27T03:14:34.000Z</published>
    <updated>2023-03-04T06:17:14.764Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1144-递减元素使数组呈锯齿状"><a href="#1144-递减元素使数组呈锯齿状" class="headerlink" title="1144. 递减元素使数组呈锯齿状"></a><a href="https://leetcode.cn/problems/decrease-elements-to-make-array-zigzag/">1144. 递减元素使数组呈锯齿状</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">movesToMakeZigzag</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> odd2less, even2less;</span><br><span class="line">        odd2less = even2less = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[i] &gt;= <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>])) &#123;</span><br><span class="line">                    even2less += nums[i] - <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(nums[i] &gt;= <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>])) &#123;</span><br><span class="line">                    odd2less += nums[i] - <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">0</span>] &gt;= nums[<span class="number">1</span>]) &#123;</span><br><span class="line">            even2less += nums[<span class="number">0</span>] - nums[<span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[n<span class="number">-1</span>] &gt;= nums[n<span class="number">-2</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span>((n<span class="number">-1</span>)%<span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                even2less += nums[n<span class="number">-1</span>] - nums[n<span class="number">-2</span>] + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                odd2less += nums[n<span class="number">-1</span>] - nums[n<span class="number">-2</span>] + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(even2less, odd2less);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>遍历所有奇数，使其小于两端，记录操作数1<br>遍历所有偶数，使其小于两端，记录操作数2<br>返回最小值</p></blockquote><h3 id="优化代码行数"><a href="#优化代码行数" class="headerlink" title="优化代码行数"></a>优化代码行数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">movesToMakeZigzag</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> op[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;, n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] &gt;= <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>]))</span><br><span class="line">                op[i&amp;<span class="number">1</span>] += nums[i] - <span class="built_in">min</span>(nums[i<span class="number">-1</span>], nums[i+<span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">0</span>] &gt;= nums[<span class="number">1</span>]) &#123;</span><br><span class="line">            op[<span class="number">0</span>] += nums[<span class="number">0</span>] - nums[<span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[n<span class="number">-1</span>] &gt;= nums[n<span class="number">-2</span>]) &#123;</span><br><span class="line">            op[(n<span class="number">-1</span>)&amp;<span class="number">1</span>] += nums[n<span class="number">-1</span>] - nums[n<span class="number">-2</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(op[<span class="number">0</span>], op[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2325-解密消息"><a href="#2325-解密消息" class="headerlink" title="2325. 解密消息"></a><a href="https://leetcode.cn/problems/decode-the-message/submissions/406636854/">2325. 解密消息</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">decodeMessage</span><span class="params">(string key, string message)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; alphabet = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">26</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="type">int</span> klen = key.<span class="built_in">length</span>(), slen = message.<span class="built_in">length</span>(), index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; klen &amp;&amp; index &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isalpha</span>(key[i]) &amp;&amp; alphabet[key[i] - <span class="string">&#x27;a&#x27;</span>] == <span class="number">-1</span>) &#123;</span><br><span class="line">                alphabet[key[i] - <span class="string">&#x27;a&#x27;</span>] = <span class="string">&#x27;a&#x27;</span> + index++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; slen; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">isalpha</span>(message[i]))</span><br><span class="line">                message[i] = alphabet[message[i] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2319-判断矩阵是否是一个-X-矩阵"><a href="#2319-判断矩阵是否是一个-X-矩阵" class="headerlink" title="2319. 判断矩阵是否是一个 X 矩阵"></a><a href="https://leetcode.cn/problems/check-if-matrix-is-x-matrix/description/">2319. 判断矩阵是否是一个 X 矩阵</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">checkXMatrix</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; grid)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = grid.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>((i - j == <span class="number">0</span> || i + j == n - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(grid[i][j] == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(grid[i][j] != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>主对角线，副对角线上的元素不能是0，其他必须是0<br>主对角线上的点满足 $ i - j &#x3D;&#x3D; 0 $， 副对角线上满足 $ i + j &#x3D;&#x3D; n-1 $</p></blockquote><h2 id="1669-合并两个链表"><a href="#1669-合并两个链表" class="headerlink" title="1669. 合并两个链表"></a><a href="https://leetcode.cn/problems/merge-in-between-linked-lists/description/">1669. 合并两个链表</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">mergeInBetween</span><span class="params">(ListNode* list1, <span class="type">int</span> a, <span class="type">int</span> b, ListNode* list2)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        ListNode *dummy = <span class="keyword">new</span> <span class="built_in">ListNode</span>(<span class="number">0</span>, list1), *x, *y, *move;</span><br><span class="line">        <span class="keyword">for</span>(move = dummy; i &lt;= b; move = move-&gt;next, i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == a) &#123;</span><br><span class="line">                x = move;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(i == b) &#123;</span><br><span class="line">                y = move-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        x-&gt;next = list2;</span><br><span class="line">        move = list2;</span><br><span class="line">        <span class="keyword">while</span>(move-&gt;next != <span class="literal">nullptr</span>) move = move-&gt;next;</span><br><span class="line">        move-&gt;next = y-&gt;next;</span><br><span class="line">        <span class="keyword">return</span> dummy-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">mergeInBetween</span><span class="params">(ListNode* list1, <span class="type">int</span> a, <span class="type">int</span> b, ListNode* list2)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        ListNode *x, *y;</span><br><span class="line">        <span class="keyword">for</span>(x = list1; i &lt; a<span class="number">-1</span>; x = x-&gt;next, i++);</span><br><span class="line">        <span class="keyword">for</span>(y = x; i &lt; b; y = y-&gt;next, i++);</span><br><span class="line">        x-&gt;next = list2;</span><br><span class="line">        <span class="keyword">while</span>(list2-&gt;next != <span class="literal">nullptr</span>) list2 = list2-&gt;next;</span><br><span class="line">        list2-&gt;next = y-&gt;next;</span><br><span class="line">        <span class="keyword">return</span> list1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>题目中 a, b的范围是 $ 1 &lt;&#x3D; a &lt;&#x3D; b &lt; list1.length - 1 $，第一个节点不需要被删除，所以dummy节点是多余的<br>将寻找a，b的for循环拆成两块，减少if跳转指令的执行次数<br>move节点也是多余的</p></blockquote><h2 id="2315-统计星号"><a href="#2315-统计星号" class="headerlink" title="2315. 统计星号"></a><a href="https://leetcode.cn/problems/count-asterisks/description/">2315. 统计星号</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">countAsterisks</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = s.<span class="built_in">length</span>();</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(;i &lt; len &amp;&amp; s[i] != <span class="string">&#x27;|&#x27;</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(s[i] == <span class="string">&#x27;*&#x27;</span>) count++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(i++; i &lt; len &amp;&amp; s[i] != <span class="string">&#x27;|&#x27;</span>; i++);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1664-生成平衡数组的方案数"><a href="#1664-生成平衡数组的方案数" class="headerlink" title="1664. 生成平衡数组的方案数"></a><a href="https://leetcode.cn/problems/ways-to-make-a-fair-array/description/">1664. 生成平衡数组的方案数</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">waysToMakeFair</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(), ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</span><br><span class="line">        <span class="type">int</span> len = n;</span><br><span class="line">        <span class="keyword">if</span>(n % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            nums.<span class="built_in">push_back</span>(<span class="number">0</span>);</span><br><span class="line">            n++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">preSum</span><span class="params">(n + <span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            preSum[i+<span class="number">2</span>] = preSum[i] + nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">int</span> odd = <span class="number">0</span>, even = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                even = preSum[n<span class="number">-1</span> + <span class="number">2</span>] - preSum[i+<span class="number">2</span><span class="number">-1</span>] + preSum[i + <span class="number">2</span> <span class="number">-2</span>];</span><br><span class="line">                odd = preSum[n<span class="number">-2</span> + <span class="number">2</span>] - preSum[i + <span class="number">2</span>] + preSum[i+<span class="number">2</span> - <span class="number">1</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                even = preSum[n<span class="number">-1</span>+<span class="number">2</span>] - preSum[i+<span class="number">2</span>] + preSum[i+<span class="number">2</span> <span class="number">-1</span>];</span><br><span class="line">                odd = preSum[n<span class="number">-2</span>+<span class="number">2</span>] - preSum[i+<span class="number">2</span>+<span class="number">1</span><span class="number">-2</span>] + preSum[i+<span class="number">2</span><span class="number">-2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(even == odd) &#123;</span><br><span class="line">                ret++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>分奇数下标和偶数下标计算前缀和<br>当某个值被删除时，其后方奇数下标边偶数下标，偶数下标边奇数下标，前方则不变。<br>假设删除某个数，计算变化后的奇偶下标之和，如果相等，则方案数+1<br>为了方便代码编写，如果n是奇数，则添加一个0保证其为偶数，但注意删除添加的这个数使得平衡并不算有效方案</p></blockquote><h3 id="空间优化"><a href="#空间优化" class="headerlink" title="空间优化"></a>空间优化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">waysToMakeFair</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>(), ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(n &lt;= <span class="number">1</span>) <span class="keyword">return</span> n;</span><br><span class="line">        <span class="type">int</span> odd1, even1, odd2, even2;</span><br><span class="line">        odd1 = even1 = odd2 = even2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i&amp;<span class="number">1</span>) &#123;</span><br><span class="line">                odd2+=nums[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                even2+=nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i&amp;<span class="number">1</span>) &#123;</span><br><span class="line">                odd2-=nums[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                even2-=nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(odd2 + even1 == odd1 + even2) ret++;</span><br><span class="line">            <span class="keyword">if</span>(i&amp;<span class="number">1</span>) &#123;</span><br><span class="line">                odd1+=nums[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                even1+=nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>odd2,even2表示位置i被删除后，被删除元素后方的奇数下标和和偶数下标和（相对于未改变前的）<br>odd1,even1表示位置i被删除后，被删除元素前方的奇数下标和和偶数下标和<br>假设删除i，就从odd2或even2中删除<br>由于变化后奇数下标变偶数，偶数变奇数，则比较 $(odd2 + even1 &#x3D;&#x3D; odd1 + even2)$是否成立<br>比较后，将i加回odd1或even1</p></blockquote><h2 id="2309-兼具大小写的最好英文字母"><a href="#2309-兼具大小写的最好英文字母" class="headerlink" title="2309. 兼具大小写的最好英文字母"></a><a href="https://leetcode.cn/problems/greatest-english-letter-in-upper-and-lower-case/">2309. 兼具大小写的最好英文字母</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">greatestLetter</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">bool</span>&gt; <span class="title">upper</span><span class="params">(<span class="number">26</span>, <span class="literal">false</span>)</span>,<span class="title">lower</span><span class="params">(<span class="number">26</span>, <span class="literal">false</span>)</span></span>;</span><br><span class="line">        <span class="type">char</span> maxx = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> c : s) &#123;</span><br><span class="line">            <span class="keyword">if</span>(c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line">                upper[c - <span class="string">&#x27;A&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span>(lower[c-<span class="string">&#x27;A&#x27;</span>] &amp;&amp; c-<span class="string">&#x27;A&#x27;</span> &gt; maxx) &#123;</span><br><span class="line">                    maxx = c - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>) &#123;</span><br><span class="line">                lower[c - <span class="string">&#x27;a&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span>(upper[c-<span class="string">&#x27;a&#x27;</span>] &amp;&amp; c-<span class="string">&#x27;a&#x27;</span> &gt; maxx) &#123;</span><br><span class="line">                    maxx = c-<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxx &gt;= <span class="number">0</span> ? <span class="built_in">string</span>(<span class="number">1</span>, maxx + <span class="string">&#x27;A&#x27;</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2363-合并相似的物品"><a href="#2363-合并相似的物品" class="headerlink" title="2363. 合并相似的物品"></a><a href="https://leetcode.cn/problems/merge-similar-items/description/">2363. 合并相似的物品</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">mergeSimilarItems</span>(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; items1, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; items2) &#123;</span><br><span class="line">        map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; v : items1) &#123;</span><br><span class="line">            m[v[<span class="number">0</span>]] += v[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; v : items2) &#123;</span><br><span class="line">            m[v[<span class="number">0</span>]] += v[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; ret;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> ite = m.<span class="built_in">begin</span>(); ite != m.<span class="built_in">end</span>(); ite++) &#123;</span><br><span class="line">            <span class="keyword">auto</span>&amp; [x, y] = *ite;</span><br><span class="line">            ret.<span class="built_in">push_back</span>(&#123;x, y&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">mergeSimilarItems</span>(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; items1, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; items2) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(items1.<span class="built_in">begin</span>(), items1.<span class="built_in">end</span>(), [](vector&lt;<span class="type">int</span>&gt;&amp; x, vector&lt;<span class="type">int</span>&gt;&amp; y)-&gt;<span class="type">bool</span>&#123;<span class="keyword">return</span> x[<span class="number">0</span>] &lt; y[<span class="number">0</span>];&#125;);</span><br><span class="line">        <span class="built_in">sort</span>(items2.<span class="built_in">begin</span>(), items2.<span class="built_in">end</span>(), [](vector&lt;<span class="type">int</span>&gt;&amp; x, vector&lt;<span class="type">int</span>&gt;&amp; y)-&gt;<span class="type">bool</span>&#123;<span class="keyword">return</span> x[<span class="number">0</span>] &lt; y[<span class="number">0</span>];&#125;);</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, value = <span class="built_in">min</span>(items1[<span class="number">0</span>][<span class="number">0</span>], items2[<span class="number">0</span>][<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> n1 = items1.<span class="built_in">size</span>(), n2 = items2.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; ret&#123;&#123;value, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">        <span class="type">int</span> retSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; n1 &amp;&amp; j &lt; n2) &#123;</span><br><span class="line">            <span class="keyword">while</span>(i &lt; n1 &amp;&amp; items1[i][<span class="number">0</span>] == value) &#123;</span><br><span class="line">                ret[retSize][<span class="number">1</span>] += items1[i][<span class="number">1</span>];</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(j &lt; n2 &amp;&amp; items2[j][<span class="number">0</span>] == value) &#123;</span><br><span class="line">                ret[retSize][<span class="number">1</span>] += items2[j][<span class="number">1</span>];</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(i &lt; n1 &amp;&amp; j &lt; n2) &#123;</span><br><span class="line">                value = <span class="built_in">min</span>(items1[i][<span class="number">0</span>], items2[j][<span class="number">0</span>]);</span><br><span class="line">                ret.<span class="built_in">push_back</span>(&#123;value, <span class="number">0</span>&#125;);</span><br><span class="line">                retSize++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; n1) &#123;</span><br><span class="line">            ret.<span class="built_in">push_back</span>(&#123;items1[i][<span class="number">0</span>], items1[i][<span class="number">1</span>]&#125;);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(j &lt; n2) &#123;</span><br><span class="line">            ret.<span class="built_in">push_back</span>(&#123;items2[j][<span class="number">0</span>], items2[j][<span class="number">1</span>]&#125;);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2373-矩阵中的局部最大值"><a href="#2373-矩阵中的局部最大值" class="headerlink" title="2373. 矩阵中的局部最大值"></a><a href="https://leetcode.cn/problems/largest-local-values-in-a-matrix/description/">2373. 矩阵中的局部最大值</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">largestLocal</span>(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; grid) &#123;</span><br><span class="line">        <span class="type">int</span> n = grid.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; ret = vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;(n<span class="number">-2</span>, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n<span class="number">-2</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n<span class="number">-1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; n<span class="number">-1</span>; j++) &#123;</span><br><span class="line">                ret[i<span class="number">-1</span>][j<span class="number">-1</span>] = <span class="built_in">max</span>(grid[i][j], <span class="built_in">max</span>(<span class="built_in">max</span>(<span class="built_in">max</span>(grid[i<span class="number">-1</span>][j], grid[i+<span class="number">1</span>][j]),<span class="built_in">max</span>(grid[i][j<span class="number">-1</span>], grid[i][j+<span class="number">1</span>])),<span class="built_in">max</span>(<span class="built_in">max</span>(grid[i+<span class="number">1</span>][j+<span class="number">1</span>], grid[i<span class="number">-1</span>][j<span class="number">-1</span>]),<span class="built_in">max</span>(grid[i<span class="number">-1</span>][j+<span class="number">1</span>], grid[i+<span class="number">1</span>][j<span class="number">-1</span>]))));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1828-统计一个圆中点的数目"><a href="#1828-统计一个圆中点的数目" class="headerlink" title="1828. 统计一个圆中点的数目"></a>1828. 统计一个圆中点的数目</h2><h3 id="暴力"><a href="#暴力" class="headerlink" title="暴力"></a>暴力</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">countPoints</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; points, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; xy = vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;(<span class="number">501</span>, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">501</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; p: points) &#123;</span><br><span class="line">            xy[p[<span class="number">0</span>]][p[<span class="number">1</span>]]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> n = queries.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ret</span><span class="params">(n, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">500</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt;= <span class="number">500</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(xy[i][j] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> k = <span class="number">0</span>; k &lt; n; k++) &#123;</span><br><span class="line">                        <span class="type">int</span> x = queries[k][<span class="number">0</span>], y = queries[k][<span class="number">1</span>], r = queries[k][<span class="number">2</span>];</span><br><span class="line">                        <span class="keyword">if</span>((i - x)*(i - x) + (j - y)*(j - y) &lt;= r*r) &#123;</span><br><span class="line">                            ret[k] += xy[i][j];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>注意不同点可能有相同的坐标</p></blockquote><h3 id="更暴力"><a href="#更暴力" class="headerlink" title="更暴力"></a>更暴力</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">countPoints</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; points, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; queries)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> m = points.<span class="built_in">size</span>(), n = queries.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; ret = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; m; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((queries[i][<span class="number">0</span>] - points[j][<span class="number">0</span>]) * (queries[i][<span class="number">0</span>] - points[j][<span class="number">0</span>]) + (queries[i][<span class="number">1</span>] - points[j][<span class="number">1</span>]) * (queries[i][<span class="number">1</span>] - points[j][<span class="number">1</span>]) &lt;= queries[i][<span class="number">2</span>] * queries[i][<span class="number">2</span>]) &#123;</span><br><span class="line">                    ret[i]++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="面试题-05-02-二进制数转字符串"><a href="#面试题-05-02-二进制数转字符串" class="headerlink" title="面试题 05.02. 二进制数转字符串"></a>面试题 05.02. 二进制数转字符串</h2><h3 id="乘2法"><a href="#乘2法" class="headerlink" title="乘2法"></a>乘2法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">printBin</span><span class="params">(<span class="type">double</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        string res = <span class="string">&quot;0.&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span>(; count &lt; <span class="number">30</span> &amp;&amp; num &gt; <span class="number">0</span>; count++) &#123;</span><br><span class="line">            num *= <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> bit = num;</span><br><span class="line">            res.<span class="built_in">push_back</span>(bit+<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            num -= bit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count &lt; <span class="number">30</span> ? res : <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ieee-754"><a href="#ieee-754" class="headerlink" title="ieee 754"></a>ieee 754</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">printBin</span><span class="params">(<span class="type">double</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *bit = (<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> *)&amp;num;</span><br><span class="line">        string res = <span class="built_in">string</span>(<span class="number">64</span>, <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">        <span class="type">int</span> i = <span class="number">63</span>;</span><br><span class="line">        <span class="keyword">for</span>(; ((*bit)&amp;<span class="number">1</span>)==<span class="number">0</span>; i--, (*bit) &gt;&gt;= <span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> last = i;</span><br><span class="line">        <span class="keyword">for</span>(; i &gt; <span class="number">11</span>; i--) &#123;</span><br><span class="line">            res[i - <span class="number">12</span>] += ((*bit)&amp;<span class="number">1</span>) + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            (*bit) &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> e = ((*bit) &amp; <span class="number">0x7ff</span>) - <span class="number">1023</span>;</span><br><span class="line">        string pre = <span class="string">&quot;0.&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(e &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">            pre += <span class="built_in">string</span>(-e<span class="number">-1</span>,<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pre += <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> last<span class="number">-12</span> &lt; <span class="number">32</span><span class="number">-3</span>-(-e<span class="number">-1</span>) ? pre+res : <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>分别计算浮点数的尾数，阶码，在判断能否用32位保存下来</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1144-递减元素使数组呈锯齿状&quot;&gt;&lt;a href=&quot;#1144-递减元素使数组呈锯齿状&quot; class=&quot;headerlink&quot; title=&quot;1144. 递减元素使数组呈锯齿状&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode.cn/problems/decrease-elements-to-make-array-zigzag/&quot;&gt;1144. 递减元素使数组呈锯齿状&lt;/a&gt;&lt;/h2&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;movesToMakeZigzag&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(vector&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;amp; nums)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; odd2less, even2less;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        odd2less = even2less = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; n = nums.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(n &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; n - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(i%&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[i] &amp;gt;= &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    even2less += nums[i] - &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[i] &amp;gt;= &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    odd2less += nums[i] - &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] &amp;gt;= nums[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            even2less += nums[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] - nums[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;] &amp;gt;= nums[n&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;((n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)%&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                even2less += nums[n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;] - nums[n&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                odd2less += nums[n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;] - nums[n&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(even2less, odd2less);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;遍历所有奇数，使其小于两端，记录操作数1&lt;br&gt;遍历所有偶数，使其小于两端，记录操作数2&lt;br&gt;返回最小值&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;优化代码行数&quot;&gt;&lt;a href=&quot;#优化代码行数&quot; class=&quot;headerlink&quot; title=&quot;优化代码行数&quot;&gt;&lt;/a&gt;优化代码行数&lt;/h3&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;movesToMakeZigzag&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(vector&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;amp; nums)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; op[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;] = &amp;#123;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&amp;#125;, n = nums.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(n &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i &amp;lt; n - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[i] &amp;gt;= &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                op[i&amp;amp;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] += nums[i] - &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(nums[i&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;], nums[i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] &amp;gt;= nums[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            op[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] += nums[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] - nums[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(nums[n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;] &amp;gt;= nums[n&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            op[(n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&amp;amp;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] += nums[n&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;] - nums[n&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;] + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;min&lt;/span&gt;(op[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;], op[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;2325-解密消息&quot;&gt;&lt;a href=&quot;#2325-解密消息&quot; class=&quot;headerlink&quot; title=&quot;2325. 解密消息&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode.cn/problems/decode-the-message/submissions/406636854/&quot;&gt;2325. 解密消息&lt;/a&gt;&lt;/h2&gt;</summary>
    
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/categories/LeetCode/"/>
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/tags/LeetCode/"/>
    
  </entry>
  
  <entry>
    <title>定位感兴趣的BB</title>
    <link href="https://jingtianer.github.io/home/2023/02/21/%E7%BB%84%E4%BC%9A/%E7%AC%AC%E4%B8%83%E5%91%A8%E8%AE%B0%E5%BD%95/"/>
    <id>https://jingtianer.github.io/home/2023/02/21/%E7%BB%84%E4%BC%9A/%E7%AC%AC%E4%B8%83%E5%91%A8%E8%AE%B0%E5%BD%95/</id>
    <published>2023-02-21T04:15:37.000Z</published>
    <updated>2023-02-24T06:44:38.758Z</updated>
    
    <content type="html"><![CDATA[<h2 id="BB定位"><a href="#BB定位" class="headerlink" title="BB定位"></a>BB定位</h2><ul><li>参考两篇论文<ul><li>[1] AmpFuzz: Fuzzing for Amplification DDoS Vulnerabilities</li><li>[2] Not All Coverage Measurements Are Equal: Fuzzing by Coverage Accounting for Input Prioritization</li></ul></li></ul><p>论文[1]中也是利用cfg定位感兴趣的BB，但是他之研究了DDos放大攻击，论文中将网络相关函数划分为三类</p><table><thead><tr><th>Class</th><th>Functions</th></tr></thead><tbody><tr><td>Source</td><td>recv, recvfrom, recvmsg, recvmmsg</td></tr><tr><td>Sink</td><td>send, sendfrom, sendmsg, sendmmsg</td></tr><tr><td>Blocking</td><td>select, pselect, poll, ppoll, epoll_wait, epoll_pwai</td></tr></tbody></table><p>我将代码中被调用的函数中，所有含有recv的函数作为<code>source</code>，含有send的函数作为<code>sink</code>，含有select、poll的作为<code>blocking</code>（先暂时这样，这样是显然有问题的，有些sendxxx, recvxxx可能并不是网络操作，后面手动剔除一下就好了）。</p><p>在gitlab的<code>issue</code>中搜索cve，查看其调用栈，找到其中易受攻击的函数，作为<code>vulnerable</code>，这里暂时没有对cve根据效果进行分类，筛选出DDos放大攻击</p><p>再结合论文[2]的coverage accounting，对于每条边<code>e</code>，统计其以下参数</p><ul><li>FUNC  : 边<code>e</code>的<code>dest基本块</code>中含有vulnerable函数调用的个数</li><li>SINK  ：边<code>e</code>的<code>dest基本块</code>是否满足论文[1]中<code>sink capable</code>的定义，满足则为1，否则为0</li><li>BB    ：边<code>e</code>的<code>dest基本块</code>中包含网络操作的指令条数</li></ul><blockquote><p>如果使用论文上严格的对<code>sink capable</code>定义，只能找到几个满足的BB</p></blockquote><h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><h3 id="脚本编码声明"><a href="#脚本编码声明" class="headerlink" title="脚本编码声明"></a>脚本编码声明</h3><ul><li>如果使用gcc，脚本首行需要声明脚本编码，g++则不需要<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=UTF-8</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Phi-node"><a href="#Phi-node" class="headerlink" title="Phi node"></a>Phi node</h3><p>gcc ssa\phi的介绍：<a href="https://gcc.gnu.org/onlinedocs/gccint/SSA.html">13.3 Static Single Assignment</a></p><blockquote><p>我的理解是phi_nodes是当在不同分支return不同变量时，为了使return时返回的都是同一个变量<br>语句的处理应该不加phi_node</p></blockquote><h3 id="inline-assembler-code"><a href="#inline-assembler-code" class="headerlink" title="inline assembler code"></a>inline assembler code</h3><p>inline asm的介绍：<a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">Extended Asm - Assembler Instructions with C Expression Operands</a></p><blockquote><p>c&#x2F;c++中可以使用asm关键词，在c&#x2F;c++代码中嵌入特殊的汇编指令。这种指令可以直接访问c&#x2F;c++中的变量</p></blockquote><h2 id="bugs-call-stack"><a href="#bugs-call-stack" class="headerlink" title="bugs call stack"></a>bugs call stack</h2><table><thead><tr><th>cve</th><th>call stack</th><th>分类</th></tr></thead><tbody><tr><td>CVE-2022-3080</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3517">https://gitlab.isc.org/isc-projects/bind9/-/issues/3517</a></td><td>断言 isc_assertion_failed()</td></tr><tr><td>CVE-2022-3736</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3622">https://gitlab.isc.org/isc-projects/bind9/-/issues/3622</a></td><td>断言</td></tr><tr><td>CVE-2022-3924</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3619">https://gitlab.isc.org/isc-projects/bind9/-/issues/3619</a></td><td>RUNTIME_CHECK()</td></tr><tr><td>CVE-2022-2881</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3493">https://gitlab.isc.org/isc-projects/bind9/-/issues/3493</a></td><td>buffer exceed</td></tr><tr><td>CVE-2022-2906</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3491">https://gitlab.isc.org/isc-projects/bind9/-/issues/3491</a></td><td>内存泄漏，__interceptor_malloc()</td></tr><tr><td>CVE-2022-38177</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3487">https://gitlab.isc.org/isc-projects/bind9/-/issues/3487</a></td><td>内存泄漏 malloc() CRYPTO_zalloc() BN_MONT_CTX_new() EC_GROUP_set_seed()</td></tr><tr><td>CVE-2022-1183</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3216">https://gitlab.isc.org/isc-projects/bind9/-/issues/3216</a></td><td>断言</td></tr><tr><td>CVE-2022-0667</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/3129">https://gitlab.isc.org/isc-projects/bind9/-/issues/3129</a></td><td>断言</td></tr><tr><td>CVE-2021-25219</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/2899">https://gitlab.isc.org/isc-projects/bind9/-/issues/2899</a></td><td>dns_name_equal() entry_is_lame() 添加entry的算法是 $ O(n) $</td></tr><tr><td>CVE-2021-25218</td><td><a href="https://gitlab.isc.org/isc-projects/bind9/-/issues/2856">https://gitlab.isc.org/isc-projects/bind9/-/issues/2856</a></td><td>断言</td></tr></tbody></table><p>在bind9的issue中搜索cve，查看了issue中的调用栈，发现断言和内存操作出现次数最多</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;BB定位&quot;&gt;&lt;a href=&quot;#BB定位&quot; class=&quot;headerlink&quot; title=&quot;BB定位&quot;&gt;&lt;/a&gt;BB定位&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;参考两篇论文&lt;ul&gt;
&lt;li&gt;[1] AmpFuzz: Fuzzing for Amplification DDoS Vulnerabilities&lt;/li&gt;
&lt;li&gt;[2] Not All Coverage Measurements Are Equal: Fuzzing by Coverage Accounting for Input Prioritization&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;论文[1]中也是利用cfg定位感兴趣的BB，但是他之研究了DDos放大攻击，论文中将网络相关函数划分为三类&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Class&lt;/th&gt;
&lt;th&gt;Functions&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;Source&lt;/td&gt;
&lt;td&gt;recv, recvfrom, recvmsg, recvmmsg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Sink&lt;/td&gt;
&lt;td&gt;send, sendfrom, sendmsg, sendmmsg&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Blocking&lt;/td&gt;
&lt;td&gt;select, pselect, poll, ppoll, epoll_wait, epoll_pwai&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;我将代码中被调用的函数中，所有含有recv的函数作为&lt;code&gt;source&lt;/code&gt;，含有send的函数作为&lt;code&gt;sink&lt;/code&gt;，含有select、poll的作为&lt;code&gt;blocking&lt;/code&gt;（先暂时这样，这样是显然有问题的，有些sendxxx, recvxxx可能并不是网络操作，后面手动剔除一下就好了）。&lt;/p&gt;
&lt;p&gt;在gitlab的&lt;code&gt;issue&lt;/code&gt;中搜索cve，查看其调用栈，找到其中易受攻击的函数，作为&lt;code&gt;vulnerable&lt;/code&gt;，这里暂时没有对cve根据效果进行分类，筛选出DDos放大攻击&lt;/p&gt;</summary>
    
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/categories/%E7%BB%84%E4%BC%9A/"/>
    
    
    <category term="组会" scheme="https://jingtianer.github.io/home/tags/%E7%BB%84%E4%BC%9A/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-22</title>
    <link href="https://jingtianer.github.io/home/2023/02/20/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9322/"/>
    <id>https://jingtianer.github.io/home/2023/02/20/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9322/</id>
    <published>2023-02-20T03:14:34.000Z</published>
    <updated>2023-03-01T09:17:05.965Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2347-最好的扑克手牌"><a href="#2347-最好的扑克手牌" class="headerlink" title="2347. 最好的扑克手牌"></a><a href="https://leetcode.cn/problems/best-poker-hand/">2347. 最好的扑克手牌</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">bestHand</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; ranks, vector&lt;<span class="type">char</span>&gt;&amp; suits)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">rank_count</span><span class="params">(<span class="number">13</span>, <span class="number">0</span>)</span>, <span class="title">suits_count</span><span class="params">(<span class="number">4</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            rank_count[ranks[i]<span class="number">-1</span>]++;</span><br><span class="line">            suits_count[suits[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            count = <span class="built_in">max</span>(count, suits_count[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">5</span>) <span class="keyword">return</span> <span class="string">&quot;Flush&quot;</span>;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">13</span>; i++) &#123;</span><br><span class="line">            count = <span class="built_in">max</span>(count, rank_count[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(count &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Three of a Kind&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Pair&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;High Card&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1604-警告一小时内使用相同员工卡大于等于三次的人"><a href="#1604-警告一小时内使用相同员工卡大于等于三次的人" class="headerlink" title="1604. 警告一小时内使用相同员工卡大于等于三次的人"></a><a href="https://leetcode.cn/problems/alert-using-same-key-card-three-or-more-times-in-a-one-hour-period/">1604. 警告一小时内使用相同员工卡大于等于三次的人</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">alertNames</span><span class="params">(vector&lt;string&gt;&amp; keyName, vector&lt;string&gt;&amp; keyTime)</span> </span>&#123;</span><br><span class="line">        map&lt;string, vector&lt;<span class="type">int</span>&gt;&gt; hour_count;</span><br><span class="line">        <span class="type">int</span> len = keyName.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">int</span> h = (keyTime[i][<span class="number">0</span>]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">10</span> + keyTime[i][<span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span>, m = (keyTime[i][<span class="number">3</span>] - <span class="string">&#x27;0&#x27;</span>) * <span class="number">10</span> + keyTime[i][<span class="number">4</span>] - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            hour_count[keyName[i]].<span class="built_in">push_back</span>(h*<span class="number">60</span>+m);</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;string&gt; warning_list;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> ite = hour_count.<span class="built_in">begin</span>(); ite != hour_count.<span class="built_in">end</span>(); ite++) &#123;</span><br><span class="line">            <span class="type">bool</span> warn = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">sort</span>(ite-&gt;second.<span class="built_in">begin</span>(), ite-&gt;second.<span class="built_in">end</span>());</span><br><span class="line">            <span class="type">int</span> len = ite-&gt;second.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len<span class="number">-2</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(ite-&gt;second[i+<span class="number">2</span>] - ite-&gt;second[i] &lt;= <span class="number">60</span>) &#123;</span><br><span class="line">                    warn = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(warn) &#123;</span><br><span class="line">                warning_list.<span class="built_in">push_back</span>(ite-&gt;first);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> warning_list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">alertNames</span><span class="params">(vector&lt;string&gt;&amp; keyName, vector&lt;string&gt;&amp; keyTime)</span> </span>&#123;</span><br><span class="line">        map&lt;string, priority_queue&lt;<span class="type">int</span>&gt;&gt; hour_count;</span><br><span class="line">        <span class="type">int</span> len = keyName.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="type">int</span> h = (keyTime[i][<span class="number">0</span>]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">10</span> + keyTime[i][<span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span>, m = (keyTime[i][<span class="number">3</span>] - <span class="string">&#x27;0&#x27;</span>) * <span class="number">10</span> + keyTime[i][<span class="number">4</span>] - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            hour_count[keyName[i]].<span class="built_in">push</span>(h*<span class="number">60</span>+m);</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;string&gt; warning_list;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> ite = hour_count.<span class="built_in">begin</span>(); ite != hour_count.<span class="built_in">end</span>(); ite++) &#123;</span><br><span class="line">            <span class="type">int</span> len = ite-&gt;second.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">if</span>(len &lt;= <span class="number">2</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="type">int</span> a, b, c;</span><br><span class="line">            a = ite-&gt;second.<span class="built_in">top</span>();</span><br><span class="line">            ite-&gt;second.<span class="built_in">pop</span>();</span><br><span class="line">            b = ite-&gt;second.<span class="built_in">top</span>();</span><br><span class="line">            ite-&gt;second.<span class="built_in">pop</span>();</span><br><span class="line">            c = ite-&gt;second.<span class="built_in">top</span>();</span><br><span class="line">            ite-&gt;second.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="type">bool</span> warn = a - c &lt;= <span class="number">60</span>;</span><br><span class="line">            <span class="keyword">while</span>(!warn &amp;&amp; !ite-&gt;second.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                a = b;</span><br><span class="line">                b = c;</span><br><span class="line">                c = ite-&gt;second.<span class="built_in">top</span>();</span><br><span class="line">                ite-&gt;second.<span class="built_in">pop</span>();</span><br><span class="line">                warn = a - c &lt;= <span class="number">60</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(warn) &#123;</span><br><span class="line">                warning_list.<span class="built_in">push_back</span>(ite-&gt;first);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> warning_list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="2331-计算布尔二叉树的值"><a href="#2331-计算布尔二叉树的值" class="headerlink" title="2331. 计算布尔二叉树的值"></a><a href="https://leetcode.cn/problems/evaluate-boolean-binary-tree/">2331. 计算布尔二叉树的值</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">evaluateTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;val &lt;= <span class="number">1</span>) <span class="keyword">return</span> root-&gt;val == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> left = <span class="built_in">evaluateTree</span>(root-&gt;left);</span><br><span class="line">        <span class="type">bool</span> right = <span class="built_in">evaluateTree</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">return</span> root-&gt;val == <span class="number">2</span> ? left||right : left&amp;&amp;right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1798-你能构造出连续值的最大数目"><a href="#1798-你能构造出连续值的最大数目" class="headerlink" title="1798. 你能构造出连续值的最大数目"></a><a href="https://leetcode.cn/problems/maximum-number-of-consecutive-values-you-can-make/">1798. 你能构造出连续值的最大数目</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getMaximumConsecutive</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; coins)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">sort</span>(coins.<span class="built_in">begin</span>(), coins.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : coins) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; res) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res += i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>直接抄的答案，贪心，代码的意思就是排序，从小到大加起来<br>没注意到题目条件要求是从0开始的，这一点很重要<br>若最大只能到1，则数组为 [1]<br>若最大只能到2，则数组为 [1 1] (不能是[2]，因为这样没有无法组出1)<br>若最大只能到3，则数组为 [1 1 1], [1 2]<br>若最大只能到4，则数组为 [1 1 1 1], [1 1 2]<br>若最大只能到5，则数组为 [1 1 1 1 1], [1 1 1 2], [1 1 3]</p><p>观察上面列表可知，若最大只能到5，则是最大到4在多额外的1，或者最大到2且额外的一个3，这里就能看到令res初始为1，将数组排序后，相加，直到coins[i] &gt; res为止</p></blockquote><h2 id="1145-二叉树着色游戏"><a href="#1145-二叉树着色游戏" class="headerlink" title="1145. 二叉树着色游戏"></a><a href="https://leetcode.cn/problems/binary-tree-coloring-game/">1145. 二叉树着色游戏</a></h2><blockquote><p>这道题的提议是，第一步red先手，blue后手选择二叉树中的一个节点<br>选择后的每一步，两个玩家只能选择当前所选所有节点的未涂色的邻接节点<br>“我”作为后手的二号节点，如何选择我的第一个节点，让我能涂色的节点大于先手的red<br>为了利益最大化，只有三种选择，选择<code>x</code>的父节点，左孩子或右孩子<br>选择父节点，则x及x所有子节点都会被red涂色，自己只能涂色n-red个<br>选择左孩子，自己只能涂色x的左孩子以及左孩子的所有子代节点<br>选择右孩子，与左孩子同理<br>以上三种情况，分别计算red和blue，只要有一种情况可以使得<code>red &lt; blue</code>，则blue一定可以胜利，否则一定不能胜利</p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">btreeGameWinningMove</span><span class="params">(TreeNode* root, <span class="type">int</span> root_sum, <span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">        TreeNode* find = <span class="built_in">search</span>(root, x);</span><br><span class="line">        <span class="type">int</span> red = <span class="built_in">sum</span>(find);</span><br><span class="line">        <span class="keyword">if</span>(red &lt; root_sum - red) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> blue = <span class="built_in">sum</span>(find-&gt;left);</span><br><span class="line">        <span class="keyword">if</span>(root_sum - blue &lt; blue) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        blue = <span class="built_in">sum</span>(find-&gt;right);</span><br><span class="line">        <span class="keyword">if</span>(root_sum - blue &lt; blue) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">sum</span><span class="params">(TreeNode* node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">sum</span>(node-&gt;left) + <span class="built_in">sum</span>(node-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">search</span><span class="params">(TreeNode* node, <span class="type">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;val == target) &#123;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode* find = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;left != <span class="literal">nullptr</span>)</span><br><span class="line">            find = <span class="built_in">search</span>(node-&gt;left, target);</span><br><span class="line">        <span class="keyword">if</span>(find != <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> find;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;right != <span class="literal">nullptr</span>)</span><br><span class="line">            find = <span class="built_in">search</span>(node-&gt;right, target);</span><br><span class="line">        <span class="keyword">return</span> find;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>认真读题发现n就是总节点数，不用再算一遍了</p></blockquote><h2 id="1129-颜色交替的最短路径"><a href="#1129-颜色交替的最短路径" class="headerlink" title="1129. 颜色交替的最短路径"></a><a href="https://leetcode.cn/problems/shortest-path-with-alternating-colors/">1129. 颜色交替的最短路径</a></h2><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> RED = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> BLUE = <span class="literal">false</span>;</span><br><span class="line">    vector&lt;vector&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt;&gt; graph;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; answer;</span><br><span class="line">    vector&lt;map&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;, <span class="type">bool</span>&gt;&gt; visited;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">shortestAlternatingPaths</span><span class="params">(<span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; redEdges, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; blueEdges)</span> </span>&#123;</span><br><span class="line">        visited = vector&lt;map&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;, <span class="type">bool</span>&gt;&gt;(n);</span><br><span class="line">        graph = vector&lt;vector&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt;&gt;(n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: redEdges) &#123;</span><br><span class="line">            visited[edge[<span class="number">0</span>]][<span class="built_in">make_pair</span>(RED, edge[<span class="number">1</span>])] = <span class="literal">false</span>;</span><br><span class="line">            graph[edge[<span class="number">0</span>]].<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(RED, edge[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: blueEdges) &#123;</span><br><span class="line">            visited[edge[<span class="number">0</span>]][<span class="built_in">make_pair</span>(BLUE, edge[<span class="number">1</span>])] = <span class="literal">false</span>;</span><br><span class="line">            graph[edge[<span class="number">0</span>]].<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(BLUE, edge[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        answer = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n, INT_MAX);</span><br><span class="line">        <span class="built_in">search</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(answer[i] == INT_MAX) answer[i] = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        answer[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">search</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">        queue&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt; q;</span><br><span class="line">        q.<span class="built_in">push</span>(<span class="built_in">make_pair</span>(RED, <span class="number">0</span>));</span><br><span class="line">        q.<span class="built_in">push</span>(<span class="built_in">make_pair</span>(BLUE, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            queue&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt; tmp;</span><br><span class="line">            <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> [color, node] = q.<span class="built_in">front</span>();</span><br><span class="line">                q.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge:graph[node]) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(edge.first != color &amp;&amp; !visited[node][edge]) &#123;</span><br><span class="line">                        answer[edge.second] = <span class="built_in">min</span>(answer[edge.second], len+<span class="number">1</span>);</span><br><span class="line">                        tmp.<span class="built_in">push</span>(edge);</span><br><span class="line">                        visited[node][edge] = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            len++;</span><br><span class="line">            q = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>不必重复遍历边<br>由于自环，平行边的存在，同一个节点可以重复遍历，这样可以凑出红蓝交替的路径<br>对于边，定义为<code>pair&lt;bool, int&gt;</code>，代表<code>&lt;color, next&gt;</code><br>bfs时，选取与上一条边颜色相反的边入队</p></blockquote><h3 id="dfs"><a href="#dfs" class="headerlink" title="dfs"></a>dfs</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> RED = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> BLUE = <span class="literal">false</span>;</span><br><span class="line">    vector&lt;vector&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt;&gt; graph;</span><br><span class="line">    vector&lt;map&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;, <span class="type">bool</span>&gt;&gt; visited;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">shortestAlternatingPaths</span><span class="params">(<span class="type">int</span> n, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; redEdges, vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; blueEdges)</span> </span>&#123;</span><br><span class="line">        graph = vector&lt;vector&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;&gt;&gt;(n);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: redEdges) &#123;</span><br><span class="line">            graph[edge[<span class="number">0</span>]].<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(RED, edge[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: blueEdges) &#123;</span><br><span class="line">            graph[edge[<span class="number">0</span>]].<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(BLUE, edge[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">answer</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            visited = vector&lt;map&lt;pair&lt;<span class="type">bool</span>, <span class="type">int</span>&gt;, <span class="type">bool</span>&gt;&gt;(n);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: redEdges) &#123;</span><br><span class="line">                visited[edge[<span class="number">0</span>]][<span class="built_in">make_pair</span>(RED, edge[<span class="number">1</span>])] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge: blueEdges) &#123;</span><br><span class="line">                visited[edge[<span class="number">0</span>]][<span class="built_in">make_pair</span>(BLUE, edge[<span class="number">1</span>])] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            answer[i] = <span class="built_in">min</span>(<span class="built_in">search</span>(<span class="number">0</span>, i, <span class="number">0</span>, RED), <span class="built_in">search</span>(<span class="number">0</span>, i, <span class="number">0</span>, BLUE));</span><br><span class="line">            <span class="keyword">if</span>(answer[i] == INT_MAX) answer[i] = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">search</span><span class="params">(<span class="type">int</span> node, <span class="type">int</span> target, <span class="type">int</span> len, <span class="type">bool</span> last_color)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node == target) <span class="keyword">return</span> len;</span><br><span class="line">        <span class="type">int</span> find = INT_MAX;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; edge : graph[node]) &#123;</span><br><span class="line">            <span class="keyword">if</span>(edge.first != last_color &amp;&amp; !visited[node][edge]) &#123;</span><br><span class="line">                visited[node][edge] = <span class="literal">true</span>;</span><br><span class="line">                find = <span class="built_in">min</span>(<span class="built_in">search</span>(edge.second, target, len+<span class="number">1</span>, edge.first), find);</span><br><span class="line">                visited[node][edge] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> find;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>超时，但应该是正确的<br>复杂度 $ O(n^2) $</p></blockquote><h2 id="1806-还原排列的最少操作步数"><a href="#1806-还原排列的最少操作步数" class="headerlink" title="1806. 还原排列的最少操作步数"></a><a href="https://leetcode.cn/problems/minimum-number-of-operations-to-reinitialize-a-permutation/">1806. 还原排列的最少操作步数</a></h2><h3 id="模拟"><a href="#模拟" class="headerlink" title="模拟"></a>模拟</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reinitializePermutation</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;n = n;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">arr</span><span class="params">(n)</span>,<span class="title">tmp</span><span class="params">(n)</span>, *x, *y</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            arr[i] = i%<span class="number">2</span> == <span class="number">0</span> ? i/<span class="number">2</span> : n/<span class="number">2</span>+(i<span class="number">-1</span>)/<span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> step = <span class="number">1</span>;</span><br><span class="line">        x = &amp;arr;</span><br><span class="line">        y = &amp;tmp;</span><br><span class="line">        <span class="keyword">while</span>(!<span class="built_in">ok</span>(x)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                (*y)[i] = i%<span class="number">2</span> == <span class="number">0</span> ? (*x)[i/<span class="number">2</span>] : (*x)[n/<span class="number">2</span>+(i<span class="number">-1</span>)/<span class="number">2</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">swap</span>(x, y);</span><br><span class="line">            step++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> step;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ok</span><span class="params">(vector&lt;<span class="type">int</span>&gt;* arr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>((*arr)[i] != i) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="模拟2"><a href="#模拟2" class="headerlink" title="模拟2"></a>模拟2</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reinitializePermutation</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;n = n;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">arr</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            arr[i] = i%<span class="number">2</span> == <span class="number">0</span> ? i/<span class="number">2</span> : n/<span class="number">2</span>+(i<span class="number">-1</span>)/<span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> step = <span class="number">1</span>, p = arr[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">while</span>(p != <span class="number">1</span>) &#123;</span><br><span class="line">            p = arr[p];            </span><br><span class="line">            step++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> step;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="238-除自身以外数组的乘积"><a href="#238-除自身以外数组的乘积" class="headerlink" title="238. 除自身以外数组的乘积"></a><a href="https://leetcode.cn/problems/product-of-array-except-self/">238. 除自身以外数组的乘积</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">productExceptSelf</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">l</span><span class="params">(len, <span class="number">1</span>)</span>, <span class="title">r</span><span class="params">(len,<span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">            l[i] = l[i<span class="number">-1</span>] * nums[i<span class="number">-1</span>];</span><br><span class="line">            r[len-i<span class="number">-1</span>] = r[len-i] * nums[len-i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            nums[i] = l[i]*r[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="空间O-1"><a href="#空间O-1" class="headerlink" title="空间O(1)"></a>空间O(1)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">productExceptSelf</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">res</span><span class="params">(len, <span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">            res[len-i<span class="number">-1</span>] = res[len-i] * nums[len-i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> left = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            res[i] = left*res[i];</span><br><span class="line">            left *= nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>他这里对 $ O(1) $ 的定义是除了输入输出数组外，只用常量级的空间，很容易想到l数组可以优化</p></blockquote><h2 id="2357-使数组中所有元素都等于零"><a href="#2357-使数组中所有元素都等于零" class="headerlink" title="2357. 使数组中所有元素都等于零"></a><a href="https://leetcode.cn/problems/make-array-zero-by-subtracting-equal-amounts/description/">2357. 使数组中所有元素都等于零</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minimumOperations</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> n:nums) &#123;</span><br><span class="line">            <span class="keyword">if</span>(n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                m[n]++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> ite=m.<span class="built_in">begin</span>(); ite != m.<span class="built_in">end</span>(); ite++,count++);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1238-循环码排列"><a href="#1238-循环码排列" class="headerlink" title="1238. 循环码排列"></a><a href="https://leetcode.cn/problems/circular-permutation-in-binary-representation/description/">1238. 循环码排列</a></h2><h3 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; res;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">circularPermutation</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">        res = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(len);</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">rotate</span><span class="params">(len)</span></span>;</span><br><span class="line">        <span class="type">int</span> split = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; split; j++) &#123;</span><br><span class="line">                <span class="built_in">cal</span>(len/split*j, len/split*(j+<span class="number">1</span>), a);</span><br><span class="line">                <span class="keyword">if</span>(j%<span class="number">2</span>==<span class="number">0</span>) a = !a;</span><br><span class="line">            &#125;</span><br><span class="line">            split &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(k &lt; len &amp;&amp; res[k] != start) k++;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            rotate[i] = res[(i+k)%len];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rotate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">cal</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(; i &lt; j; i++) &#123;</span><br><span class="line">            res[i] &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            res[i] += a&amp;<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>把他想成一个二叉树，每层按照0110的顺序生成</p></blockquote><h3 id="二叉树1"><a href="#二叉树1" class="headerlink" title="二叉树1"></a>二叉树1</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; res;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">circularPermutation</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">rotate</span><span class="params">(len)</span></span>;</span><br><span class="line">        </span><br><span class="line">        queue&lt;TreeNode*&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            q.<span class="built_in">push</span>(<span class="keyword">new</span> <span class="built_in">TreeNode</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode* root = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            TreeNode *n1 = q.<span class="built_in">front</span>(), *n2 = <span class="literal">nullptr</span>;</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">if</span>(!q.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                n2 = q.<span class="built_in">front</span>();</span><br><span class="line">                q.<span class="built_in">pop</span>();</span><br><span class="line">                q.<span class="built_in">push</span>(<span class="keyword">new</span> <span class="built_in">TreeNode</span>(n1-&gt;val + n2-&gt;val, n1, n2));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                root = n1;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">flip</span>(root);</span><br><span class="line">        <span class="built_in">treavourse</span>(root);</span><br><span class="line">        <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(k &lt; len &amp;&amp; res[k] != start) k++;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            rotate[i] = res[(i+k)%len];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rotate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">treavourse</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;left != <span class="literal">nullptr</span> &amp;&amp; root-&gt;right != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">treavourse</span>(root-&gt;left);</span><br><span class="line">            <span class="built_in">treavourse</span>(root-&gt;right);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">flip</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root-&gt;left == <span class="literal">nullptr</span> || root-&gt;right == <span class="literal">nullptr</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">swap</span>(root-&gt;right-&gt;left, root-&gt;right-&gt;right);</span><br><span class="line">        <span class="built_in">flip</span>(root-&gt;left);</span><br><span class="line">        <span class="built_in">flip</span>(root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>翻转二叉树，<code>先序</code>把右孩子的左右孩子互换</p></blockquote><h3 id="格雷码"><a href="#格雷码" class="headerlink" title="格雷码"></a>格雷码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; res;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">circularPermutation</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="number">1</span> &lt;&lt; n;</span><br><span class="line">        res = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(len);</span><br><span class="line">        <span class="type">int</span> split = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; split; j++) &#123;</span><br><span class="line">                <span class="built_in">cal</span>(len/split*j, len/split*(j+<span class="number">1</span>), a);</span><br><span class="line">                <span class="keyword">if</span>(j%<span class="number">2</span>==<span class="number">0</span>) a = !a;</span><br><span class="line">            &#125;</span><br><span class="line">            split &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            res[i] = res[i] ^ start;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">cal</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(; i &lt; j; i++) &#123;</span><br><span class="line">            res[i] &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            res[i] += a&amp;<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>格雷码有他的生成公式</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">circularPermutation</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ret</span><span class="params">(<span class="number">1</span> &lt;&lt; n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ret.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            ret[i] = (i &gt;&gt; <span class="number">1</span>) ^ i ^ start;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1326-灌溉花园的最少水龙头数目"><a href="#1326-灌溉花园的最少水龙头数目" class="headerlink" title="1326. 灌溉花园的最少水龙头数目"></a><a href="https://leetcode.cn/problems/minimum-number-of-taps-to-open-to-water-a-garden/description/">1326. 灌溉花园的最少水龙头数目</a></h2><h3 id="dp"><a href="#dp" class="headerlink" title="dp"></a>dp</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minTaps</span><span class="params">(<span class="type">int</span> n, vector&lt;<span class="type">int</span>&gt;&amp; ranges)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">dp</span><span class="params">(n+<span class="number">1</span>, INT_MAX)</span>, <span class="title">index</span><span class="params">(n+<span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= n; i++) index[i] = i;</span><br><span class="line">        <span class="built_in">sort</span>(index.<span class="built_in">begin</span>(), index.<span class="built_in">end</span>(), [&amp;ranges](<span class="type">int</span> i, <span class="type">int</span> j)-&gt;<span class="type">bool</span>&#123;<span class="keyword">return</span> i-ranges[i] &lt; j-ranges[j];&#125;);</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> start = <span class="built_in">max</span>(index[i] - ranges[index[i]], <span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> end = <span class="built_in">min</span>(index[i] + ranges[index[i]], n);</span><br><span class="line">            <span class="keyword">if</span>(dp[start] == INT_MAX) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j = start; j &lt;= end; j++) &#123;</span><br><span class="line">                dp[j] = <span class="built_in">min</span>(dp[start]+<span class="number">1</span>, dp[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>$dp[i]$表示区间$[0, i]$被灌溉所需的最少水龙头数<br>将$ranges[i]$按照$i-ranges[i]$从小到大排序<br>按顺序遍历排序好的ranges，计算其$start,end$<br>$start$处已经计算出其所需最小水龙头数了，有两种情况</p><ul><li>当前$ [0, x] $已知, $ start &lt;&#x3D; end &lt;&#x3D; x $, 则$[start, end]$之间最少水龙头数保持不变</li><li>当前$ [0, x] $已知, $ start &lt;&#x3D; x &lt; end $, 则$[start+1, end]$之间最少水龙头数为$dp[start]+1$</li><li>当前$ [0, x] $已知, $ x &lt; start &lt;&#x3D; end $, 则无解</li></ul></blockquote><h3 id="贪心"><a href="#贪心" class="headerlink" title="贪心"></a>贪心</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minTaps</span><span class="params">(<span class="type">int</span> n, vector&lt;<span class="type">int</span>&gt;&amp; ranges)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">right</span><span class="params">(n+<span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= n; i++) right[<span class="built_in">max</span>(<span class="number">0</span>, i-ranges[i])] = <span class="built_in">max</span>(<span class="built_in">min</span>(i + ranges[i],n), right[<span class="built_in">max</span>(<span class="number">0</span>, i-ranges[i])]);</span><br><span class="line">        <span class="type">int</span> last = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> pre = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            last = <span class="built_in">max</span>(last, right[i]);</span><br><span class="line">            <span class="keyword">if</span>(i == last) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span>(i == pre) &#123;</span><br><span class="line">                ret++;</span><br><span class="line">                pre = last;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>$right[start]$表示从$start$位置，经过某个水龙头的浇灌最远能到达的位置<br>$last$表示当前最远到达的位置，$pre$表示上一个使用的水龙头最远的位置<br>从左向右遍历，一边遍历一遍寻找最远能到达的位置，如果$i$到达了最远能到达的位置且不是n，说明无法覆盖。如果i遇到了前一个水龙头的边界，说明接下来该使用下一个水龙头了</p></blockquote><h2 id="1247-交换字符使得字符串相同"><a href="#1247-交换字符使得字符串相同" class="headerlink" title="1247. 交换字符使得字符串相同"></a><a href="https://leetcode.cn/problems/minimum-swaps-to-make-strings-equal/description/">1247. 交换字符使得字符串相同</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minimumSwap</span><span class="params">(string s1, string s2)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> count[<span class="number">2</span>][<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> len = s1.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i= <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(s1[i] == <span class="string">&#x27;x&#x27;</span> &amp;&amp; s2[i] == <span class="string">&#x27;y&#x27;</span>) &#123;</span><br><span class="line">                count[<span class="number">0</span>][<span class="number">1</span>]++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(s1[i] == <span class="string">&#x27;y&#x27;</span> &amp;&amp; s2[i] == <span class="string">&#x27;x&#x27;</span>) &#123;</span><br><span class="line">                count[<span class="number">1</span>][<span class="number">0</span>]++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> res = count[<span class="number">0</span>][<span class="number">1</span>]/<span class="number">2</span> + count[<span class="number">1</span>][<span class="number">0</span>]/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(count[<span class="number">0</span>][<span class="number">1</span>]%<span class="number">2</span> == <span class="number">1</span> &amp;&amp; count[<span class="number">1</span>][<span class="number">0</span>]%<span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            res+=<span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(count[<span class="number">0</span>][<span class="number">1</span>]%<span class="number">2</span> || count[<span class="number">1</span>][<span class="number">0</span>]%<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>根据题目的样例 “xx”+”yy”型(“yy”+”xx”型)，只需要一步<br>“xy”+”yx”型(“yx”+”xy”型)，需要两步<br>交换时可以两个字符串上任意两个位置进行交换。</p></blockquote><h2 id="1703-得到连续-K-个-1-的最少相邻交换次数"><a href="#1703-得到连续-K-个-1-的最少相邻交换次数" class="headerlink" title="1703. 得到连续 K 个 1 的最少相邻交换次数"></a><a href="https://leetcode.cn/problems/minimum-adjacent-swaps-for-k-consecutive-ones/">1703. 得到连续 K 个 1 的最少相邻交换次数</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> k;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minMoves</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;k = k;</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; index, wait;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] == <span class="number">1</span>) &#123;</span><br><span class="line">                index.<span class="built_in">push</span>(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            wait.<span class="built_in">push</span>(index.<span class="built_in">front</span>());</span><br><span class="line">            index.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> minn = <span class="built_in">cal</span>(wait);</span><br><span class="line">        <span class="keyword">while</span>(!index.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            wait.<span class="built_in">push</span>(index.<span class="built_in">front</span>());</span><br><span class="line">            index.<span class="built_in">pop</span>();</span><br><span class="line">            wait.<span class="built_in">pop</span>();</span><br><span class="line">            minn = <span class="built_in">min</span>(<span class="built_in">cal</span>(wait), minn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> minn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">cal</span><span class="params">(queue&lt;<span class="type">int</span>&gt; q)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>, count = <span class="number">1</span>, last = q.<span class="built_in">front</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; k/<span class="number">2</span>; i++) &#123;</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            l += count * (q.<span class="built_in">front</span>() - last - <span class="number">1</span>);</span><br><span class="line">            count++;</span><br><span class="line">            last  = q.<span class="built_in">front</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        last = q.<span class="built_in">front</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = k/<span class="number">2</span>; i &lt; k<span class="number">-1</span>; i++) &#123;</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            r += (k - i - <span class="number">1</span>) * (q.<span class="built_in">front</span>() - last - <span class="number">1</span>);</span><br><span class="line">            last  = q.<span class="built_in">front</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l + r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>两个队列 <code>index</code> 和 <code>que</code><br>index存放值为1的下表<br>从index取k个放入que<br>计算que的长度<br>que中pop一个，index也pop一个放入index，再次计算index，直到index为空<br>取每次计算que的最小值<br>que计算长度时，从中间一分为二，将两边的1向最中间的1靠拢移动。</p></blockquote><h3 id="优化1"><a href="#优化1" class="headerlink" title="优化1"></a>优化1</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> k;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minMoves</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, count = <span class="number">0</span>, n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;k = k;</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">index</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="type">int</span> minn = INT_MAX;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] == <span class="number">1</span>) &#123;</span><br><span class="line">                index[j] = i;</span><br><span class="line">                j++;</span><br><span class="line">                <span class="keyword">if</span>(j &gt;= k) &#123;</span><br><span class="line">                    minn = <span class="built_in">min</span>(<span class="built_in">cal</span>(<span class="built_in">move</span>(index), count), minn);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> minn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">cal</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp;&amp; v, <span class="type">int</span> start)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> li = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = k/<span class="number">2</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">            li += (v[i+start] - v[i+start<span class="number">-1</span>] - <span class="number">1</span>);</span><br><span class="line">            l += li;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ri = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = k/<span class="number">2</span>; i &lt; k<span class="number">-1</span>; i++) &#123;</span><br><span class="line">            ri += (v[i+start+<span class="number">1</span>] - v[i+start] - <span class="number">1</span>);</span><br><span class="line">            r += ri;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l + r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minMoves</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> minn = <span class="number">0</span>, cost = <span class="number">0</span>;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; left&#123;<span class="number">0</span>&#125;, zero;</span><br><span class="line">        <span class="type">int</span> leftSum = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(; i &lt; n &amp;&amp; nums[i] == <span class="number">0</span>; i++);</span><br><span class="line">        <span class="keyword">for</span>(; i &lt; n;) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="type">int</span> count;</span><br><span class="line">            <span class="keyword">for</span>(count = <span class="number">0</span>; i &lt; n &amp;&amp; nums[i] == <span class="number">0</span>; i++, count++);</span><br><span class="line">            leftSum += count;</span><br><span class="line">            <span class="keyword">if</span>(i &lt; n) &#123;</span><br><span class="line">                zero.<span class="built_in">push_back</span>(count);</span><br><span class="line">                left.<span class="built_in">push_back</span>(leftSum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> l = <span class="number">0</span>, r = k<span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = l; i &lt;= r; i++) &#123;</span><br><span class="line">            cost += zero[i] * <span class="built_in">min</span>(<span class="number">1</span>+i, <span class="number">1</span>+r-i);</span><br><span class="line">        &#125;</span><br><span class="line">        minn=cost;</span><br><span class="line">        <span class="type">int</span> nn = zero.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>, j = k<span class="number">-1</span>; j &lt; nn; i++, j++) &#123;</span><br><span class="line">            <span class="type">int</span> mid = (i+j)/<span class="number">2</span>;</span><br><span class="line">            cost -= left[mid] - left[i<span class="number">-1</span>];</span><br><span class="line">            cost += left[j+<span class="number">1</span>] - left[mid+k%<span class="number">2</span>];</span><br><span class="line">            minn = <span class="built_in">min</span>(minn, cost);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> minn;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://leetcode.cn/problems/minimum-adjacent-swaps-for-k-consecutive-ones/solutions/627364/duo-tu-xin-shou-jiao-cheng-yi-bu-bu-dai-6bps4/">参考题解</a>， 就是找到窗口滑动时，cost的O(1)的更新方法</p></blockquote><h2 id="1255-得分最高的单词集合"><a href="#1255-得分最高的单词集合" class="headerlink" title="1255. 得分最高的单词集合"></a><a href="https://leetcode.cn/problems/maximum-score-words-formed-by-letters/description/">1255. 得分最高的单词集合</a></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> wn;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxScoreWords</span><span class="params">(vector&lt;string&gt;&amp; words, vector&lt;<span class="type">char</span>&gt;&amp; letters, vector&lt;<span class="type">int</span>&gt;&amp; score)</span> </span>&#123;</span><br><span class="line">        wn = words.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> ln = letters.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; letterCount = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">26</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ln; i++) &#123;</span><br><span class="line">            letterCount[letters[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dfs</span>(<span class="number">0</span>, words, score, letterCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> index, vector&lt;string&gt;&amp; words, vector&lt;<span class="type">int</span>&gt;&amp; score, vector&lt;<span class="type">int</span>&gt; state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &gt;= wn) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> scoreNext = <span class="built_in">dfs</span>(index+<span class="number">1</span>, words, score, state);</span><br><span class="line">        <span class="type">int</span> wlen = words[index].<span class="built_in">length</span>();</span><br><span class="line">        <span class="type">int</span> scorei = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; wlen; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(state[words[index][i] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                state[words[index][i] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">                scorei += score[words[index][i] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> scoreNext;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(scoreNext, scorei + <span class="built_in">dfs</span>(index+<span class="number">1</span>, words, score, state));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>艺术，就是暴搜！！！<br>然后再记录一下当前状态下，26个字母当前剩余个数</p></blockquote><h3 id="状态压缩，但是负优化"><a href="#状态压缩，但是负优化" class="headerlink" title="状态压缩，但是负优化"></a>状态压缩，但是负优化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxScoreWords</span><span class="params">(vector&lt;string&gt;&amp; words, vector&lt;<span class="type">char</span>&gt;&amp; letters, vector&lt;<span class="type">int</span>&gt;&amp; score)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> wn = words.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> ln = letters.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; letterCount = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">26</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ln; i++) &#123;</span><br><span class="line">            letterCount[letters[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> s = <span class="number">1</span>; s &lt; (<span class="number">1</span> &lt;&lt; wn); s++) &#123;</span><br><span class="line">            vector&lt;<span class="type">int</span>&gt; wordCount = letterCount;</span><br><span class="line">            <span class="type">int</span> scoreState = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; wn; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(s &amp; (<span class="number">1</span> &lt;&lt; i)) &#123;</span><br><span class="line">                    <span class="type">int</span> wlen = words[i].<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; wlen; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">                            scoreState += score[words[i][j] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            s = ((s &gt;&gt; (wn -i)) + <span class="number">1</span>) &lt;&lt; (wn - i);</span><br><span class="line">                            <span class="keyword">goto</span> NextState;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res = <span class="built_in">max</span>(res, scoreState);</span><br><span class="line">            NextState:;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>s的每一位表示对应wordi是否选择，复制最初的状态，统计分数，如果遇到不可以的，直接到下一个状态</p></blockquote><h3 id="剪枝"><a href="#剪枝" class="headerlink" title="剪枝"></a>剪枝</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxScoreWords</span><span class="params">(vector&lt;string&gt;&amp; words, vector&lt;<span class="type">char</span>&gt;&amp; letters, vector&lt;<span class="type">int</span>&gt;&amp; score)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> wn = words.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> ln = letters.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; letterCount = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">26</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ln; i++) &#123;</span><br><span class="line">            letterCount[letters[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> s = <span class="number">1</span>; s &lt; (<span class="number">1</span> &lt;&lt; wn);) &#123;</span><br><span class="line">            vector&lt;<span class="type">int</span>&gt; wordCount = letterCount;</span><br><span class="line">            <span class="type">int</span> scoreState = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; wn; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(s &amp; (<span class="number">1</span> &lt;&lt; (wn - i - <span class="number">1</span>))) &#123;</span><br><span class="line">                    <span class="type">int</span> wlen = words[i].<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; wlen; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">                            scoreState += score[words[i][j] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            s = ((s &gt;&gt; (wn - i - <span class="number">1</span>)) + <span class="number">1</span>) &lt;&lt; (wn - i - <span class="number">1</span>);</span><br><span class="line">                            <span class="comment">// s += 1 &lt;&lt; (wn - i - 1);</span></span><br><span class="line">                            <span class="keyword">goto</span> NextState;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res = <span class="built_in">max</span>(res, scoreState);</span><br><span class="line">            s++;</span><br><span class="line">            NextState:;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>题解中的状态 $ s $的第 $ i $ 位(从 $ 0 $ 开始，从左往右)对应的是 $ words $ 数组中第 $ n-1-i $ 个字符串，我这里改成对应第 $ i $ 个字符串</p></blockquote><blockquote><p>对于状态 $ s $，当发现第 $ k $ 位的字符个数条件满足不了以后，第 $ k+1 $ 位至第 $ n-1 $ 位的情况都不需要考虑了，则状态直接跳转到 $ ((s &gt;&gt; (n - k - 1))  + 1) &lt;&lt; (n - k - 1) $ ,由于当前状态第 $ k $ 位后全为 $ 0 $ ，也就是当前状态s再加上 $ 1 &lt;&lt; (n - k - 1) $</p></blockquote><blockquote><p>或者状态 $ s $ 从 $ -1 $ 到 $ -(1 &lt;&lt; wn) $ </p></blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">maxScoreWords</span><span class="params">(vector&lt;string&gt;&amp; words, vector&lt;<span class="type">char</span>&gt;&amp; letters, vector&lt;<span class="type">int</span>&gt;&amp; score)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> wn = words.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> ln = letters.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; letterCount = <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(<span class="number">26</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; ln; i++) &#123;</span><br><span class="line">            letterCount[letters[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> s = <span class="number">-1</span>; s &gt; -(<span class="number">1</span> &lt;&lt; wn);) &#123;</span><br><span class="line">            vector&lt;<span class="type">int</span>&gt; wordCount = letterCount;</span><br><span class="line">            <span class="type">int</span> scoreState = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; wn; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(s &amp; (<span class="number">1</span> &lt;&lt; (wn - i - <span class="number">1</span>))) &#123;</span><br><span class="line">                    <span class="type">int</span> wlen = words[i].<span class="built_in">length</span>();</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; wlen; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            wordCount[words[i][j] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">                            scoreState += score[words[i][j] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            s -= (<span class="number">1</span> &lt;&lt; (wn - i - <span class="number">1</span>));</span><br><span class="line">                            <span class="keyword">goto</span> NextState;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res = <span class="built_in">max</span>(res, scoreState);</span><br><span class="line">            s--;</span><br><span class="line">            NextState:;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;2347-最好的扑克手牌&quot;&gt;&lt;a href=&quot;#2347-最好的扑克手牌&quot; class=&quot;headerlink&quot; title=&quot;2347. 最好的扑克手牌&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode.cn/problems/best-poker-hand/&quot;&gt;2347. 最好的扑克手牌&lt;/a&gt;&lt;/h2&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;string &lt;span class=&quot;title&quot;&gt;bestHand&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(vector&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;amp; ranks, vector&amp;lt;&lt;span class=&quot;type&quot;&gt;char&lt;/span&gt;&amp;gt;&amp;amp; suits)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;vector&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt; &lt;span class=&quot;title&quot;&gt;rank_count&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;, &lt;span class=&quot;title&quot;&gt;suits_count&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            rank_count[ranks[i]&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;]++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            suits_count[suits[i] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;a&amp;#x27;&lt;/span&gt;]++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            count = &lt;span class=&quot;built_in&quot;&gt;max&lt;/span&gt;(count, suits_count[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(count == &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;Flush&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;13&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            count = &lt;span class=&quot;built_in&quot;&gt;max&lt;/span&gt;(count, rank_count[i]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(count &amp;gt;= &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;Three of a Kind&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (count == &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;Pair&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;High Card&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;1604-警告一小时内使用相同员工卡大于等于三次的人&quot;&gt;&lt;a href=&quot;#1604-警告一小时内使用相同员工卡大于等于三次的人&quot; class=&quot;headerlink&quot; title=&quot;1604. 警告一小时内使用相同员工卡大于等于三次的人&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode.cn/problems/alert-using-same-key-card-three-or-more-times-in-a-one-hour-period/&quot;&gt;1604. 警告一小时内使用相同员工卡大于等于三次的人&lt;/a&gt;&lt;/h2&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;vector&amp;lt;string&amp;gt; &lt;span class=&quot;title&quot;&gt;alertNames&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(vector&amp;lt;string&amp;gt;&amp;amp; keyName, vector&amp;lt;string&amp;gt;&amp;amp; keyTime)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        map&amp;lt;string, vector&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt; hour_count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = keyName.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; len; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; h = (keyTime[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]-&lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;)*&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; + keyTime[i][&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;, m = (keyTime[i][&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;) * &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; + keyTime[i][&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            hour_count[keyName[i]].&lt;span class=&quot;built_in&quot;&gt;push_back&lt;/span&gt;(h*&lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;+m);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        vector&amp;lt;string&amp;gt; warning_list;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;auto&lt;/span&gt; ite = hour_count.&lt;span class=&quot;built_in&quot;&gt;begin&lt;/span&gt;(); ite != hour_count.&lt;span class=&quot;built_in&quot;&gt;end&lt;/span&gt;(); ite++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; warn = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;sort&lt;/span&gt;(ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;begin&lt;/span&gt;(), ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;end&lt;/span&gt;());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; len&lt;span class=&quot;number&quot;&gt;-2&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(ite-&amp;gt;second[i+&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;] - ite-&amp;gt;second[i] &amp;lt;= &lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    warn = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(warn) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                warning_list.&lt;span class=&quot;built_in&quot;&gt;push_back&lt;/span&gt;(ite-&amp;gt;first);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; warning_list;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title class_&quot;&gt;Solution&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;vector&amp;lt;string&amp;gt; &lt;span class=&quot;title&quot;&gt;alertNames&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(vector&amp;lt;string&amp;gt;&amp;amp; keyName, vector&amp;lt;string&amp;gt;&amp;amp; keyTime)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        map&amp;lt;string, priority_queue&amp;lt;&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt; hour_count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = keyName.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; len; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; h = (keyTime[i][&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]-&lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;)*&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; + keyTime[i][&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;, m = (keyTime[i][&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;) * &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; + keyTime[i][&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;] - &lt;span class=&quot;string&quot;&gt;&amp;#x27;0&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            hour_count[keyName[i]].&lt;span class=&quot;built_in&quot;&gt;push&lt;/span&gt;(h*&lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;+m);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        vector&amp;lt;string&amp;gt; warning_list;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;auto&lt;/span&gt; ite = hour_count.&lt;span class=&quot;built_in&quot;&gt;begin&lt;/span&gt;(); ite != hour_count.&lt;span class=&quot;built_in&quot;&gt;end&lt;/span&gt;(); ite++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; len = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;size&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(len &amp;lt;= &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;int&lt;/span&gt; a, b, c;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            a = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;top&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;pop&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            b = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;top&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;pop&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            c = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;top&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;pop&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;type&quot;&gt;bool&lt;/span&gt; warn = a - c &amp;lt;= &lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;(!warn &amp;amp;&amp;amp; !ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;empty&lt;/span&gt;()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                a = b;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                b = c;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                c = ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;top&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                ite-&amp;gt;second.&lt;span class=&quot;built_in&quot;&gt;pop&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                warn = a - c &amp;lt;= &lt;span class=&quot;number&quot;&gt;60&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(warn) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                warning_list.&lt;span class=&quot;built_in&quot;&gt;push_back&lt;/span&gt;(ite-&amp;gt;first);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; warning_list;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;2331-计算布尔二叉树的值&quot;&gt;&lt;a href=&quot;#2331-计算布尔二叉树的值&quot; class=&quot;headerlink&quot; title=&quot;2331. 计算布尔二叉树的值&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://leetcode.cn/problems/evaluate-boolean-binary-tree/&quot;&gt;2331. 计算布尔二叉树的值&lt;/a&gt;&lt;/h2&gt;</summary>
    
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/categories/LeetCode/"/>
    
    
    <category term="LeetCode" scheme="https://jingtianer.github.io/home/tags/LeetCode/"/>
    
  </entry>
  
</feed>
